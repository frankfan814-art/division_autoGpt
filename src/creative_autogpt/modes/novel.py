"""
Novel Mode - Writing mode for novels and long-form fiction

Implements the standard novel creation pipeline with:
- Style definition
- Theme confirmation
- Outline generation
- Character design
- World-building
- Chapter generation
- Quality evaluation
"""

from typing import Any, Dict, Optional


from creative_autogpt.modes.base import Mode, WritingMode, register_mode
from creative_autogpt.core.task_planner import NovelTaskType
from creative_autogpt.core.vector_memory import MemoryContext


@register_mode
class NovelMode(Mode):
    """
    Writing mode for novels

    Supports:
    - Various genres (xuanhuan, wuxia, urban, scifi, etc.)
    - Long-form structure (up to millions of characters)
    - Complex character relationships
    - Multi-arc storylines
    """

    mode_type = WritingMode.NOVEL
    name = "Novel Mode"
    description = "Writing mode for novels and long-form fiction"

    # Genre-specific configurations
    GENRE_CONFIGS = {
        "ç„å¹»": {
            "style": "å®å¤§ä¸–ç•Œè§‚ï¼Œä¿®ç‚¼å‡çº§ä½“ç³»",
            "themes": ["æˆé•¿", "å¤ä»‡", "å®ˆæŠ¤", "æ¢ç´¢"],
            "elements": ["çµåŠ›", "åŠŸæ³•", "æ³•å®", "å®—é—¨", "ç§˜å¢ƒ"],
        },
        "æ­¦ä¾ ": {
            "style": "æ±Ÿæ¹–æ©æ€¨ï¼Œä¾ ä¹‰ç²¾ç¥",
            "themes": ["ä¹‰æ°”", "æƒ…ä»‡", "é—¨æ´¾", "ä¼ æ‰¿"],
            "elements": ["æ­¦åŠŸ", "å†…åŠ›", "å…µå™¨", "ç§˜ç±", "é—¨æ´¾"],
        },
        "éƒ½å¸‚": {
            "style": "ç°ä»£éƒ½å¸‚èƒŒæ™¯ï¼Œè´´è¿‘ç°å®",
            "themes": ["å¥‹æ–—", "æƒ…æ„Ÿ", "å•†æˆ˜", "æ‚¬ç–‘"],
            "elements": ["èŒåœº", "å®¶åº­", "å‹æƒ…", "çˆ±æƒ…"],
        },
        "ç§‘å¹»": {
            "style": "æœªæ¥ç§‘æŠ€ï¼Œå®‡å®™æ¢ç´¢ï¼Œå¸¦æœ‰é»‘è‰²å¹½é»˜å’Œå¿ƒç†æ·±åº¦",
            "themes": ["ç§‘æŠ€", "äººæ€§", "æ–‡æ˜", "æ¢ç´¢"],
            "elements": ["AI", "å¤ªç©º", "åŸºå› ", "èƒ½æº"],
            "writing_guidance": {
                "tone": "åœ¨ç¡¬æ ¸ç§‘å¹»è®¾å®šä¸­èå…¥é»‘è‰²å¹½é»˜ï¼Œé€šè¿‡è®½åˆºå’Œåè®½æ­ç¤ºç¤¾ä¼šç°è±¡",
                "psychology": "æ·±å…¥æ¢ç´¢ç§‘æŠ€å¯¹äººæ€§çš„å½±å“ï¼Œå¢åŠ å¿ƒç†æç”»çš„å±‚æ¬¡æ„Ÿ",
                "narrative": "å¯ä½¿ç”¨å¤šé‡è§†è§’ï¼ˆå¦‚AIæ—¥å¿—ã€å…¬å¸å†…éƒ¨æ–‡æ¡£ï¼‰å¢å¼ºæ•…äº‹å±‚æ¬¡",
                "dialogue": "å¯¹è¯åº”ä½“ç°ç†æ€§ä¸æƒ…æ„Ÿçš„å†²çªï¼Œé¿å…è¿‡äºç›´ç™½çš„è¡¨è¾¾"
            }
        },
        "æ‚¬ç–‘": {
            "style": "å±‚å±‚æ‚¬å¿µï¼Œé€»è¾‘æ¨ç†",
            "themes": ["è§£è°œ", "çœŸç›¸", "äººæ€§", "çŠ¯ç½ª"],
            "elements": ["çº¿ç´¢", "æ¨ç†", "åè½¬", "ä¼ç¬”"],
        },
    }

    # ä½œè€…é£æ ¼é…ç½®
    AUTHOR_STYLES = {
        "liucixin": {
            "name": "åˆ˜æ…ˆæ¬£",
            "style_desc": "ç¡¬ç§‘å¹»é£æ ¼ï¼Œå®å¤§çš„å®‡å®™è§‚ï¼Œå†·å³»ç†æ€§çš„ç¬”è§¦",
            "writing_features": [
                "ç”¨æœ€æœ´ç´ çš„è¯­è¨€æè¿°æœ€å®å¤§çš„æ¦‚å¿µ",
                "å¤§é‡ä½¿ç”¨ç§‘å­¦åŸç†ä½œä¸ºæƒ…èŠ‚æ¨åŠ¨åŠ›",
                "å–„ç”¨æ¯”å–»ï¼Œå°†æŠ½è±¡æ¦‚å¿µå…·è±¡åŒ–",
                "å¯¹è¯ç®€ç»ƒï¼Œä¿¡æ¯å¯†åº¦é«˜",
                "ä¸ç…½æƒ…ï¼Œä¸åˆ»æ„æ¸²æŸ“æ°”æ°›",
                "æ³¨é‡é€»è¾‘æ¨æ¼”çš„ä¸¥å¯†æ€§"
            ],
            "example": "å°±åƒã€Šä¸‰ä½“ã€‹ä¸­ç”¨'é»‘æš—æ£®æ—'æ¯”å–»å®‡å®™æ–‡æ˜å…³ç³»ï¼Œç”¨'é™ç»´æ‰“å‡»'æè¿°æ¯ç­æ–¹å¼",
        },
        "jiangnan": {
            "name": "æ±Ÿå—",
            "style_desc": "çƒ­è¡€é’æ˜¥é£ï¼Œç»†è…»çš„æƒ…æ„Ÿæå†™ï¼Œåä¸½çš„ä¿®è¾",
            "writing_features": [
                "å¤§é‡çš„æ¯”å–»å’Œæ’æ¯”",
                "æƒ…æ„Ÿæå†™ç»†è…»ï¼Œæ“…é•¿å†™å­¤ç‹¬ã€çƒ­è¡€ã€ç¾ç»Š",
                "å¯¹è¯å¸¦æœ‰ä¸€å®šæ–‡è‰ºè…”",
                "å–„ç”¨ç•™ç™½å’Œæ„å¢ƒ",
                "èŠ‚å¥å…ˆç¼“åæ€¥ï¼Œé«˜æ½®éƒ¨åˆ†ç‡ƒ"
            ],
            "example": "å°±åƒã€Šé¾™æ—ã€‹ä¸­è·¯æ˜éçš„å­¤ç‹¬æ„Ÿï¼Œæ¥šå­èˆªçš„çƒ­è¡€ï¼Œéƒ½æ˜¯é€šè¿‡ç»†èŠ‚å †å‡ºæ¥çš„",
        },
        "fenghuo": {
            "name": "æˆ‘åƒè¥¿çº¢æŸ¿",
            "style_desc": "å‡çº§æµçˆ½æ–‡ï¼ŒèŠ‚å¥å¿«ï¼Œå‡çº§ä½“ç³»æ¸…æ™°",
            "writing_features": [
                "ä¸»è§’æ€§æ ¼åšæ¯…ï¼Œç›®æ ‡æ˜ç¡®",
                "å‡çº§ä½“ç³»é‡åŒ–ï¼Œç­‰çº§æ¸…æ™°",
                "æˆ˜æ–—åœºé¢æå†™ç®€æ´æœ‰åŠ›",
                "ä¸æ‹–æ³¥å¸¦æ°´ï¼Œè¯¥è¿‡å°±è¿‡",
                "å–„ç”¨ä¼ç¬”ï¼Œå‰åå‘¼åº”"
            ],
            "example": "å°±åƒã€Šç›˜é¾™ã€‹ä¸­ï¼Œä»åˆçº§æˆ˜å£«åˆ°åœ£åŸŸï¼Œæ¯ä¸€æ­¥éƒ½å¾ˆæ¸…æ¥š",
        },
        "tangjia": {
            "name": "å”å®¶ä¸‰å°‘",
            "style_desc": "çƒ­è¡€å†’é™©ï¼Œé‡è§†å‹æƒ…å’Œå›¢é˜Ÿ",
            "writing_features": [
                "ä¸»è§’å›¢é˜Ÿé…åˆé»˜å¥‘",
                "å¼ºè°ƒå‹æƒ…ã€ä¿¡ä»»ã€å®ˆæŠ¤",
                "æŠ€èƒ½æå†™åä¸½",
                "å¯¹è¯å£è¯­åŒ–ï¼Œè´´è¿‘å¹´è½»äºº",
                "èŠ‚å¥æ˜å¿«ï¼Œçˆ½ç‚¹å¤š"
            ],
            "example": "å°±åƒã€Šæ–—ç½—å¤§é™†ã€‹ä¸­å²è±å…‹ä¸ƒæ€ªçš„é…åˆï¼Œæ¯ä¸ªäººéƒ½æœ‰ç‹¬ç‰¹ä½œç”¨",
        },
        "chenan": {
            "name": "é™ˆå®‰",
            "style_desc": "æ‚¬ç–‘æ¨ç†ï¼Œé€»è¾‘ä¸¥å¯†",
            "writing_features": [
                "æ³¨é‡çº¿ç´¢åŸ‹è®¾",
                "æ¨ç†è¿‡ç¨‹ä¸¥å¯†",
                "ç»†èŠ‚æå†™ç²¾ç»†",
                "å¯¹è¯ç®€æ´æœ‰åŠ›",
                "èŠ‚å¥å¼ å¼›æœ‰åº¦"
            ],
            "example": "æ¨ç†å°è¯´çš„ç²¾é«“åœ¨äºçº¿ç´¢çš„åˆç†åˆ†å¸ƒå’Œé€»è¾‘çš„ä¸¥å¯†æ€§",
        },
        "caocao": {
            "name": "çŒ«è…»",
            "style_desc": "æƒè°‹æ”¿æ²»ï¼Œæ–‡ç¬”ç»†è…»",
            "writing_features": [
                "æ”¿æ²»æ–—äº‰æå†™ç»†è…»",
                "äººç‰©å…³ç³»å¤æ‚",
                "æ–‡ç¬”åä¸½ä½†ä¸æµ®å¤¸",
                "å–„ç”¨åè®½å’Œé»‘è‰²å¹½é»˜",
                "èŠ‚å¥è¾ƒæ…¢ï¼Œä½†ç»†èŠ‚ä¸°å¯Œ"
            ],
            "example": "å°±åƒã€Šåº†ä½™å¹´ã€‹ä¸­ï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰è‡ªå·±çš„ç®—è®¡å’Œç«‹åœº",
        },
        "wuxing": {
            "name": "è€³æ ¹",
            "style_desc": "ä»™ä¾ ç„å¹»ï¼Œä¸–ç•Œè§‚å®å¤§",
            "writing_features": [
                "ä¸–ç•Œè§‚æå…¶å®å¤§",
                "ä¿®ç‚¼ä½“ç³»å¤æ‚å®Œæ•´",
                "ä¸»è§’æ€§æ ¼åšæ¯…ç‹ è¾£",
                "æˆ˜æ–—åœºé¢éœ‡æ’¼",
                "åŠ¨è¾„æ¶‰åŠå› æœè½®å›"
            ],
            "example": "å°±åƒã€Šä»™é€†ã€‹ä¸­ï¼Œä¸»è§’ä»ä¸€ä¸ªå‡¡äººä¸€æ­¥æ­¥èµ°åˆ°å·…å³°",
        },
        "zhuji": {
            "name": "è¾°ä¸œ",
            "style_desc": "çƒ­è¡€æˆ˜æ–—ï¼Œæƒ…èŠ‚ç´§å‡‘",
            "writing_features": [
                "æˆ˜æ–—åœºé¢çƒ­è¡€",
                "èŠ‚å¥ç´§å‡‘ï¼Œä¸æ‹–æ²“",
                "å–„ç”¨æ‚¬å¿µ",
                "ä¸»è§’æ€§æ ¼çƒ­è¡€éœ¸æ°”",
                "æƒ…èŠ‚åè½¬å¤š"
            ],
            "example": "å°±åƒã€Šå®Œç¾ä¸–ç•Œã€‹ä¸­ï¼Œæˆ˜æ–—åœºé¢ä¸€ä¸ªæ¥ä¸€ä¸ªï¼Œçƒ­è¡€æ²¸è…¾",
        },
    }

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        super().__init__(config)
        self.genre = config.get("genre", "ç„å¹»") if config else "ç„å¹»"
        self.genre_config = self.GENRE_CONFIGS.get(self.genre, {})

    def _get_genre_guidance(self, context: MemoryContext, metadata: Optional[Dict[str, Any]] = None) -> str:
        """Get genre-specific writing guidance for prompts"""
        # ä¼˜å…ˆä»å…ƒæ•°æ®è·å–ç±»å‹ï¼Œæ›´å¯é 
        genre = (metadata.get("goal_style") if metadata else None) or self.genre
        genre_config = self.GENRE_CONFIGS.get(genre, {})
        guidance = genre_config.get("writing_guidance", {})

        if not guidance:
            return ""

        guidance_text = "\n### é£æ ¼ç‰¹å®šå†™ä½œæŒ‡å¯¼\n"
        if guidance.get("tone"):
            guidance_text += f"**åŸºè°ƒ**: {guidance['tone']}\n"
        if guidance.get("psychology"):
            guidance_text += f"**å¿ƒç†æå†™**: {guidance['psychology']}\n"
        if guidance.get("narrative"):
            guidance_text += f"**å™äº‹æŠ€å·§**: {guidance['narrative']}\n"
        if guidance.get("dialogue"):
            guidance_text += f"**å¯¹è¯é£æ ¼**: {guidance['dialogue']}\n"

        return guidance_text

    def _get_author_style_guidance(self, metadata: Optional[Dict[str, Any]] = None) -> str:
        """Get author style guidance for prompts"""
        author_style = (metadata.get("goal_author_style") if metadata else None) or ""
        if not author_style or author_style not in self.AUTHOR_STYLES:
            return ""

        style_config = self.AUTHOR_STYLES[author_style]

        guidance_text = f"\n### ğŸ“ å‚è€ƒä½œè€…é£æ ¼ï¼š{style_config['name']}\n"
        guidance_text += f"**é£æ ¼ç‰¹ç‚¹**: {style_config['style_desc']}\n\n"
        guidance_text += "**å†™ä½œç‰¹å¾**:\n"
        for feature in style_config['writing_features']:
            guidance_text += f"- {feature}\n"
        guidance_text += f"\n**å‚è€ƒ**: {style_config['example']}\n"
        guidance_text += "\nè¯·æ¨¡ä»¿è¿™ä½ä½œè€…çš„å†™ä½œé£æ ¼ï¼Œä½†ä¸è¦ç…§æ¬å…·ä½“æƒ…èŠ‚å’Œäººç‰©ã€‚\n"

        return guidance_text

    async def _get_examples_text(self, context: MemoryContext, metadata: Optional[Dict[str, Any]] = None) -> str:
        """Get examples text for prompt"""
        try:
            from creative_autogpt.utils.example_retriever import get_retriever

            retriever = await get_retriever()
            if not retriever:
                return ""

            style = (metadata.get("goal_style") if metadata else None) or self.genre
            author_style = (metadata.get("goal_author_style") if metadata else None) or ""

            return await retriever.get_examples_for_prompt(
                style=style,
                author_style=author_style if author_style else None,
                max_examples=3,
            )

        except Exception as e:
            # èŒƒä¾‹è·å–å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
            return ""

    async def build_prompt(
        self,
        task_type: str,
        context: MemoryContext,
        metadata: Optional[Dict[str, Any]] = None,
    ) -> str:
        """Build prompt for a novel task type"""
        metadata = metadata or {}

        # Get task-specific prompt (æ··åˆæ–¹æ¡ˆ)
        if task_type == NovelTaskType.CREATIVE_BRAINSTORM.value:
            return self._build_brainstorm_prompt(context, metadata)

        elif task_type == NovelTaskType.OUTLINE.value:
            return self._build_outline_prompt(context, metadata)

        elif task_type == NovelTaskType.CHARACTER_DESIGN.value:
            return self._build_character_prompt(context, metadata)

        elif task_type == NovelTaskType.WORLDVIEW_RULES.value:
            return self._build_worldview_prompt(context, metadata)

        elif task_type == NovelTaskType.CHAPTER_CONTENT.value:
            return await self._build_chapter_content_prompt(context, metadata)

        # elif task_type == NovelTaskType.BATCH_CHAPTER_GENERATION.value:  # âš ï¸ å·²ç¦ç”¨æ‰¹é‡ç”Ÿæˆ
        #     return self._build_batch_chapter_generation_prompt(context, metadata)

        # elif task_type == NovelTaskType.CHAPTER_POLISH.value:  # âš ï¸ å·²ç§»é™¤ï¼šä½¿ç”¨ Qwen Long ç›´æ¥ç”Ÿæˆé«˜è´¨é‡å†…å®¹
        #     return self._build_chapter_polish_prompt(context, metadata)

        elif task_type == NovelTaskType.EVALUATION.value:
            return self._build_evaluation_prompt(context, metadata)

        elif task_type == NovelTaskType.REVISION.value:
            return self._build_revision_prompt(context, metadata)

        else:
            return self._build_generic_prompt(task_type, context, metadata)

    def _build_style_prompt(self, metadata: Dict[str, Any]) -> str:
        """Build prompt for style elements definition"""
        genre = metadata.get("goal_style") or metadata.get("genre", self.genre)
        genre_config = self.GENRE_CONFIGS.get(genre, {})

        prompt = f"""## ä»»åŠ¡: å®šä¹‰å°è¯´é£æ ¼å…ƒç´ 

è¯·ä¸ºä¸€éƒ¨{genre}å°è¯´å®šä¹‰è¯¦ç»†çš„é£æ ¼å…ƒç´ ã€‚

### ç±»å‹ç‰¹å¾
"""

        if genre_config.get("style"):
            prompt += f"é£æ ¼ç‰¹ç‚¹: {genre_config['style']}\n"

        if genre_config.get("themes"):
            prompt += f"å¸¸è§ä¸»é¢˜: {', '.join(genre_config['themes'])}\n"

        if genre_config.get("elements"):
            prompt += f"æ ¸å¿ƒå…ƒç´ : {', '.join(genre_config['elements'])}\n"

        # æ·»åŠ ç±»å‹ç‰¹å®šçš„å†™ä½œæŒ‡å¯¼
        if genre_config.get("writing_guidance"):
            prompt += "\n### å†™ä½œæŒ‡å¯¼\n"
            guidance = genre_config["writing_guidance"]
            if guidance.get("tone"):
                prompt += f"**åŸºè°ƒ**: {guidance['tone']}\n"
            if guidance.get("psychology"):
                prompt += f"**å¿ƒç†æå†™**: {guidance['psychology']}\n"
            if guidance.get("narrative"):
                prompt += f"**å™äº‹æŠ€å·§**: {guidance['narrative']}\n"
            if guidance.get("dialogue"):
                prompt += f"**å¯¹è¯é£æ ¼**: {guidance['dialogue']}\n"

        prompt += """
### è¾“å‡ºè¦æ±‚

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºé£æ ¼å…ƒç´ é…ç½®:

```json
{
  "narrative_style": "å™è¿°é£æ ¼æè¿°",
  "language_style": "è¯­è¨€é£æ ¼æè¿°",
  "pacing": "èŠ‚å¥æ§åˆ¶",
  "tone": "åŸºè°ƒæ°›å›´",
  "key_elements": ["å…ƒç´ 1", "å…ƒç´ 2", ...],
  "avoid_elements": ["é¿å…çš„å…ƒç´ 1", "é¿å…çš„å…ƒç´ 2", ...],
  "target_audience": "ç›®æ ‡è¯»è€…",
  "similar_works": ["ç±»ä¼¼ä½œå“1", "ç±»ä¼¼ä½œå“2", ...]
}
```

è¯·ç›´æ¥è¾“å‡ºJSONï¼Œä¸éœ€è¦å…¶ä»–å†…å®¹ã€‚
"""
        return prompt

    def _build_outline_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for enhanced story outline (åŒ…å«äº‹ä»¶ã€ä¼ç¬”ã€ç« èŠ‚è§„åˆ’)"""
        goal_length = metadata.get("goal_length", "30ä¸‡å­—")
        chapter_count = metadata.get("chapter_count", 10)

        prompt = f"""## ğŸ¯ ä»»åŠ¡: åˆ›å»ºå®Œæ•´çš„å°è¯´å¤§çº²ï¼ˆåŠ å¼ºç‰ˆï¼‰

### âš ï¸ è¿™æ˜¯æ•´ä¸ªåˆ›ä½œçš„è“å›¾ï¼æ‰€æœ‰ç»†èŠ‚éƒ½åœ¨è¿™é‡Œè®¾è®¡å¥½ï¼

**ç›®æ ‡è§„æ¨¡**: {goal_length}
**é¢„è®¡ç« èŠ‚æ•°**: {chapter_count} ç« 

### ğŸ“‹ å‰ç½®ä¿¡æ¯
"""

        # Add relevant context - åªæ·»åŠ åˆ›æ„è„‘æš´ï¼ˆå‰ç½®ä»»åŠ¡ï¼‰
        for result in context.recent_results:
            if result.get("task_type") == "åˆ›æ„è„‘æš´":
                prompt += f"\n#### {result['task_type']}\n{result['content'][:800]}...\n"
                break

        prompt += f"""

### ğŸ”¥ æ ¸å¿ƒè¦æ±‚ï¼šè¿™æ˜¯å”¯ä¸€çš„æœºä¼šè®¾è®¡å®Œæ•´æ•…äº‹ï¼

**ä¸ºä»€ä¹ˆå¤§çº²å¦‚æ­¤é‡è¦ï¼Ÿ**
1. è¿™æ˜¯æ‰€æœ‰ç« èŠ‚åˆ›ä½œçš„å”¯ä¸€è“å›¾
2. æ‰€æœ‰ä¼ç¬”å¿…é¡»åœ¨è¿™é‡Œè®¾è®¡å¥½
3. äººç‰©å…³ç³»å¿…é¡»åœ¨è¿™é‡Œç†æ¸…
4. æ¯ç« çš„å†…å®¹å¿…é¡»åœ¨è¿™é‡Œè§„åˆ’

**å¦‚æœå¤§çº²è®¾è®¡æœ‰é—®é¢˜ï¼Œåé¢ç”Ÿæˆçš„æ‰€æœ‰ç« èŠ‚éƒ½ä¼šæœ‰é—®é¢˜ï¼**

---

### ğŸš¨ æ‹’ç»ä¿—å¥—è¦æ±‚

**ç»å¯¹ä¸è¦å†™**ï¼š
- âŒ åºŸæŸ´é€†è¢­æµ
- âŒ é€€å©šæ‰“è„¸æµ
- âŒ ç§˜å¢ƒæ¡å®æµ
- âŒ å®—é—¨å¤§æ¯”æµ
- âŒ ä¸»è§’æœ€ç»ˆæˆç¥/é£å‡çš„ä¿—å¥—ç»“å±€

**å¿…é¡»åˆ›æ–°**ï¼š
- âœ… å¤æ‚çš„é“å¾·å›°å¢ƒï¼ˆä¸æ˜¯ç®€å•çš„æ­£é‚ªå¯¹ç«‹ï¼‰
- âœ… æ„å¤–çš„è½¬æŠ˜ï¼ˆè¯»è€…çŒœä¸åˆ°çš„èµ°å‘ï¼‰
- âœ… çœŸå®çš„äººç‰©åŠ¨æœºï¼ˆæ¯ä¸ªè§’è‰²éƒ½æœ‰åˆç†çš„è¡Œä¸ºé€»è¾‘ï¼‰
- âœ… ç‹¬ç‰¹çš„ç»“å±€ï¼ˆä¸è¦å¤§å›¢åœ†ï¼Œä¹Ÿä¸è¦æ•…æ„æ‚²å‰§ï¼‰

---

### ğŸ“ å¤§çº²å¿…é¡»åŒ…å«çš„å†…å®¹

#### 1. æ•…äº‹ç»“æ„
```
ã€å¼€ç«¯ã€‘ä¸»è§’ç™»åœº + åˆå§‹çŠ¶æ€ + æ¿€åŠ±äº‹ä»¶
    â†“
ã€å‘å±•ã€‘å†²çªå‡çº§ + äººç‰©æˆé•¿ + ç§˜å¯†æ­å¼€
    â†“
ã€é«˜æ½®ã€‘æœ€å¤§å†²çª + ç»å¢ƒæ—¶åˆ» + æœ€ç»ˆæŠ‰æ‹©
    â†“
ã€ç»“å±€ã€‘ç»“å±€èµ°å‘ + ä¸»é¢˜å‡å + ç•™ç™½å›å‘³
```

#### 2. å®Œæ•´äº‹ä»¶é“¾ï¼ˆæ—¶é—´çº¿ï¼‰
è®¾è®¡ 20-50 ä¸ªå…³é”®äº‹ä»¶ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼š

```
äº‹ä»¶1: [ç« èŠ‚1] ä¸»è§’é­é‡æ¿€åŠ±äº‹ä»¶...
äº‹ä»¶2: [ç« èŠ‚2] ä¸»è§’å¼€å§‹è¡ŒåŠ¨...
äº‹ä»¶3: [ç« èŠ‚3] ç¬¬ä¸€æ¬¡å†²çª...
...
äº‹ä»¶N: [ç« èŠ‚M] æœ€ç»ˆå†³æˆ˜...
```

**æ¯ä¸ªäº‹ä»¶åŒ…å«**ï¼š
- è§¦å‘æ¡ä»¶
- ä¸»è¦å†…å®¹
- ç»“æœå½±å“
- ä¼ç¬”å…³è”ï¼ˆå¦‚æœæœ‰ï¼‰

#### 3. ä¼ç¬”ç³»ç»Ÿï¼ˆâš ï¸ é‡ç‚¹ï¼ï¼‰

**ä¸»çº¿ä¼ç¬”**ï¼ˆ5-10ä¸ªï¼Œè´¯ç©¿å…¨ä¹¦ï¼‰ï¼š
| ä¼ç¬”åç§° | åŸ‹è®¾ç« èŠ‚ | æš—ç¤ºå†…å®¹ | å›æ”¶ç« èŠ‚ | æ­ç¤ºæ–¹å¼ | å½±å“ |
|---------|---------|---------|---------|---------|------|
| ä¼ç¬”1   | ç¬¬Xç«    | ...     | ç¬¬Yç«    | ...     | ...  |
| ...     | ...     | ...     | ...     | ...     | ...  |

**æ”¯çº¿ä¼ç¬”**ï¼ˆ3-5ä¸ªï¼‰ï¼š
| ä¼ç¬”åç§° | åŸ‹è®¾ç« èŠ‚ | æš—ç¤ºå†…å®¹ | å›æ”¶ç« èŠ‚ | å½±å“ |
|---------|---------|---------|---------|------|
| ...     | ...     | ...     | ...     | ...  |

**ç»†èŠ‚ä¼ç¬”**ï¼ˆå¯ä»¥åŸ‹è®¾çš„ç±»å‹ï¼‰ï¼š
- äººç‰©èº«ä»½çš„ç§˜å¯†
- é“å…·çš„ç‰¹æ®ŠåŠŸèƒ½
- è¡¨é¢çš„å–„æ„å®é™…æ˜¯é˜´è°‹
- æ—©æœŸçš„å¯¹è¯æœ‰åŒå…³å«ä¹‰

#### 4. ç« èŠ‚è§„åˆ’ï¼ˆæ¯ç« 3000-5000å­—ï¼‰

```
ç¬¬1ç« : ã€æ ‡é¢˜ã€‘æ ¸å¿ƒå†…å®¹ï¼ˆ200å­—ä»¥å†…ï¼‰
ç¬¬2ç« : ã€æ ‡é¢˜ã€‘æ ¸å¿ƒå†…å®¹
...
ç¬¬{chapter_count}ç« : ã€æ ‡é¢˜ã€‘æ ¸å¿ƒå†…å®¹
```

**æ¯ç« åŒ…å«**ï¼š
- æ ¸å¿ƒäº‹ä»¶ï¼ˆå‘ç”Ÿäº†ä»€ä¹ˆï¼‰
- äººç‰©å‡ºåœºï¼ˆè°å‡ºç°ï¼Œä¸ºä»€ä¹ˆï¼‰
- ä¼ç¬”åŸ‹è®¾/å›æ”¶ï¼ˆå¦‚æœæœ‰ï¼‰
- æƒ…æ„ŸèŠ‚å¥ï¼ˆç´§å¼ /ç¼“å’Œï¼‰
- å­—æ•°ç›®æ ‡

#### 5. äººç‰©å…³ç³»ç½‘ç»œ

```
ä¸»è§’ â”â”â”â”â” [å…³ç³»1] â”â”â”â”â” é…è§’A
  â”œâ”€â”€ [å…³ç³»2] â”â”â”â”â” åæ´¾
  â”œâ”€â”€ [å…³ç³»3] â”â”â”â”â” å¯¼å¸ˆ
  â””â”€â”€ [å…³ç³»4] â”â”â”â”â” æ‹çˆ±å¯¹è±¡

é…è§’A â”â”â”â”â” [å…³ç³»5] â”â”â”â”â” åæ´¾
  â””â”€â”€ [å…³ç³»6] â”â”â”â”â” é…è§’B
```

**æ ‡æ³¨**ï¼š
- æ¯æ®µå…³ç³»çš„æ€§è´¨ï¼ˆç›Ÿå‹/æ•Œäºº/æš§æ˜§/åˆ©ç”¨ï¼‰
- å…³ç³»çš„å˜åŒ–ï¼ˆç¬¬å‡ ç« å…³ç³»ä¼šæ”¹å˜ï¼‰
- éšè—çš„å…³ç³»ï¼ˆè¡¨é¢Aï¼Œå®é™…Bï¼‰

#### 6. ä¸–ç•Œè§‚è¦ç‚¹ï¼ˆå½±å“æ•…äº‹çš„å…³é”®è®¾å®šï¼‰

åˆ—å‡ºå½±å“å‰§æƒ…çš„æ ¸å¿ƒè®¾å®šï¼š
```
è®¾å®š1: [æè¿°] â†’ å¦‚ä½•å½±å“å‰§æƒ…
è®¾å®š2: [æè¿°] â†’ å¦‚ä½•åˆ¶é€ å†²çª
è®¾å®š3: [æè¿°] â†’ å¦‚ä½•é™åˆ¶ä¸»è§’
```

---

### âœ… è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·æŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºå¤§çº²ï¼š

```markdown
# [å°è¯´æ ‡é¢˜] å¤§çº²

## ä¸€ã€æ•…äº‹ç®€ä»‹
[200-300å­—ï¼Œçªå‡ºç‹¬ç‰¹å–ç‚¹]

## äºŒã€æ•…äº‹ç»“æ„
### 2.1 å¼€ç«¯
...
### 2.2 å‘å±•
...
### 2.3 é«˜æ½®
...
### 2.4 ç»“å±€
...

## ä¸‰ã€å®Œæ•´äº‹ä»¶é“¾
### 3.1 ä¸»çº¿äº‹ä»¶æ—¶é—´çº¿
1. [ç« èŠ‚1] äº‹ä»¶åï¼šæè¿°
2. [ç« èŠ‚2] äº‹ä»¶åï¼šæè¿°
...

### 3.2 å…³é”®è½¬æŠ˜ç‚¹
è½¬æŠ˜ç‚¹1ï¼ˆç¬¬Xç« ï¼‰ï¼š...
è½¬æŠ˜ç‚¹2ï¼ˆç¬¬Yç« ï¼‰ï¼š...
...

## å››ã€ä¼ç¬”ç³»ç»Ÿ
### 4.1 ä¸»çº¿ä¼ç¬”
| ä¼ç¬”åç§° | åŸ‹è®¾ç« èŠ‚ | æš—ç¤ºå†…å®¹ | å›æ”¶ç« èŠ‚ | æ­ç¤ºæ–¹å¼ | å½±å“ |
|---------|---------|---------|---------|---------|------|
| ... | ... | ... | ... | ... | ... |

### 4.2 æ”¯çº¿ä¼ç¬”
| ä¼ç¬”åç§° | åŸ‹è®¾ç« èŠ‚ | æš—ç¤ºå†…å®¹ | å›æ”¶ç« èŠ‚ | å½±å“ |
|---------|---------|---------|---------|------|
| ... | ... | ... | ... | ... |

### 4.3 ä¼ç¬”å›æ”¶è®¡åˆ’
- ç¬¬1-3ç« åŸ‹è®¾çš„ä¸»è¦ä¼ç¬”å°†åœ¨ç¬¬Xç« å›æ”¶
- ç¬¬Yç« çš„è½¬æŠ˜å°†æ­ç¤ºç¬¬Zç« åŸ‹ä¸‹çš„ç§˜å¯†
- ...

## äº”ã€è¯¦ç»†ç« èŠ‚è§„åˆ’ï¼ˆâš ï¸ å¿…é¡»ä¸ºæ¯ä¸€ç« æä¾›å®Œæ•´å¤§çº²ï¼ï¼‰

### ğŸ”´ ç« èŠ‚è§„åˆ’è¦æ±‚
- **å¿…é¡»ä¸ºæ‰€æœ‰ {chapter_count} ç« æä¾›è¯¦ç»†å¤§çº²**
- **ä¸èƒ½ä½¿ç”¨"..."çœç•¥ä»»ä½•ç« èŠ‚**
- æ¯ç« éƒ½è¦æœ‰å®Œæ•´çš„å†…å®¹è§„åˆ’

### ç¬¬1ç« ï¼šã€æ ‡é¢˜ã€‘
- **æ ¸å¿ƒäº‹ä»¶**ï¼šï¼ˆ200å­—ä»¥å†…ï¼Œæœ¬ç« å‘ç”Ÿäº†ä»€ä¹ˆï¼‰
- **åœºæ™¯è®¾å®š**ï¼šï¼ˆåœ¨å“ªé‡Œå‘ç”Ÿï¼‰
- **äººç‰©å‡ºåœº**ï¼šï¼ˆå“ªäº›äººç‰©é¦–æ¬¡å‡ºç°ï¼Œå“ªäº›äººç‰©æœ‰é‡è¦æˆä»½ï¼‰
- **æƒ…èŠ‚æ¨è¿›**ï¼šï¼ˆå¦‚ä½•æ¨è¿›ä¸»çº¿/æ”¯çº¿ï¼‰
- **å†²çªå‘å±•**ï¼šï¼ˆæœ¬ç« çš„å†²çªæ˜¯ä»€ä¹ˆï¼‰
- **ä¼ç¬”åŸ‹è®¾**ï¼šï¼ˆåŸ‹è®¾å“ªäº›ä¼ç¬”ï¼Œå¦‚ä½•æš—ç¤ºï¼‰
- **ç»“å°¾æ‚¬å¿µ**ï¼šï¼ˆç« æœ«å¦‚ä½•å¸å¼•ç»§ç»­é˜…è¯»ï¼‰
- **æƒ…æ„ŸèŠ‚å¥**ï¼šï¼ˆç´§å¼ /ç¼“å’Œ/é“ºå«ï¼‰
- **å­—æ•°ç›®æ ‡**ï¼šï¼ˆ3000-5000å­—ï¼‰

### ç¬¬2ç« ï¼šã€æ ‡é¢˜ã€‘
- **æ ¸å¿ƒäº‹ä»¶**ï¼š
- **åœºæ™¯è®¾å®š**ï¼š
- **äººç‰©å‡ºåœº**ï¼š
- **æƒ…èŠ‚æ¨è¿›**ï¼š
- **å†²çªå‘å±•**ï¼š
- **ä¼ç¬”åŸ‹è®¾/å›æ”¶**ï¼š
- **ç»“å°¾æ‚¬å¿µ**ï¼š
- **æƒ…æ„ŸèŠ‚å¥**ï¼š
- **å­—æ•°ç›®æ ‡**ï¼š

### ç¬¬3ç« ï¼šã€æ ‡é¢˜ã€‘
ï¼ˆåŒä¸Šç»“æ„ï¼‰

...ï¼ˆä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°ç¬¬{chapter_count}ç« ï¼‰

### ç¬¬{chapter_count}ç« ï¼šã€æ ‡é¢˜ã€‘
- **æ ¸å¿ƒäº‹ä»¶**ï¼š
- **åœºæ™¯è®¾å®š**ï¼š
- **äººç‰©å‡ºåœº**ï¼š
- **æƒ…èŠ‚æ¨è¿›**ï¼š
- **å†²çªå‘å±•**ï¼š
- **ä¼ç¬”å›æ”¶**ï¼šï¼ˆå“ªäº›ä¼ç¬”åœ¨æ­¤ç« æ­ç¤ºï¼‰
- **ç»“å°¾å¤„ç†**ï¼šï¼ˆå¦‚ä½•ä¸ºåç»­åšé“ºå«ï¼‰
- **æƒ…æ„ŸèŠ‚å¥**ï¼š
- **å­—æ•°ç›®æ ‡**ï¼š

âš ï¸ **ç¡®è®¤ï¼šä»¥ä¸Šå·²åŒ…å«å…¨éƒ¨ {chapter_count} ç« çš„å®Œæ•´è§„åˆ’ï¼Œæ— ä»»ä½•çœç•¥ï¼**

## å…­ã€äººç‰©å…³ç³»ç½‘ç»œ
### ä¸»è§’å…³ç³»
- vs é…è§’Aï¼š[å…³ç³»æ€§è´¨ï¼Œå˜åŒ–]
- vs åæ´¾ï¼š[å…³ç³»æ€§è´¨ï¼Œå˜åŒ–]
...

### æ¬¡è¦å…³ç³»
- é…è§’A vs é…è§’Bï¼š...
...

## ä¸ƒã€ä¸–ç•Œè§‚è¦ç‚¹
1. [è®¾å®šåç§°]ï¼š[æè¿°] â†’ [å‰§æƒ…å½±å“]
2. ...
```

---

### âš ï¸ æœ€åæ£€æŸ¥

åœ¨è¾“å‡ºä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š
1. âœ… ä¼ç¬”ç³»ç»Ÿå®Œæ•´å—ï¼Ÿï¼ˆä¸»çº¿ã€æ”¯çº¿éƒ½æœ‰ï¼‰
2. âœ… æ¯ä¸ªä¼ç¬”éƒ½æœ‰å›æ”¶è®¡åˆ’å—ï¼Ÿ
3. âœ… äº‹ä»¶é“¾é€»è¾‘è¿è´¯å—ï¼Ÿ
4. âœ… äººç‰©å…³ç³»æ¸…æ™°å—ï¼Ÿ
5. âœ… ç« èŠ‚è§„åˆ’å®Œæ•´å—ï¼Ÿ
6. âœ… æ‹’ç»ä¿—å¥—äº†å—ï¼Ÿ
7. âœ… ç»“å±€æœ‰æ–°æ„å—ï¼Ÿ

**ç°åœ¨è¯·å¼€å§‹åˆ›ä½œå®Œæ•´å¤§çº²ï¼**
"""
        return prompt

    def _build_character_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for character design"""
        prompt = """## ğŸš¨ğŸš¨ğŸš¨ æœ€é«˜ä¼˜å…ˆçº§è¦æ±‚ï¼šä¸»è§’åç§°å¿…é¡»ç‹¬ç‰¹ï¼ğŸš¨ğŸš¨ğŸš¨

åœ¨ç”Ÿæˆäººç‰©ä¹‹å‰ï¼Œå¿…é¡»éµå®ˆä»¥ä¸‹å‘½åè§„åˆ™ï¼š

### âŒ ç»å¯¹ç¦æ­¢ä½¿ç”¨çš„åå­—ï¼ˆè¿è§„ç«‹å³ä½œåºŸï¼‰
**å¸¸è§ç½‘æ–‡ä¸»è§’åï¼ˆç»å¯¹ç¦æ­¢ï¼‰**ï¼š
æ—é»˜ã€å¶å‡¡ã€è§ç‚ã€æ—åŠ¨ã€æ¥šç¾½ã€è‹é“­ã€æ–¹å¯’ã€å®å·ã€æ±Ÿå°˜ã€ç§¦ç¾½ã€å”ä¸‰ã€ç½—å³°ã€æ¥šæ«ã€é™ˆåŒ—ç„ã€ç‰§ç«¥ã€å®‹æ…ˆã€é¡¾æ…ä¸ºç­‰

**å†å²åäººï¼ˆç»å¯¹ç¦æ­¢ï¼‰**ï¼š
æç™½ã€æœç”«ã€è‹è½¼ã€è¯¸è‘›äº®ã€å…³ç¾½ã€æ›¹æ“ã€åˆ˜å¤‡ã€å­™æƒã€å²³é£ã€æ–‡å¤©ç¥¥ç­‰

**ç¥è¯äººç‰©ï¼ˆç»å¯¹ç¦æ­¢ï¼‰**ï¼š
å“ªå’ã€æ¨æˆ¬ã€äºŒéƒç¥ã€å¤ªç™½é‡‘æ˜Ÿã€ç‰çš‡å¤§å¸ã€å¦‚æ¥ä½›ç¥–ã€è§‚éŸ³è©è¨ç­‰

### âœ… æ­£ç¡®çš„å‘½åæ–¹å¼
**æ–¹æ³•1ï¼šç½•è§å§“æ° + æœ‰å¯“æ„çš„åå­—**
- é™†æ²‰èˆŸã€æ¥šæœªå¤®ã€é¡¾é’å¯’ã€è°¢å®‰æ¾œã€è§ä¹æ­Œã€å¤œä¸ƒæ€ã€å¢¨åƒå±±ã€ç™½æ— å¿§
- æ±Ÿå—çƒŸã€åŒ—å®«å¯’ã€è¥¿é—¨é›ªã€ä¸œæ–¹ç‰ã€ç‹¬å­¤è´¥ã€å¸é©¬é•¿é£ã€çš‡ç”«é™

**æ–¹æ³•2ï¼šå®Œå…¨è‡ªé€ çš„åå­—**
- ä»è¯—è¯ã€æˆè¯­ã€è‡ªç„¶ç°è±¡ä¸­æå–å…ƒç´ ç»„åˆ
- ç¡®ä¿ä¸ä¼šè®©äººè”æƒ³åˆ°å…¶ä»–ä»»ä½•ä½œå“

**æ–¹æ³•3ï¼šä½¿ç”¨å¤å§“æˆ–ä¸‰å­—å**
- æ¬§é˜³ã€ä¸Šå®˜ã€çš‡ç”«ã€å¸é©¬ã€ç‹¬å­¤ã€å®‡æ–‡ã€é•¿å­™ç­‰
- é…åˆæœ‰å¯“æ„çš„å­—ï¼Œå¦‚æ¬§é˜³äº‘ã€ä¸Šå®˜å©‰ã€çš‡ç”«è°§

### âš ï¸ è¿è§„åæœ
å¦‚æœä½¿ç”¨äº†ä¸Šè¿°ç¦æ­¢åå­—ï¼Œæ•´ä¸ªè®¾è®¡å°†è¢«æ‹’ç»ï¼Œéœ€è¦é‡æ–°è®¾è®¡ï¼

---

## ä»»åŠ¡: è®¾è®¡äººç‰©è§’è‰²

### æ•…äº‹å¤§çº²
"""

        # Add outline information
        for result in context.recent_results:
            if result["task_type"] == "å¤§çº²":
                prompt += f"\n{result['content'][:800]}...\n"
                break

        prompt += """

### è¾“å‡ºè¦æ±‚

è¯·è®¾è®¡ä¸»è¦äººç‰©è§’è‰²ï¼Œæ¯ä¸ªè§’è‰²éƒ½å¿…é¡»æœ‰æ·±åº¦å’Œç«‹ä½“æ„Ÿï¼š

**ä¸»è§’:**
- **å§“å**ï¼ˆğŸš¨ğŸš¨ï¿½ï¸ å¿…é¡»ç‹¬ç‰¹ï¼Œç»å¯¹ä¸è¦ä½¿ç”¨ä¸Šè¿°ç¦ç”¨åå­—ï¼ğŸš¨ğŸš¨ï¿½ï¸ï¼‰
- å¹´é¾„ã€å¤–è²Œç‰¹å¾
- æ€§æ ¼ç‰¹ç‚¹ï¼ˆè‡³å°‘3ä¸ªæ­£é¢ç‰¹è´¨å’Œ1-2ä¸ªè‡´å‘½ç¼ºé™·ï¼‰
- èƒŒæ™¯è®¾å®šï¼ˆå®¶åº­ã€æˆé•¿ç»å†ã€å…³é”®è½¬æŠ˜ç‚¹ï¼‰
- æ ¸å¿ƒåŠ¨æœºï¼ˆå†…åœ¨é©±åŠ¨åŠ›å’Œå¤–åœ¨ç›®æ ‡ï¼‰
- èƒ½åŠ›/ç‰¹é•¿ï¼ˆä»¥åŠå±€é™æ€§ï¼‰
- æ€§æ ¼ç¼ºé™·ï¼ˆè‡´å‘½å¼±ç‚¹ï¼Œä¼šå¯¼è‡´å†²çªï¼‰
- æˆé•¿å¼§çº¿ï¼ˆèµ·ç‚¹ã€è½¬æŠ˜ã€ç»ˆç‚¹ï¼‰
- è¯´è¯é£æ ¼å’Œå£å¤´ç¦…

**é‡è¦é…è§’ï¼ˆæ¯ä¸ªé…è§’éƒ½éœ€è¦å®Œæ•´å°ä¼ ï¼‰:**
- 3-5ä¸ªé‡è¦é…è§’
- æ¯ä¸ªé…è§’çš„å®Œæ•´å°ä¼ ï¼ŒåŒ…æ‹¬ï¼š
  - å§“åï¼ˆğŸš¨ åŒæ ·å¿…é¡»ç‹¬ç‰¹ï¼Œä¸è¦ä½¿ç”¨ç¦ç”¨åå­—ï¼ï¼‰
  - èƒŒæ™¯æ•…äº‹ï¼šä»–ä»¬çš„è¿‡å»ç»å†äº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæˆä¸ºç°åœ¨è¿™æ ·ï¼Ÿ
  - æ ¸å¿ƒåŠ¨æœºï¼šä»–ä»¬çœŸæ­£æƒ³è¦ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
  - æ€§æ ¼ç‰¹ç‚¹ï¼šä¼˜ç‚¹å’Œç¼ºç‚¹éƒ½è¦æœ‰
  - ä¸ä¸»è§’çš„å…³ç³»ï¼šå¤æ‚çš„å…³ç³»ç½‘ç»œï¼ˆä¸ä»…ä»…æ˜¯æœ‹å‹/æ•Œäººï¼‰
  - è‡ªèº«çš„æ•…äº‹çº¿ï¼šé…è§’åº”è¯¥æœ‰è‡ªå·±çš„ç›®æ ‡å’Œæˆé•¿
  - å¯¹è¯é£æ ¼ï¼šç‹¬ç‰¹çš„è¯´è¯æ–¹å¼ï¼Œåæ˜ å…¶æ€§æ ¼å’ŒèƒŒæ™¯

**é…è§’å¯¹è¯æŒ‡å¯¼åŸåˆ™:**
- æ¯ä¸ªè§’è‰²çš„å¯¹è¯å¿…é¡»ç¬¦åˆå…¶æ€§æ ¼ã€èƒŒæ™¯å’Œæ•™è‚²æ°´å¹³
- é€šè¿‡å¯¹è¯å±•ç¤ºäººç‰©çš„æƒ…æ„Ÿå˜åŒ–å’Œå†…å¿ƒå†²çª
- é¿å…ç›´ç™½çš„ä¿¡æ¯å€¾å€’ï¼Œç”¨è‡ªç„¶çš„å¯¹è¯ä¼ è¾¾ä¿¡æ¯
- å¢åŠ å¯¹è¯çš„å±‚æ¬¡æ„Ÿï¼Œæœ‰äº›è¯æ˜è¯´ï¼Œæœ‰äº›è¯æš—ç¤º

**äººç‰©å…³ç³»å›¾:**
- ä¸»è¦äººç‰©ä¹‹é—´å¤æ‚çš„å…³ç³»ç½‘ç»œ
- åŒ…æ‹¬æ˜é¢çš„å…³ç³»å’Œéšè—çš„çŸ›ç›¾

è¯·ä»¥ç»“æ„åŒ–æ ¼å¼è¾“å‡ºäººç‰©è®¾è®¡ï¼Œç¡®ä¿æ¯ä¸ªé…è§’éƒ½æœ‰è¶³å¤Ÿçš„æ·±åº¦ã€‚
"""
        return prompt

    def _build_worldview_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for worldview building"""
        genre = metadata.get("genre", self.genre)

        prompt = f"""## ä»»åŠ¡: æ„å»ºä¸–ç•Œè§‚è®¾å®š

### ç±»å‹
{genre}

### æ•…äº‹å¤§çº²
"""

        # Add outline information
        for result in context.recent_results:
            if result["task_type"] == "å¤§çº²":
                prompt += f"\n{result['content'][:800]}...\n"
                break

        prompt += """

### è¾“å‡ºè¦æ±‚

è¯·æ„å»ºå®Œæ•´çš„ä¸–ç•Œè§‚è®¾å®š:

**åŸºç¡€è®¾å®š:**
- ä¸–ç•Œç±»å‹ï¼ˆç°å®/æ¶ç©º/æœªæ¥ç­‰ï¼‰
- æ—¶ä»£èƒŒæ™¯
- åœ°ç†ç¯å¢ƒ

**åŠ›é‡ä½“ç³»:** (å¦‚é€‚ç”¨)
- èƒ½é‡ç±»å‹
- ç­‰çº§åˆ’åˆ†
- ä¿®ç‚¼/æˆé•¿æ–¹å¼
- é™åˆ¶å’Œä»£ä»·

**ç¤¾ä¼šç»“æ„:**
- æ”¿æ²»ä½“ç³»
- ç»æµä½“ç³»
- æ–‡åŒ–ç‰¹è‰²
- åŠ¿åŠ›åˆ’åˆ†

**ç‰¹æ®Šè®¾å®š:**
- ç‹¬ç‰¹çš„è§„åˆ™æˆ–ç°è±¡
- é‡è¦åœ°ç‚¹
- å…³é”®ç‰©å“

è¯·ä»¥ç»“æ„åŒ–æ ¼å¼è¾“å‡ºä¸–ç•Œè§‚è®¾å®šã€‚
"""
        return prompt

    def _build_events_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for event design"""
        prompt = """## ä»»åŠ¡: è®¾è®¡æƒ…èŠ‚äº‹ä»¶

### æ•…äº‹å¤§çº²
"""

        # Add outline information
        for result in context.recent_results:
            if result["task_type"] == "å¤§çº²":
                prompt += f"\n{result['content'][:800]}...\n"
                break

        prompt += """

### è¾“å‡ºè¦æ±‚

è¯·è®¾è®¡ä¸»è¦æƒ…èŠ‚äº‹ä»¶é“¾:

**ä¸»çº¿äº‹ä»¶:**
- æŒ‰æ—¶é—´é¡ºåºåˆ—å‡º10-20ä¸ªå…³é”®äº‹ä»¶
- æ¯ä¸ªäº‹ä»¶åŒ…æ‹¬: è§¦å‘æ¡ä»¶ã€ä¸»è¦å†…å®¹ã€ç»“æœå½±å“ã€ä¼ç¬”å…³è”

**æ”¯çº¿äº‹ä»¶:**
- 3-5æ¡æ”¯çº¿
- æ¯æ¡æ”¯çº¿çš„èµ·æ‰¿è½¬åˆ

**å†²çªè®¾è®¡:**
- ä¸»è¦å†²çªç‚¹
- å†²çªå‡çº§è·¯å¾„
- å†²çªè§£å†³æ–¹å¼

è¯·ä»¥æ¸…æ™°çš„æ—¶é—´çº¿æ ¼å¼è¾“å‡ºäº‹ä»¶è®¾è®¡ã€‚
"""
        return prompt

    def _build_scenes_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for scene and item design"""
        prompt = """## ä»»åŠ¡: è®¾è®¡åœºæ™¯ã€ç‰©å“å’Œå†²çª

### ç›¸å…³ä¿¡æ¯
"""

        # Add relevant context
        for result in context.recent_results[:3]:
            prompt += f"\n#### {result['task_type']}\n{result['content'][:400]}...\n"

        prompt += """

### è¾“å‡ºè¦æ±‚

**é‡è¦åœºæ™¯:**
- 5-10ä¸ªå…³é”®åœºæ™¯
- æ¯ä¸ªåœºæ™¯çš„ç¯å¢ƒæè¿°
- æ°›å›´è¥é€ è¦ç‚¹
- ä¸å‰§æƒ…çš„å…³è”

**é‡è¦ç‰©å“:**
- 5-10ä¸ªå…³é”®ç‰©å“
- æ¯ä¸ªç‰©å“çš„æè¿°
- åŠŸèƒ½å’Œè±¡å¾æ„ä¹‰
- è·å–/ä½¿ç”¨æ–¹å¼

**å†²çªåœºæ™¯:**
- ä¸»è¦å¯¹å³™åœºæ™¯
- å†²çªçš„è¡¨ç°å½¢å¼
- åœºæ™¯çš„è½¬æŠ˜ç‚¹

è¯·ä»¥ç»“æ„åŒ–æ ¼å¼è¾“å‡ºè®¾è®¡ç»“æœã€‚
"""
        return prompt

    def _build_foreshadow_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for foreshadow planning"""
        prompt = """## ä»»åŠ¡: è§„åˆ’ä¼ç¬”å…ƒç´ 

### æ•…äº‹å¤§çº²å’Œäº‹ä»¶
"""

        # Add relevant context
        for result in context.recent_results:
            if result["task_type"] in ["å¤§çº²", "äº‹ä»¶"]:
                prompt += f"\n#### {result['task_type']}\n{result['content'][:400]}...\n"

        prompt += """

### è¾“å‡ºè¦æ±‚

è¯·è§„åˆ’æ•…äº‹çš„ä¼ç¬”ç³»ç»Ÿ:

**ä¸»çº¿ä¼ç¬”:**
- 5-10ä¸ªä¸»çº¿ä¼ç¬”
- æ¯ä¸ªä¼ç¬”çš„: åŸ‹è®¾ä½ç½®ã€æš—ç¤ºå†…å®¹ã€å›æ”¶æ—¶æœºã€å½±å“èŒƒå›´

**æ”¯çº¿ä¼ç¬”:**
- 3-5ä¸ªæ”¯çº¿ä¼ç¬”
- åŸ‹è®¾å’Œå›æ”¶è®¡åˆ’

**ç»†èŠ‚ä¼ç¬”:**
- å¯ä»¥åŸ‹è—ä¼ç¬”çš„ç»†èŠ‚ç±»å‹
- éšè—æŠ€å·§

è¯·ä»¥è¡¨æ ¼å½¢å¼åˆ—å‡ºä¼ç¬”è§„åˆ’ï¼ŒåŒ…å«ç« èŠ‚ä½ç½®ä¿¡æ¯ã€‚
"""
        return prompt

    # æ³¨ï¼šä¸€è‡´æ€§æ£€æŸ¥å·²åˆå¹¶åˆ°ç»¼åˆè¯„ä¼°ä»»åŠ¡ä¸­ï¼Œ_build_consistency_prompt æ–¹æ³•å·²ç§»é™¤

    def _build_chapter_outline_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for chapter outline"""
        chapter_index = metadata.get("chapter_index", 1)

        prompt = f"""## ä»»åŠ¡: ç¬¬{chapter_index}ç« å¤§çº²

### å…¨å±€è®¾å®š
"""

        # Add global context
        for result in context.recent_results[:3]:
            prompt += f"{result['task_type']}: {result['content'][:200]}...\n"

        prompt += f"""

### é‡è¦æç¤ºï¼šä¿¡æ¯é‡å‡è¡¡ä¸èŠ‚å¥æ§åˆ¶

**é¿å…å¸¸è§é—®é¢˜:**
- âŒ ä¿¡æ¯è¿‡è½½ï¼šä¸è¦åœ¨å•ä¸€ç« èŠ‚ä¸­å †ç§¯è¿‡å¤šèƒŒæ™¯ä»‹ç»å’Œç»†èŠ‚
- âŒ ä¿¡æ¯ä¸è¶³ï¼šç¡®ä¿æ¯ä¸ªç« èŠ‚éƒ½æœ‰è¶³å¤Ÿçš„å†…å®¹æ”¯æ’‘æƒ…èŠ‚æ¨è¿›
- âŒ èŠ‚å¥ä¸ä¸€è‡´ï¼šé¿å…éƒ¨åˆ†ç« èŠ‚è¿‡å¿«ã€éƒ¨åˆ†ç« èŠ‚è¿‡æ…¢

**ä¿¡æ¯é‡å‡è¡¡åŸåˆ™:**
- æ¯ä¸ªç« èŠ‚åº”è¯¥æœ‰1-2ä¸ªæ ¸å¿ƒä¿¡æ¯ç‚¹æˆ–æƒ…èŠ‚æ¨è¿›
- èƒŒæ™¯ä¿¡æ¯åº”åˆ†æ•£åˆ°å¤šä¸ªç« èŠ‚ï¼Œé€šè¿‡å¯¹è¯å’Œè¡ŒåŠ¨è‡ªç„¶å±•ç°
- é¿å…åœ¨ç« èŠ‚å¼€å¤´å¤§æ®µçš„è¯´æ˜æ€§æ–‡å­—
- é€šè¿‡æƒ…èŠ‚å‘å±•è‡ªç„¶å¸¦å‡ºä¸–ç•Œè§‚å’Œè®¾å®šä¿¡æ¯

**èŠ‚å¥æ§åˆ¶è¦ç‚¹:**
- ç´§å¼ æƒ…èŠ‚ä¹‹åé€‚å½“æ”¾ç¼“ï¼Œç»™è¯»è€…ç¼“å†²æ—¶é—´
- å¹³æ»‘è¿‡æ¸¡ï¼Œé¿å…çªå…€çš„èŠ‚å¥è·³è·ƒ
- æ¯ç« éƒ½åº”æœ‰å°é«˜æ½®ï¼Œç« æœ«ç•™æ‚¬å¿µå¸å¼•ç»§ç»­é˜…è¯»

### è¾“å‡ºè¦æ±‚

è¯·ä¸ºç¬¬{chapter_index}ç« åˆ›å»ºè¯¦ç»†å¤§çº²:

1. **ç« èŠ‚æ ‡é¢˜**: å¸å¼•äººçš„æ ‡é¢˜
2. **æ ¸å¿ƒç›®æ ‡**: æœ¬ç« è¦è¾¾æˆä»€ä¹ˆæƒ…èŠ‚ç›®æ ‡ï¼Ÿï¼ˆ1-2ä¸ªå³å¯ï¼‰
3. **åœºæ™¯åˆ’åˆ†**: 3-5ä¸ªåœºæ™¯ï¼Œæ¯ä¸ªåœºæ™¯çš„ä¿¡æ¯é‡è¦å‡è¡¡
4. **å‡ºåœºäººç‰©**: æœ¬ç« å‡ºåœºçš„äººç‰©åŠå…¶ä½œç”¨
5. **æƒ…èŠ‚æ¨è¿›**: æ¨è¿›çš„ä¸»çº¿/æ”¯çº¿ï¼ˆæ˜ç¡®æ¨è¿›äº†ä»€ä¹ˆï¼‰
6. **å†²çªå‘å±•**: æœ¬ç« çš„å†²çªï¼ˆæ–°å†²çªæˆ–æ—§å†²çªå‡çº§ï¼‰
7. **ä¼ç¬”åŸ‹è®¾/å›æ”¶**: æœ¬ç« æ¶‰åŠçš„ä¼ç¬”
8. **ç»“å°¾æ‚¬å¿µ**: ç« æœ«çš„æ‚¬å¿µç‚¹
9. **ä¿¡æ¯å¯†åº¦è¯„ä¼°**: é¢„ä¼°æœ¬ç« çš„ä¿¡æ¯é‡æ˜¯å¦é€‚ä¸­ï¼ˆè¿‡ä½/é€‚ä¸­/è¿‡é«˜ï¼‰

è¯·ä»¥ç»“æ„åŒ–æ ¼å¼è¾“å‡ºç« èŠ‚å¤§çº²ã€‚
"""
        return prompt

    def _build_scene_generation_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for scene generation"""
        chapter_index = metadata.get("chapter_index", 1)
        scene_index = metadata.get("scene_index", 1)

        prompt = f"""## ä»»åŠ¡: ç¬¬{chapter_index}ç« åœºæ™¯{scene_index}ç”Ÿæˆ

### ç« èŠ‚å¤§çº²
"""

        # Add chapter outline
        for result in context.recent_results:
            if result.get("chapter_index") == chapter_index:
                prompt += f"\n{result['content'][:500]}...\n"
                break

        prompt += """

### é‡è¦æç¤ºï¼šå¯¹è¯çœŸå®æ€§

**é¿å…å¸¸è§é—®é¢˜:**
- âŒ å¯¹è¯ç”Ÿç¡¬ï¼šä¸ç¬¦åˆäººç‰©æ€§æ ¼å’ŒèƒŒæ™¯
- âŒ ä¿¡æ¯å€¾å€’ï¼šé€šè¿‡å¤§æ®µå¯¹è¯è¯´æ˜èƒŒæ™¯
- âŒ é™ˆè¯æ»¥è°ƒï¼šä½¿ç”¨è¿‡äºç›´ç™½æˆ–å¥—è·¯åŒ–çš„è¡¨è¾¾
- âŒ ç¼ºä¹å±‚æ¬¡ï¼šå¯¹è¯åªæœ‰è¡¨æ„ï¼Œæ²¡æœ‰æ½œå°è¯

**å¯¹è¯çœŸå®æ€§åŸåˆ™:**
- æ¯ä¸ªè§’è‰²çš„å¯¹è¯å¿…é¡»ç¬¦åˆå…¶æ€§æ ¼ã€èƒŒæ™¯å’Œæ•™è‚²æ°´å¹³
- é€šè¿‡å¯¹è¯å±•ç¤ºäººç‰©çš„æƒ…æ„Ÿå˜åŒ–å’Œå†…å¿ƒå†²çªï¼Œè€Œéç›´æ¥é™ˆè¿°
- å¢åŠ å¯¹è¯çš„å±‚æ¬¡æ„Ÿï¼šæœ‰äº›è¯æ˜è¯´ï¼Œæœ‰äº›è¯æš—ç¤ºï¼Œæœ‰äº›è¯ä¸è¯´
- é¿å…è¿‡äºç›´ç™½çš„è¡¨è¾¾ï¼Œå¢åŠ å¯¹è¯çš„å¾®å¦™æ„Ÿå’ŒçœŸå®æ„Ÿ
- ä½¿ç”¨è§’è‰²ç‹¬ç‰¹çš„è¯´è¯æ–¹å¼ã€å£å¤´ç¦…å’Œè¯­è¨€ä¹ æƒ¯
"""

        # æ·»åŠ é£æ ¼ç‰¹å®šçš„å†™ä½œæŒ‡å¯¼
        genre_guidance = self._get_genre_guidance(context, metadata)
        if genre_guidance:
            prompt += f"\n{genre_guidance}\n"

        prompt += """
### è¾“å‡ºè¦æ±‚

è¯·ç”Ÿæˆè¯¦ç»†çš„åœºæ™¯å†…å®¹:

1. **åœºæ™¯æè¿°**: ç¯å¢ƒã€æ°›å›´ï¼ˆå…·è±¡ç”ŸåŠ¨ï¼Œé¿å…æŠ½è±¡æè¿°ï¼‰
2. **äººç‰©åŠ¨ä½œ**: äººç‰©çš„è¡Œä¸ºå’Œäº’åŠ¨ï¼ˆé€šè¿‡è¡ŒåŠ¨å±•ç°æ€§æ ¼ï¼‰
3. **å¯¹è¯**: ç¬¦åˆäººç‰©æ€§æ ¼çš„è‡ªç„¶å¯¹è¯ï¼ˆå…³é”®ï¼ï¼‰
4. **å¿ƒç†æå†™**: äººç‰©å†…å¿ƒæ´»åŠ¨ï¼ˆé€šè¿‡å†…å¿ƒç‹¬ç™½å±•ç°å¤æ‚æƒ…æ„Ÿï¼‰
5. **æ„Ÿå®˜ç»†èŠ‚**: è§†è§‰ã€å¬è§‰ã€è§¦è§‰ç­‰å…·ä½“ç»†èŠ‚
6. **èŠ‚å¥æ§åˆ¶**: å¿«æ…¢èŠ‚å¥çš„æŠŠæ¡ï¼ˆç´§å¼ åœºæ™¯å¿«èŠ‚å¥ï¼Œåæ€åœºæ™¯æ…¢èŠ‚å¥ï¼‰

è¯·ç›´æ¥è¾“å‡ºåœºæ™¯å†…å®¹ï¼Œ1500-2500å­—ã€‚
"""
        return prompt

    async def _build_chapter_content_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for chapter content generationï¼ˆé€ç« ç”Ÿæˆï¼Œç¡®ä¿è¿è´¯æ€§ï¼‰"""
        chapter_index = metadata.get("chapter_index", 1)
        chapter_count = metadata.get("chapter_count", 10)
        is_first_chapter = metadata.get("is_first_chapter", False)

        prompt = f"""## ä»»åŠ¡: ç¬¬{chapter_index}ç« å†…å®¹ç”Ÿæˆï¼ˆé€ç« ç”Ÿæˆæ¨¡å¼ï¼‰

### ğŸ”¥ è¿è´¯æ€§ä¼˜å…ˆçº§ï¼šæœ€é«˜

**è¿™æ˜¯é€ç« ç”Ÿæˆæ¨¡å¼ï¼Œæ¯ä¸€ç« éƒ½å¿…é¡»ä¸å‰é¢çš„ç« èŠ‚ä¿æŒè¿è´¯ï¼**

---

### âš ï¸ äººç‰©åç§°ä¸€è‡´æ€§è¦æ±‚

**å¿…é¡»ä½¿ç”¨äººç‰©è®¾è®¡ä¸­ç¡®å®šçš„è§’è‰²åç§°ï¼Œç»å¯¹ä¸è¦æ›´æ¢æˆ–åˆ›é€ æ–°åå­—ï¼**

ä»ä¸Šä¸‹æ–‡ä¸­æå–æ‰€æœ‰äººç‰©åç§°ï¼Œç¡®ä¿ï¼š
- ä¸»è§’åç§°ä¿æŒä¸€è‡´ï¼ˆä¸è¦ç”¨æ—é»˜ã€å¶å‡¡ç­‰ä¿—å¥—åå­—ï¼‰
- é…è§’åç§°ä¿æŒä¸€è‡´
- åœ°ç‚¹ã€ç‰©å“åç§°ä¿æŒä¸€è‡´

å¦‚æœäººç‰©è®¾è®¡ä¸­æœªæä¾›å…·ä½“åç§°ï¼Œä½¿ç”¨ç½•è§çš„ã€è‡ªé€ çš„åå­—ï¼Œç»å¯¹ä¸è¦ä½¿ç”¨å¸¸è§ç½‘æ–‡ä¸»è§’åï¼

---

### ğŸ“š åŸºç¡€ä¸Šä¸‹æ–‡ï¼ˆå¿…é¡»å‚è€ƒï¼‰

#### 1ï¸âƒ£ å®Œæ•´å¤§çº²ï¼ˆæœ€é‡è¦çš„è“å›¾ï¼ï¼‰
"""

        # æ·»åŠ å®Œæ•´å¤§çº²
        for result in context.recent_results:
            if result["task_type"] == "å¤§çº²":
                prompt += f"\n```markdown\n{result['content']}\n```\n"
                break

        prompt += "\n#### 2ï¸âƒ£ äººç‰©è®¾è®¡ï¼ˆç¡®ä¿äººç‰©åç§°ä¸€è‡´ï¼ï¼‰\n\n"
        # æ·»åŠ äººç‰©è®¾è®¡
        for result in context.recent_results:
            if result["task_type"] == "äººç‰©è®¾è®¡":
                prompt += f"{result['content'][:2000]}...\n\n"
                break

        prompt += "\n#### 3ï¸âƒ£ ä¸–ç•Œè§‚è§„åˆ™ï¼ˆç¡®ä¿è®¾å®šä¸€è‡´ï¼ï¼‰\n\n"
        # æ·»åŠ ä¸–ç•Œè§‚
        for result in context.recent_results:
            if result["task_type"] == "ä¸–ç•Œè§‚è§„åˆ™":
                prompt += f"{result['content'][:1500]}...\n\n"
                break

        # ğŸ”¥ å…³é”®ï¼šæ·»åŠ å‰å‡ ç« çš„å†…å®¹ç”¨äºè¿è´¯æ€§
        if not is_first_chapter and chapter_index > 1:
            prompt += f"\n---\n\n### ğŸ”¥ å‰å‡ ç« å†…å®¹ï¼ˆè¿è´¯æ€§å…³é”®ï¼ï¼‰\n\n"
            prompt += f"**ä»¥ä¸‹æ˜¯ç¬¬{chapter_index-1}ç« çš„ç»“å°¾éƒ¨åˆ†ï¼Œè¯·ç¡®ä¿æœ¬ç« è‡ªç„¶è¡”æ¥ï¼š**\n\n"

            # æŸ¥æ‰¾å‰ä¸€ç« çš„å†…å®¹
            previous_chapter_found = False
            for result in context.recent_results:
                if (result.get("task_type") == "ç« èŠ‚å†…å®¹" and
                    result.get("chapter_index") == chapter_index - 1):
                    # è·å–å‰ä¸€ç« çš„ç»“å°¾éƒ¨åˆ†ï¼ˆæœ€å800å­—ï¼‰
                    content = result.get("content", "")
                    ending = content[-800:] if len(content) > 800 else content
                    prompt += f"```markdown\n...{ending}\n```\n\n"
                    previous_chapter_found = True
                    break

            if not previous_chapter_found:
                prompt += "âš ï¸ æœªæ‰¾åˆ°å‰ä¸€ç« å†…å®¹ï¼Œè¯·ç¡®ä¿æœ¬ç« èƒ½å¤Ÿè‡ªç„¶å¼€å§‹ã€‚\n\n"

            prompt += "**è¿è´¯æ€§è¦æ±‚ï¼š**\n"
            prompt += f"- æœ¬ç« å¿…é¡»è‡ªç„¶æ‰¿æ¥ç¬¬{chapter_index-1}ç« çš„ç»“å°¾\n"
            prompt += "- äººç‰©çŠ¶æ€è¦å»¶ç»­ï¼ˆä½ç½®ã€æƒ…ç»ªã€ç›®æ ‡ç­‰ï¼‰\n"
            prompt += "- æ—¶é—´çº¿è¦è¿ç»­ï¼ˆä¸è¦çªç„¶è·³è·ƒï¼‰\n"
            prompt += "- ä¼ç¬”è¦å‘¼åº”ï¼ˆå‰é¢åŸ‹ä¸‹çš„ä¼ç¬”è¦æœ‰å…³è”ï¼‰\n\n"

        prompt += f"""

---

### ğŸ“ æœ¬ç« å…·ä½“è¦æ±‚ï¼ˆç¬¬{chapter_index}ç«  / å…±{chapter_count}ç« ï¼‰

#### ä»å¤§çº²ä¸­æå–æœ¬ç« è§„åˆ’

**è¯·åŠ¡å¿…æŒ‰ç…§å¤§çº²ä¸­"ç¬¬{chapter_index}ç« "çš„è§„åˆ’æ¥å†™ï¼**

å¤§çº²ä¸­å…³äºæœ¬ç« çš„è§„åˆ’åŒ…æ‹¬ï¼š
- æ ¸å¿ƒäº‹ä»¶
- åœºæ™¯è®¾å®š
- äººç‰©å‡ºåœº
- æƒ…èŠ‚æ¨è¿›
- å†²çªå‘å±•
- ä¼ç¬”åŸ‹è®¾/å›æ”¶
- ç»“å°¾æ‚¬å¿µ

---

### âœ… åˆ›ä½œè¦æ±‚ï¼ˆä¸¥æ ¼éµå®ˆï¼ï¼‰

#### ğŸš¨ å…³é”®çº¦æŸ

1. **äººç‰©åç§°ä¸€è‡´æ€§**
   - ä¸»è§’åç§°å¿…é¡»ä»"äººç‰©è®¾è®¡"ä¸­æå–ï¼Œç»å¯¹ä¸è¦åˆ›é€ æ–°åå­—
   - é…è§’åç§°ä¹Ÿè¦ä¿æŒä¸€è‡´
   - ç»å¯¹ä¸è¦ä½¿ç”¨æ—é»˜ã€å¶å‡¡ã€è§ç‚ç­‰ä¿—å¥—åå­—

2. **å‰§æƒ…ä¸¥æ ¼éµå¾ªå¤§çº²**
   - æœ¬ç« å¿…é¡»æŒ‰ç…§å¤§çº²ä¸­çš„"ç« èŠ‚è§„åˆ’"æ‰§è¡Œ
   - äº‹ä»¶å¿…é¡»æŒ‰ç…§"äº‹ä»¶é“¾"å‘ç”Ÿ
   - ä¼ç¬”å¿…é¡»åœ¨æŒ‡å®šç« èŠ‚åŸ‹è®¾/å›æ”¶

3. **ä¸–ç•Œè§‚ä¸€è‡´**
   - æ‰€æœ‰è®¾å®šå¿…é¡»éµå®ˆ"ä¸–ç•Œè§‚è§„åˆ™"
   - åŠ›é‡ä½“ç³»ã€åœ°ç‚¹åç§°ã€ç»„ç»‡åç§°å¿…é¡»ä¸€è‡´

4. **å­—æ•°æ§åˆ¶**
   - æœ¬ç«  3000-5000 å­—
   - ä¸è¦å†™æˆæµæ°´è´¦
   - æœ¬ç« è¦æœ‰ç‹¬ç«‹çš„å†…å®¹å’Œè¿›å±•

#### è¿è´¯æ€§è¦ç‚¹

{f'''
- **å¼€å¤´å¿…é¡»æ‰¿æ¥ç¬¬{chapter_index-1}ç« **ï¼šä¸è¦çªç„¶å¼€å§‹æ–°åœºæ™¯
- **äººç‰©çŠ¶æ€å»¶ç»­**ï¼šäººç‰©çš„ä½ç½®ã€æƒ…ç»ªã€ç›®æ ‡è¦è‡ªç„¶å»¶ç»­
- **æ—¶é—´çº¿è¿ç»­**ï¼šä¸è¦æœ‰æ—¶é—´è·³è·ƒ
''' if not is_first_chapter else '- **è¿™æ˜¯ç¬¬ä¸€ç« **ï¼šè¦å¼€å¥½å¤´ï¼Œè®¾ç½®å¥½æ•…äº‹åŸºè°ƒå’Œæ‚¬å¿µ'}

#### æ¯ç« å¿…é¡»åŒ…å«ï¼š

1. **å¼€å¤´**ï¼ˆ200-500å­—ï¼‰
   - {f'æ‰¿æ¥ä¸Šä¸€ç« ï¼ˆç¬¬{chapter_index-1}ç« ï¼‰' if not is_first_chapter else 'è®¾ç½®å¼€åœº'}
   - è®¾ç½®æœ¬ç« åŸºè°ƒ
   - å¼•å…¥æœ¬ç« æ ¸å¿ƒé—®é¢˜

2. **ä¸»ä½“**ï¼ˆ2000-3500å­—ï¼‰
   - 2-4 ä¸ªåœºæ™¯
   - äººç‰©å¯¹è¯ï¼ˆå 30-40%ï¼‰
   - è¡ŒåŠ¨æå†™
   - å¿ƒç†æ´»åŠ¨
   - ä¼ç¬”åŸ‹è®¾/å›æ”¶ï¼ˆå¦‚æœæœ‰ï¼‰

3. **ç»“å°¾**ï¼ˆ300-800å­—ï¼‰
   - æœ¬ç« é—®é¢˜è§£å†³/å‡çº§
   - å¼•å…¥ä¸‹ä¸€ç« æ‚¬å¿µ
   - æƒ…æ„ŸèŠ‚å¥çš„æ”¶å°¾

#### å¯¹è¯è¦æ±‚ï¼š

- **çœŸå®æ€§**ï¼šæ¯ä¸ªè§’è‰²è¯´è¯ç¬¦åˆå…¶æ€§æ ¼å’ŒèƒŒæ™¯
- **åŠŸèƒ½æ€§**ï¼šå¯¹è¯æ¨åŠ¨å‰§æƒ…æˆ–å±•ç°äººç‰©å…³ç³»
- **å±‚æ¬¡æ„Ÿ**ï¼šæœ‰æ˜è¯´ã€æš—ç¤ºã€æ½œå°è¯
- **é¿å…**ï¼šä¿¡æ¯å€¾å€’ã€ç›´ç™½è¡¨è¾¾ã€é™ˆè¯æ»¥è°ƒ

#### æå†™è¦æ±‚ï¼š

- **å…·è±¡åŒ–**ï¼šç”¨å…·ä½“ç»†èŠ‚ä»£æ›¿æŠ½è±¡æè¿°
- **æ„Ÿå®˜åŒ–**ï¼šè§†è§‰ã€å¬è§‰ã€è§¦è§‰ç­‰å¤šæ„Ÿå®˜
- **èŠ‚å¥åŒ–**ï¼šç´§å¼ åœºæ™¯å¿«èŠ‚å¥ï¼Œåæ€åœºæ™¯æ…¢èŠ‚å¥

---

### ğŸ¨ é£æ ¼æŒ‡å¯¼

"""

        # æ·»åŠ é£æ ¼æŒ‡å¯¼
        genre_guidance = self._get_genre_guidance(context, metadata)
        if genre_guidance:
            prompt += f"{genre_guidance}\n\n"

        # æ·»åŠ ä½œè€…é£æ ¼æŒ‡å¯¼
        author_style_guidance = self._get_author_style_guidance(metadata)
        if author_style_guidance:
            prompt += f"{author_style_guidance}\n\n"

        # æ·»åŠ èŒƒä¾‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        examples_text = await self._get_examples_text(context, metadata)
        if examples_text:
            prompt += f"{examples_text}\n"

        prompt += f"""---

### ğŸ“‹ è¾“å‡ºæ ¼å¼

è¯·ç›´æ¥è¾“å‡ºç¬¬{chapter_index}ç« çš„å®Œæ•´å†…å®¹ï¼š

```markdown
[æœ¬ç« å†…å®¹ï¼Œ3000-5000å­—]
```

âš ï¸ **ä¸éœ€è¦è¾“å‡ºç« èŠ‚æ ‡é¢˜**ï¼ˆå¦‚"ç¬¬1ç« ï¼šxxx"ï¼‰ï¼Œç›´æ¥è¾“å‡ºæ­£æ–‡å³å¯ï¼

---

### âš ï¸ æœ€åæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹å†™ä½œä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

1. âœ… æˆ‘å·²ç»ä»”ç»†é˜…è¯»äº†å®Œæ•´å¤§çº²
2. âœ… æˆ‘å·²ç»ç†è§£äº†äººç‰©è®¾è®¡ï¼ˆä¸»è§’åå­—ã€é…è§’åå­—ï¼‰
3. âœ… æˆ‘å·²ç»ç†è§£äº†ä¸–ç•Œè§‚è§„åˆ™
4. âœ… æˆ‘çŸ¥é“æœ¬ç« è¦å†™ä»€ä¹ˆå†…å®¹ï¼ˆæ¥è‡ªå¤§çº²çš„"ç« èŠ‚è§„åˆ’"ï¼‰
5. âœ… æˆ‘çŸ¥é“è¦åœ¨å“ªé‡ŒåŸ‹è®¾/å›æ”¶ä¼ç¬”
6. âœ… æˆ‘ä¼šä¿æŒäººç‰©åç§°ã€åœ°ç‚¹åç§°ã€ç»„ç»‡åç§°çš„ä¸€è‡´æ€§
7. âœ… {f'æˆ‘ä¼šç¡®ä¿æœ¬ç« è‡ªç„¶æ‰¿æ¥ç¬¬{chapter_index-1}ç« çš„ç»“å°¾' if not is_first_chapter else 'æˆ‘ä¼šå¼€ä¸ªå¥½å¤´ï¼Œè®¾ç½®å¥½æ•…äº‹åŸºè°ƒ'}
8. âœ… æˆ‘ä¼šç¡®ä¿å‰§æƒ…è¿è´¯ï¼Œä¸ä¼šå‰åçŸ›ç›¾

**ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆç¬¬{chapter_index}ç« å†…å®¹ï¼**
"""
        return prompt

    # âš ï¸ å·²ç§»é™¤ï¼šä½¿ç”¨ Qwen Long ç›´æ¥ç”Ÿæˆé«˜è´¨é‡å†…å®¹ï¼Œæ— éœ€å•ç‹¬æ¶¦è‰²æ­¥éª¤
    # def _build_chapter_polish_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
    #     """Build prompt for chapter polish"""
    #     chapter_index = metadata.get("chapter_index", 1)
    #     prompt = f"""## ä»»åŠ¡: ç¬¬{chapter_index}ç« æ¶¦è‰²
    #     ... (å®Œæ•´æ–¹æ³•å·²æ³¨é‡Š)
    #     """
    #     return prompt

    def _build_batch_chapter_generation_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for batch chapter generation (ä½¿ç”¨ qwen-long ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰ç« èŠ‚)"""
        chapter_count = metadata.get("chapter_count", 10)
        goal_style = metadata.get("goal_style", "ç§‘å¹»")

        prompt = f"""## ğŸ¯ ä»»åŠ¡: ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰ç« èŠ‚å†…å®¹ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

### ä½¿ç”¨ qwen-long çš„è¶…å¤§ä¸Šä¸‹æ–‡èƒ½åŠ›ï¼Œç¡®ä¿æ•´ä½“ä¸€è‡´æ€§ï¼

**ç›®æ ‡**: ç”Ÿæˆ {chapter_count} ç« å®Œæ•´å†…å®¹ï¼ˆæ¯ç«  3000-5000 å­—ï¼‰

---

### ğŸ“š å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰

#### 1ï¸âƒ£ å®Œæ•´å¤§çº²ï¼ˆæœ€é‡è¦çš„è“å›¾ï¼ï¼‰
"""

        # æ·»åŠ å®Œæ•´å¤§çº²
        for result in context.recent_results:
            if result["task_type"] == "å¤§çº²":
                prompt += f"""\n```markdown
{result['content']}
```\n"""
                break

        prompt += "\n#### 2ï¸âƒ£ äººç‰©è®¾è®¡ï¼ˆç¡®ä¿äººç‰©åç§°ä¸€è‡´ï¼ï¼‰\n\n"
        # æ·»åŠ äººç‰©è®¾è®¡
        for result in context.recent_results:
            if result["task_type"] == "äººç‰©è®¾è®¡":
                prompt += f"{result['content'][:2000]}...\n\n"
                break

        prompt += "\n#### 3ï¸âƒ£ ä¸–ç•Œè§‚è§„åˆ™ï¼ˆç¡®ä¿è®¾å®šä¸€è‡´ï¼ï¼‰\n\n"
        # æ·»åŠ ä¸–ç•Œè§‚
        for result in context.recent_results:
            if result["task_type"] == "ä¸–ç•Œè§‚è§„åˆ™":
                prompt += f"{result['content'][:1500]}...\n\n"
                break

        prompt += f"""

---

### âœ… åˆ›ä½œè¦æ±‚ï¼ˆä¸¥æ ¼éµå®ˆï¼ï¼‰

#### ğŸš¨ å…³é”®çº¦æŸ

1. **äººç‰©åç§°ä¸€è‡´æ€§**
   - ä¸»è§’åç§°å¿…é¡»ä»"äººç‰©è®¾è®¡"ä¸­æå–ï¼Œç»å¯¹ä¸è¦åˆ›é€ æ–°åå­—
   - é…è§’åç§°ä¹Ÿè¦ä¿æŒä¸€è‡´
   - ç»å¯¹ä¸è¦ä½¿ç”¨æ—é»˜ã€å¶å‡¡ã€è§ç‚ç­‰ä¿—å¥—åå­—

2. **å‰§æƒ…ä¸¥æ ¼éµå¾ªå¤§çº²**
   - æ¯ç« å¿…é¡»æŒ‰ç…§å¤§çº²ä¸­çš„"ç« èŠ‚è§„åˆ’"æ‰§è¡Œ
   - äº‹ä»¶å¿…é¡»æŒ‰ç…§"äº‹ä»¶é“¾"å‘ç”Ÿ
   - ä¼ç¬”å¿…é¡»åœ¨æŒ‡å®šç« èŠ‚åŸ‹è®¾/å›æ”¶

3. **ä¸–ç•Œè§‚ä¸€è‡´**
   - æ‰€æœ‰è®¾å®šå¿…é¡»éµå®ˆ"ä¸–ç•Œè§‚è§„åˆ™"
   - åŠ›é‡ä½“ç³»ã€åœ°ç‚¹åç§°ã€ç»„ç»‡åç§°å¿…é¡»ä¸€è‡´

4. **å­—æ•°æ§åˆ¶**
   - æ¯ç«  3000-5000 å­—
   - ä¸è¦å†™æˆæµæ°´è´¦
   - æ¯ç« è¦æœ‰ç‹¬ç«‹çš„å†…å®¹å’Œè¿›å±•

---

### ğŸ“ ç« èŠ‚å†…å®¹è¦æ±‚

#### æ¯ç« å¿…é¡»åŒ…å«ï¼š

1. **å¼€å¤´**ï¼ˆ200-500å­—ï¼‰
   - æ‰¿æ¥ä¸Šä¸€ç« ï¼ˆæˆ–å¼€åœºï¼‰
   - è®¾ç½®æœ¬ç« åŸºè°ƒ
   - å¼•å…¥æœ¬ç« æ ¸å¿ƒé—®é¢˜

2. **ä¸»ä½“**ï¼ˆ2000-3500å­—ï¼‰
   - 2-4 ä¸ªåœºæ™¯
   - äººç‰©å¯¹è¯ï¼ˆå 30-40%ï¼‰
   - è¡ŒåŠ¨æå†™
   - å¿ƒç†æ´»åŠ¨
   - ä¼ç¬”åŸ‹è®¾/å›æ”¶ï¼ˆå¦‚æœæœ‰ï¼‰

3. **ç»“å°¾**ï¼ˆ300-800å­—ï¼‰
   - æœ¬ç« é—®é¢˜è§£å†³/å‡çº§
   - å¼•å…¥ä¸‹ä¸€ç« æ‚¬å¿µ
   - æƒ…æ„ŸèŠ‚å¥çš„æ”¶å°¾

#### å¯¹è¯è¦æ±‚ï¼š

- **çœŸå®æ€§**ï¼šæ¯ä¸ªè§’è‰²è¯´è¯ç¬¦åˆå…¶æ€§æ ¼å’ŒèƒŒæ™¯
- **åŠŸèƒ½æ€§**ï¼šå¯¹è¯æ¨åŠ¨å‰§æƒ…æˆ–å±•ç°äººç‰©å…³ç³»
- **å±‚æ¬¡æ„Ÿ**ï¼šæœ‰æ˜è¯´ã€æš—ç¤ºã€æ½œå°è¯
- **é¿å…**ï¼šä¿¡æ¯å€¾å€’ã€ç›´ç™½è¡¨è¾¾ã€é™ˆè¯æ»¥è°ƒ

#### æå†™è¦æ±‚ï¼š

- **å…·è±¡åŒ–**ï¼šç”¨å…·ä½“ç»†èŠ‚ä»£æ›¿æŠ½è±¡æè¿°
- **æ„Ÿå®˜åŒ–**ï¼šè§†è§‰ã€å¬è§‰ã€è§¦è§‰ç­‰å¤šæ„Ÿå®˜
- **èŠ‚å¥åŒ–**ï¼šç´§å¼ åœºæ™¯å¿«èŠ‚å¥ï¼Œåæ€åœºæ™¯æ…¢èŠ‚å¥

---

### ğŸ¨ é£æ ¼æŒ‡å¯¼ï¼ˆ{goal_style}ç±»å‹ï¼‰

"""

        # æ·»åŠ é£æ ¼æŒ‡å¯¼
        genre_guidance = self._get_genre_guidance(context, metadata)
        if genre_guidance:
            prompt += f"{genre_guidance}\n\n"

        prompt += f"""---

### ğŸ“‹ è¾“å‡ºæ ¼å¼

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºæ‰€æœ‰ç« èŠ‚ï¼š

```markdown
# ç¬¬1ç« ï¼š[ç« èŠ‚æ ‡é¢˜]

[æœ¬ç« å†…å®¹ï¼Œ3000-5000å­—]

---

# ç¬¬2ç« ï¼š[ç« èŠ‚æ ‡é¢˜]

[æœ¬ç« å†…å®¹ï¼Œ3000-5000å­—]

---

# ç¬¬3ç« ï¼š[ç« èŠ‚æ ‡é¢˜]

[æœ¬ç« å†…å®¹ï¼Œ3000-5000å­—]

...

ï¼ˆå…±{chapter_count}ç« ï¼‰
```

---

### âš ï¸ æœ€åæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹å†™ä½œä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

1. âœ… æˆ‘å·²ç»ä»”ç»†é˜…è¯»äº†å®Œæ•´å¤§çº²
2. âœ… æˆ‘å·²ç»ç†è§£äº†äººç‰©è®¾è®¡ï¼ˆä¸»è§’åå­—ã€é…è§’åå­—ï¼‰
3. âœ… æˆ‘å·²ç»ç†è§£äº†ä¸–ç•Œè§‚è§„åˆ™
4. âœ… æˆ‘çŸ¥é“æ¯ç« è¦å†™ä»€ä¹ˆå†…å®¹ï¼ˆæ¥è‡ªå¤§çº²çš„"ç« èŠ‚è§„åˆ’"ï¼‰
5. âœ… æˆ‘çŸ¥é“è¦åœ¨å“ªé‡ŒåŸ‹è®¾/å›æ”¶ä¼ç¬”
6. âœ… æˆ‘ä¼šä¿æŒäººç‰©åç§°ã€åœ°ç‚¹åç§°ã€ç»„ç»‡åç§°çš„ä¸€è‡´æ€§
7. âœ… æˆ‘ä¼šç¡®ä¿å‰§æƒ…è¿è´¯ï¼Œä¸ä¼šå‰åçŸ›ç›¾

**ç°åœ¨ï¼Œè¯·å¼€å§‹ç”Ÿæˆæ‰€æœ‰ç« èŠ‚å†…å®¹ï¼**
"""
        return prompt



    def _build_evaluation_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for content evaluation"""
        chapter_index = metadata.get("chapter_index", 1)

        prompt = f"""## ä»»åŠ¡: ç¬¬{chapter_index}ç« è´¨é‡è¯„ä¼°

### ç« èŠ‚å†…å®¹
"""

        # Add chapter content
        for result in context.recent_results:
            if result.get("task_type") == "ç« èŠ‚æ¶¦è‰²" and result.get("chapter_index") == chapter_index:
                prompt += f"\n{result['content'][:3000]}\n"
                break

        prompt += """

### è¯„ä¼°ç»´åº¦

è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°ï¼ˆ0-100åˆ†ï¼‰:

1. **è¿è´¯æ€§**: é€»è¾‘æ˜¯å¦è¿è´¯
2. **åˆ›æ„æ€§**: å†…å®¹æ˜¯å¦æœ‰æ–°æ„
3. **æ–‡ç¬”è´¨é‡**: æ–‡å­—æ˜¯å¦ä¼˜ç¾
4. **ä¸€è‡´æ€§**: æ˜¯å¦ä¸å‰é¢è®¾å®šä¸€è‡´
5. **å¸å¼•åŠ›**: æ˜¯å¦å¸å¼•è¯»è€…ç»§ç»­é˜…è¯»

è¯·è¾“å‡ºJSONæ ¼å¼çš„è¯„ä¼°ç»“æœã€‚
"""
        return prompt

    def _build_revision_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for content revision"""
        chapter_index = metadata.get("chapter_index", 1)

        prompt = f"""## ä»»åŠ¡: ç¬¬{chapter_index}ç« ä¿®è®¢

### å½“å‰å†…å®¹
"""

        # Add chapter content
        for result in context.recent_results:
            if result.get("chapter_index") == chapter_index and result.get("task_type") in ["ç« èŠ‚æ¶¦è‰²", "è¯„ä¼°"]:
                prompt += f"\n{result['content'][:2000]}\n"
                break

        prompt += """

### è¯„ä¼°åé¦ˆ
"""

        # Add evaluation feedback
        for result in context.recent_results:
            if result.get("evaluation"):
                prompt += f"\n{result['evaluation'][:500]}\n"
                break

        prompt += """

### è¾“å‡ºè¦æ±‚

è¯·æ ¹æ®è¯„ä¼°åé¦ˆä¿®è®¢å†…å®¹ï¼Œè§£å†³å‘ç°çš„é—®é¢˜ã€‚
ä¿æŒåŸæœ‰ç»“æ„å’Œæƒ…èŠ‚ï¼Œä»…æ”¹è¿›éœ€è¦ä¿®æ­£çš„éƒ¨åˆ†ã€‚

è¯·ç›´æ¥è¾“å‡ºä¿®è®¢åçš„å†…å®¹ã€‚
"""
        return prompt

    def _build_generic_prompt(
        self,
        task_type: str,
        context: MemoryContext,
        metadata: Dict[str, Any],
    ) -> str:
        """Build generic prompt for unknown task types"""
        prompt = f"""## ä»»åŠ¡: {task_type}

### ç›¸å…³ä¸Šä¸‹æ–‡
"""

        # Add context
        for result in context.recent_results[:3]:
            prompt += f"\n{result['task_type']}: {result['content'][:200]}...\n"

        prompt += f"""

### å…ƒæ•°æ®
{metadata}

### è¾“å‡ºè¦æ±‚
è¯·å®Œæˆä»»åŠ¡ï¼Œç›´æ¥è¾“å‡ºç»“æœã€‚
"""
        return prompt

    def _build_brainstorm_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for creative brainstorm"""
        genre = metadata.get("goal_style") or metadata.get("genre", self.genre)
        goal_idea = metadata.get("goal_idea", "")

        # ğŸ”¥ æå–ä¸–ç•Œè§‚çº¦æŸï¼ˆæœä»£ã€æ—¶ä»£ã€è®¾å®šå…³é”®è¯ï¼‰
        worldview_constraints = []
        if goal_idea:
            # å¸¸è§æœä»£å’Œæ—¶ä»£å…³é”®è¯
            dynasty_keywords = {
                "å¤§å®‹": "å®‹æœï¼ˆ960-1279å¹´ï¼‰",
                "å®‹æœ": "å®‹æœï¼ˆ960-1279å¹´ï¼‰",
                "åŒ—å®‹": "åŒ—å®‹ï¼ˆ960-1127å¹´ï¼‰",
                "å—å®‹": "å—å®‹ï¼ˆ1127-1279å¹´ï¼‰",
                "å¤§å”": "å”æœï¼ˆ618-907å¹´ï¼‰",
                "å”æœ": "å”æœï¼ˆ618-907å¹´ï¼‰",
                "å¤§æ˜": "æ˜æœï¼ˆ1368-1644å¹´ï¼‰",
                "æ˜æœ": "æ˜æœï¼ˆ1368-1644å¹´ï¼‰",
                "å¤§æ¸…": "æ¸…æœï¼ˆ1644-1912å¹´ï¼‰",
                "æ¸…æœ": "æ¸…æœï¼ˆ1644-1912å¹´ï¼‰",
                "ç§¦æœ": "ç§¦æœï¼ˆå…¬å…ƒå‰221-206å¹´ï¼‰",
                "æ±‰æœ": "æ±‰æœï¼ˆå…¬å…ƒå‰202å¹´-å…¬å…ƒ220å¹´ï¼‰",
                "ä¸‰å›½": "ä¸‰å›½æ—¶æœŸï¼ˆ220-280å¹´ï¼‰",
                "éš‹æœ": "éš‹æœï¼ˆ581-618å¹´ï¼‰",
                "å…ƒæœ": "å…ƒæœï¼ˆ1271-1368å¹´ï¼‰",
            }

            for keyword, description in dynasty_keywords.items():
                if keyword in goal_idea:
                    worldview_constraints.append(f"â›” æ—¶ä»£é”å®šï¼š{description}ï¼Œä¸¥ç¦å‡ºç°å…¶ä»–æœä»£äººç‰©æˆ–äº‹ä»¶")
                    worldview_constraints.append(f"â›” ç¦æ­¢å‡ºç°å…¶ä»–æ—¶ä»£çš„äººç‰©ï¼ˆå¦‚{keyword}ä¸èƒ½å‡ºç°ç§¦å§‹çš‡ã€æä¸–æ°‘ã€æœ±å…ƒç’‹ç­‰ï¼‰")

            # ç°ä»£éƒ½å¸‚å…³é”®è¯
            modern_keywords = ["ç°ä»£", "éƒ½å¸‚", "2024", "21ä¸–çºª", "å½“ä»£"]
            if any(kw in goal_idea for kw in modern_keywords):
                worldview_constraints.append("â›” æ—¶ä»£é”å®šï¼šç°ä»£éƒ½å¸‚ï¼Œä¸¥ç¦å‡ºç°å¤ä»£äººç‰©æˆ–ç©¿è¶Šå…ƒç´ ")

            # ç©¿è¶Š/ç³»ç»Ÿè®¾å®š
            if "ç©¿è¶Š" in goal_idea or "ç³»ç»Ÿ" in goal_idea:
                if "ç©¿è¶Š" in goal_idea:
                    worldview_constraints.append("âœ“ å…è®¸ç©¿è¶Šè®¾å®šï¼Œä½†ç©¿è¶Šå‰åçš„æ—¶ä»£å¿…é¡»æ˜ç¡®åŒºåˆ†")
                if "ç³»ç»Ÿ" in goal_idea:
                    worldview_constraints.append("âœ“ å…è®¸ç³»ç»Ÿè®¾å®šï¼Œä½†ç³»ç»Ÿä¸èƒ½å‡­ç©ºæ”¹å˜ä¸–ç•Œè§‚è§„åˆ™")

        constraint_section = ""
        if worldview_constraints:
            constraint_section = "\n### ğŸš¨ ä¸–ç•Œè§‚çº¦æŸï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼ï¼‰\n\n" + "\n".join(f"- {c}" for c in worldview_constraints) + "\n"

        prompt = f"""## ä»»åŠ¡: åˆ›æ„è„‘æš´

### å°è¯´ç±»å‹
{genre}

### åˆ›æ„æ–¹å‘
{goal_idea if goal_idea else "è¯·è‡ªç”±å‘æŒ¥åˆ›æ„"}
{constraint_section}
### âš ï¸ é‡è¦è¦æ±‚ï¼šé¿å…é›·åŒï¼

**åŠ¡å¿…åˆ›æ–°**ï¼š
- é¿å…ä½¿ç”¨å¸¸è§çš„å¥—è·¯å’Œä¿—å¥—æƒ…èŠ‚
- æ‹’ç»é™ˆè¯æ»¥è°ƒï¼šä¸è¦"åºŸæŸ´é€†è¢­"ã€"é€€å©šæµ"ç­‰è€å¥—è·¯
- åˆ›é€ ç‹¬ç‰¹çš„è®¾å®šå’Œå†²çª
- æ¯ä¸ªç‚¹å­éƒ½è¦æœ‰è‡ªå·±çš„"çµé­‚"

**è¿½æ±‚å·®å¼‚åŒ–**ï¼š
- ğŸ”„ å¦‚æœçœ‹åˆ°3ä¸ªä»¥ä¸Šç‚¹å­é£æ ¼ç›¸ä¼¼ï¼Œè¯·é‡æ–°æ„æ€
- ğŸ­ äººç‰©åŠ¨æœºè¦å¤æ‚ï¼Œéé»‘å³ç™½çš„äººç‰©ä¸å¤Ÿæœ‰è¶£
- âš¡ å†²çªè¦æ–°é¢–ï¼Œä¸è¦åƒç¯‡ä¸€å¾‹çš„"å¤ä»‡"æˆ–"æ‰“è„¸"
- ğŸ’« æƒ…æ„Ÿé’©å­è¦ç‹¬ç‰¹ï¼Œè®©è¯»è€…äº§ç”Ÿæ–°çš„æƒ…æ„Ÿä½“éªŒ

### è¾“å‡ºè¦æ±‚

è¯·äº§ç”Ÿ **3-5 ä¸ªå®Œå…¨ä¸åŒ** çš„æ•…äº‹ç‚¹å­ï¼Œæ¯ä¸ªç‚¹å­åŒ…æ‹¬ï¼š

**ç‚¹å­ 1 / ç‚¹å­ 2 / ...**
1. **æ ¸å¿ƒæ¦‚å¿µ** (ä¸€å¥è¯æ¦‚æ‹¬)
2. **ç‹¬ç‰¹å–ç‚¹** (ä¸ºä»€ä¹ˆè¿™ä¸ªåˆ›æ„ä¸ä¼—ä¸åŒï¼Ÿ)
3. **æ ¸å¿ƒå†²çª** (ä¸»è§’æƒ³è¦ä»€ä¹ˆï¼Ÿä»€ä¹ˆåœ¨é˜»æ­¢ä»–ï¼Ÿ)
4. **æƒ…æ„Ÿé’©å­** (è¯»è€…ä¸ºä»€ä¹ˆä¼šå…³å¿ƒï¼Ÿ)
5. **ä¸–ç•Œè§‚äº®ç‚¹** (å¦‚æœé€‚ç”¨ï¼Œç®€è¦è¯´æ˜ç‹¬ç‰¹çš„è®¾å®šå…ƒç´ )

è¯·ç¡®ä¿æ¯ä¸ªç‚¹å­éƒ½æœ‰é²œæ˜çš„ä¸ªæ€§ï¼Œä¸è¦é›·åŒï¼
"""
        return prompt

    def _build_story_core_prompt(self, context: MemoryContext, metadata: Dict[str, Any]) -> str:
        """Build prompt for story core definition"""
        prompt = """## ä»»åŠ¡: ç¡®å®šæ•…äº‹æ ¸å¿ƒ

### åˆ›æ„è„‘æš´ç»“æœ
"""

        # Add brainstorm result
        for result in context.recent_results:
            if result["task_type"] == "åˆ›æ„è„‘æš´":
                prompt += f"\n{result['content'][:1000]}...\n"
                break

        prompt += """

### è¾“å‡ºè¦æ±‚

ä»ä¸Šé¢çš„åˆ›æ„ç‚¹å­ä¸­é€‰æ‹©ä¸€ä¸ªæœ€æœ‰æ½œåŠ›çš„ï¼Œç¡®å®šæ•…äº‹æ ¸å¿ƒã€‚

**æ•…äº‹æ ¸å¿ƒå¿…é¡»åŒ…å«**ï¼š

1. **ä¸»è§’æ˜¯è°ï¼Ÿ**
   - å§“åï¼ˆé¿å…å¸¸è§åå­—å¦‚æ—é»˜ã€å¶å‡¡ã€è§ç‚ç­‰ï¼‰
   - åˆå§‹çŠ¶æ€ï¼ˆå¹³å‡¡/ç‰¹æ®Š/å›°å¢ƒï¼‰

2. **ä¸»è§’æƒ³è¦ä»€ä¹ˆï¼Ÿ** (å¤–åœ¨ç›®æ ‡)
   - æ˜ç¡®çš„ç›®æ ‡

3. **ä»€ä¹ˆåœ¨é˜»æ­¢ä»–ï¼Ÿ** (æ ¸å¿ƒå†²çª)
   - å†…åœ¨é˜»ç¢
   - å¤–åœ¨é˜»ç¢

4. **ä¸ºä»€ä¹ˆè¯»è€…ä¼šåœ¨æ„ï¼Ÿ** (æƒ…æ„Ÿé’©å­)
   - æ™®ä¸–çš„æƒ…æ„Ÿéœ€æ±‚

5. **ä¸€å¥è¯æ¦‚æ‹¬**
   - æ ¼å¼ï¼š[ä¸»è§’] + [æƒ³è¦] + [ä½†] + [æ‰€ä»¥] + [æœ€ç»ˆ]

âš ï¸ **é¿å…é›·åŒ**ï¼š
- ä¸»è§’åå­—è¦ç‹¬ç‰¹ï¼Œé¿å…ä½¿ç”¨å¸¸è§ç½‘æ–‡ä¸»è§’å
- æ ¸å¿ƒå†²çªè¦æ–°é¢–ï¼Œä¸è¦åƒç¯‡ä¸€å¾‹
- ç¡®ä¿è¿™ä¸ªæ•…äº‹ä¹‹å‰æ²¡äººè®²è¿‡

è¯·ç›´æ¥è¾“å‡ºæ•…äº‹æ ¸å¿ƒï¼Œä¸éœ€è¦å…¶ä»–å†…å®¹ã€‚
"""
        return prompt
