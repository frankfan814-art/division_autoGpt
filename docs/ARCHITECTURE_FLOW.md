# Creative AutoGPT 完整架构流程图

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端层 (React + TypeScript)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  会话列表页   │  │  会话详情页   │  │  创作工作台   │  │  实时进度显示  │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │              HTTP/WebSocket 通信 (axios + WebSocket)                 │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API 路由层 (FastAPI)                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  /sessions 路由                                                        │  │
│  │  ├── POST   /sessions           → 创建新会话                          │  │
│  │  ├── GET    /sessions           → 获取会话列表                        │  │
│  │  ├── GET    /sessions/{id}      → 获取会话详情                        │  │
│  │  ├── PUT    /sessions/{id}      → 更新会话                            │  │
│  │  ├── DELETE /sessions/{id}      → 删除会话                            │  │
│  │  ├── POST   /sessions/{id}/export → 导出小说                         │  │
│  │  └── GET    /sessions/{id}/progress → 获取进度                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  /ws WebSocket 路由                                                    │  │
│  │  ├── subscribe   → 订阅会话事件                                       │  │
│  │  ├── start       → 开始执行                                           │  │
│  │  ├── pause       → 暂停执行                                           │  │
│  │  ├── resume      → 恢复执行                                           │  │
│  │  ├── stop        → 停止执行                                           │  │
│  │  └── feedback    → 提交用户反馈                                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           核心业务逻辑层                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  EngineRegistry (引擎注册表 - 单例模式)                               │  │
│  │  ├── register(session_id, engine)    → 注册运行中的引擎              │  │
│  │  ├── get(session_id)                → 获取引擎实例                   │  │
│  │  ├── pause(session_id)              → 暂停引擎                       │  │
│  │  ├── resume(session_id)             → 恢复引擎                       │  │
│  │  ├── stop(session_id)               → 停止引擎                       │  │
│  │  └── cleanup()                      → 清理完成的引擎                 │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                              │                             │
│                                              ▼                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  LoopEngine (循环执行引擎)                                            │  │
│  │  ├── run()                          → 主执行循环                     │  │
│  │  ├── pause()                        → 暂停执行                       │  │
│  │  ├── resume()                       → 恢复执行                       │  │
│  │  ├── stop()                         → 停止执行                       │  │
│  │  └── _execute_task()                → 执行单个任务                   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                              │                             │
│         ┌─────────────────────────────────┼─────────────────────────┐      │
│         ▼                                 ▼                         ▼      │
│  ┌──────────────┐              ┌──────────────┐          ┌──────────────┐  │
│  │ TaskPlanner  │              │EvaluationEngine│         │VectorMemory  │  │
│  │  任务规划器   │              │   评估引擎     │          │   管理器     │  │
│  └──────────────┘              └──────────────┘          └──────────────┘  │
│         │                                 │                         │      │
│  ┌──────────────┐              ┌──────────────┐          ┌──────────────┐  │
│  │  NovelMode   │              │MultiLLMClient│          │ PluginSystem │  │
│  │  小说模式     │              │   LLM客户端    │          │  插件系统    │  │
│  └──────────────┘              └──────────────┘          └──────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                              │
         ┌──────────────────────────────────┼──────────────────────────┐
         ▼                                  ▼                          ▼
┌──────────────────┐              ┌──────────────────┐      ┌──────────────────┐
│  PostgreSQL/     │              │    ChromaDB      │      │  文件系统         │
│  SQLite 数据库   │              │   向量数据库      │      │  FileStore       │
│  SessionStorage  │              │   VectorStore    │      │                  │
└──────────────────┘              └──────────────────┘      └──────────────────┘
```

## 2. 创建会话流程

```
用户操作
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  前端：点击"创建会话"按钮                                     │
│  输入：title, goal, config                                   │
└─────────────────────────────────────────────────────────────┘
   │
   │ POST /sessions
   │ Body: { title: "小说名", goal: {...}, config: {...} }
   ▼
┌─────────────────────────────────────────────────────────────┐
│  FastAPI: sessions.py - create_session()                    │
│  1. 验证输入数据                                             │
│  2. 生成唯一的 session_id (UUID)                            │
│  3. 调用 SessionStorage.create_session()                    │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  SessionStorage.create_session()                            │
│  1. 创建 SessionModel 对象                                  │
│  2. 生成 SQL: INSERT INTO sessions                          │
│  3. 执行异步数据库操作                                       │
│  4. 返回 session_id                                         │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  PostgreSQL/SQLite                                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ INSERT INTO sessions (id, title, mode, status, ...)  │  │
│  │ VALUES ('uuid-xxx', '小说名', 'novel', 'created', ...)│  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
返回 session_id 给前端
   │
   ▼
前端跳转到会话详情页面
```

## 3. 开始执行流程

```
用户操作
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  前端：点击"开始创作"按钮                                     │
│  建立 WebSocket 连接                                        │
└─────────────────────────────────────────────────────────────┘
   │
   │ WebSocket: ws://host/ws/ws
   │ 发送消息: { "event": "start", "session_id": "xxx" }
   ▼
┌─────────────────────────────────────────────────────────────┐
│  FastAPI: websocket.py - websocket_endpoint()               │
│  1. 验证 session_id                                         │
│  2. 调用 start_session_execution()                          │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  start_session_execution()                                  │
│  1. 从数据库获取会话信息                                     │
│  2. 创建 LoopEngine 实例                                    │
│  3. 注册到 EngineRegistry                                   │
│  4. 启动后台任务: asyncio.create_task(engine.run())         │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  EngineRegistry.register(session_id, engine)                │
│  存储: running_engines[session_id] = engine                 │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  LoopEngine.run() - 主执行循环                              │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  while has_more_tasks():                             │  │
│  │      1. 获取下一个任务                                │  │
│  │      2. 构建提示词                                    │  │
│  │      3. 调用 LLM                                      │  │
│  │      4. 评估质量                                      │  │
│  │      5. 如果分数 < 0.8，重写                          │  │
│  │      6. 存储结果                                      │  │
│  │      7. 推送进度                                      │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 4. 单个任务执行流程

```
LoopEngine._execute_task(task)
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 获取任务上下文                                           │
│  VectorMemoryManager.retrieve(context, task_type)            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  根据任务类型，从 ChromaDB 检索相关内容:              │  │
│  │  - 人物设计 → 检索 character、worldview               │  │
│  │  - 章节内容 → 检索 chapter、outline、character        │  │
│  │  - 场景生成 → 检索 scene、worldview                   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 构建提示词                                               │
│  NovelMode.get_prompt(task, context, metadata)              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  提示词结构:                                          │  │
│  │  - 任务描述                                           │  │
│  │  - 创作目标                                           │  │
│  │  - 相关上下文 (从向量库检索)                           │  │
│  │  - 输出格式要求                                       │  │
│  │  - 高分示例 (如果有)                                  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 调用 LLM 生成内容                                        │
│  MultiLLMClient.generate(prompt, task_type)                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  LLM 路由:                                            │  │
│  │  - 大纲/世界观/人物 → Qwen (长上下文)                 │  │
│  │  - 事件/场景/评估 → DeepSeek (强逻辑)                 │  │
│  │  - 章节内容/润色 → Doubao (文学创作)                  │  │
│  └───────────────────────────────────────────────────────┘  │
│         │                                                     │
│         ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  API 调用:                                            │  │
│  │  POST https://dashscope.aliyuncs.com/api/v1/services │  │
│  │  Headers: Authorization: Bearer sk-xxx                │  │
│  │  Body: { model: "qwen-long", input: { prompt: ...} } │  │
│  └───────────────────────────────────────────────────────┘  │
│         │                                                     │
│         ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  返回: { output: { text: "生成的内容..." } }          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 评估质量                                                 │
│  EvaluationEngine.evaluate(task_type, content, context)      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  构建评估提示词:                                       │  │
│  │  - 文学质量评分 (故事性、人物、文笔、可读性...)        │  │
│  │  - 逻辑一致性检查 (人物一致性、世界观一致性...)        │  │
│  └───────────────────────────────────────────────────────┘  │
│         │                                                     │
│         ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  调用 LLM 评估 (使用 DeepSeek)                        │  │
│  └───────────────────────────────────────────────────────┘  │
│         │                                                     │
│         ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  解析评估结果:                                         │  │
│  │  - quality_score: 7.5/10                              │  │
│  │  - consistency_score: 8.2/10                          │  │
│  │  - quality_issues: [...]                              │  │
│  │  - consistency_issues: [...]                          │  │
│  │  - passed: false (质量 < 8.0)                         │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
   │
   │ passed = quality_score >= 0.8 and consistency_score >= 0.8
   │
   ├─── FALSE (未通过) ──────────────────────────────────────┐
   │                                                           │
   ▼                                                           │
┌─────────────────────────────────────────────────────────────┐
│  5. 重写内容                                                 │
│  _attempt_rewrite(content, evaluation)                       │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  构建重写提示词:                                       │  │
│  │  - 原始内容                                           │  │
│  │  - 评估反馈 (质量问题、一致性问题)                     │  │
│  │  - 修改建议                                           │  │
│  │  - 通过标准 (需要 >= 8.0/10)                          │  │
│  └───────────────────────────────────────────────────────┘  │
│         │                                                     │
│         ▼                                                     │
│  重新调用 LLM 生成 → 返回步骤 4                               │
│  (最多重试 999 次，直到通过为止)                              │
└─────────────────────────────────────────────────────────────┘
   │
   │
   │
   ├─── TRUE (通过) ───────────────────────────────────────┐
   │                                                          │
   ▼                                                          ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 存储结果                                                 │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  6.1 存储到 PostgreSQL/SQLite                          │  │
│  │  SessionStorage.save_task_result()                    │  │
│  │  INSERT INTO task_results (                           │  │
│  │    session_id, task_id, task_type, result,            │  │
│  │    evaluation, chapter_index, ...                     │  │
│  │  )                                                    │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  6.2 存储到 ChromaDB 向量数据库                        │  │
│  │  VectorMemoryManager.store()                          │  │
│  │  - 生成文本嵌入 (sentence-transformers)               │  │
│  │  - 存储到对应类型的集合                                │  │
│  │  - 元数据: session_id, task_id, chapter_index        │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  6.3 保存到文件系统 (如果是章节)                       │  │
│  │  FileStore.save_chapter()                             │  │
│  │  ./data/sessions/{session_id}/chapters/001.txt        │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────────────┐
│  7. 推送进度到前端                                           │
│  WebSocket.send({                                           │
│    "event": "task_completed",                               │
│    "data": {                                                │
│      "task_id": "xxx",                                      │
│      "task_type": "章节内容",                               │
│      "status": "completed",                                 │
│      "evaluation": {                                        │
│        "quality_score": 8.5,                                │
│        "consistency_score": 8.2                             │
│      }                                                      │
│    }                                                        │
│  })                                                         │
└─────────────────────────────────────────────────────────────┘
   │
   ▼
继续执行下一个任务
```

## 5. 数据库调用关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         数据库调用关系                               │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ PostgreSQL/SQLite 数据库                                            │
│ 文件: ./data/creative_autogpt.db                                   │
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐  │
│ │ sessions 表                                                    │  │
│ │ ├── id (VARCHAR, PK)                                          │  │
│ │ ├── title (VARCHAR)                                           │  │
│ │ ├── mode (VARCHAR)                                            │  │
│ │ ├── status (VARCHAR)  ← created/running/paused/completed      │  │
│ │ ├── goal (JSON)       ← 创作目标配置                          │  │
│ │ ├── config (JSON)    ← 会话配置                              │  │
│ │ ├── created_at (DATETIME)                                     │  │
│ │ ├── updated_at (DATETIME)                                     │  │
│ │ ├── total_tasks (INT)                                         │  │
│ │ ├── completed_tasks (INT)                                     │  │
│ │ ├── engine_state (JSON) ← 引擎状态(用于恢复)                  │  │
│ │ └── current_task_index (INT) ← 当前任务索引                   │  │
│ └───────────────────────────────────────────────────────────────┘  │
│         ▲                                                         │
│         │                                                         │
│         │ SessionStorage.create_session()                        │
│         │ SessionStorage.get_session()                           │
│         │ SessionStorage.update_session()                        │
│         │ SessionStorage.update_progress()                       │
│         │                                                         │
│ ┌───────────────────────────────────────────────────────────────┐  │
│ │ task_results 表                                               │  │
│ │ ├── id (VARCHAR, PK)                                          │  │
│ │ ├── session_id (VARCHAR, FK)                                  │  │
│ │ ├── task_id (VARCHAR)                                         │  │
│ │ ├── task_type (VARCHAR) ← 大纲/人物/章节/场景...              │  │
│ │ ├── status (VARCHAR)    ← pending/completed/failed           │  │
│ │ ├── result (TEXT)      ← 任务结果内容                        │  │
│ │ ├── evaluation (JSON)  ← {quality_score, consistency_score}  │  │
│ │ ├── chapter_index (INT) ← 章节索引(如果是章节任务)           │  │
│ │ └── created_at (DATETIME)                                     │  │
│ └───────────────────────────────────────────────────────────────┘  │
│         ▲                                                         │
│         │                                                         │
│         │ SessionStorage.save_task_result()                      │
│         │ SessionStorage.get_task_results()                      │
│         │ SessionStorage.get_session_progress()                  │
│         │                                                         │
└─────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│ ChromaDB 向量数据库                                                 │
│ 目录: ./data/chroma                                                 │
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐  │
│ │ creative_autogpt collection (集合)                            │  │
│ │                                                               │  │
│ │ 每个 document 包含:                                            │  │
│ │ ├── id: 唯一标识符                                            │  │
│ │ ├── content: 文本内容                                         │  │
│ │ ├── memory_type: 记忆类型                                     │  │
│ │ │   ├── CHARACTER    - 人物记忆                               │  │
│ │ │   ├── PLOT         - 情节记忆                               │  │
│ │ │   ├── WORLDVIEW    - 世界观记忆                             │  │
│ │ │   ├── FORESHADOW   - 伏笔记忆                               │  │
│ │ │   ├── SCENE        - 场景记忆                               │  │
│ │ │   ├── CHAPTER      - 章节记忆                               │  │
│ │ │   ├── OUTLINE      - 大纲记忆                               │  │
│ │ │   └── GENERAL      - 通用记忆                               │  │
│ │ ├── metadata: {                                                 │  │
│ │ │   ├── session_id: "xxx"                                     │  │
│ │ │   ├── task_id: "xxx"                                        │  │
│ │ │   ├── chapter_index: 1                                      │  │
│ │ │   └── task_type: "章节内容"                                 │  │
│ │ ├── embedding: [0.123, 0.456, ...] (1536维向量)               │  │
│ │ └── created_at: "2024-01-01T00:00:00Z"                        │  │
│ └───────────────────────────────────────────────────────────────┘  │
│         ▲                                                         │
│         │                                                         │
│         │ VectorStore.add()                                      │
│         │ VectorStore.search()                                   │
│         │ VectorStore.get_by_memory_type()                       │
│         │ VectorStore.delete_by_session()                        │
│         │                                                         │
└─────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│ 文件系统                                                            │
│ 目录: ./data/sessions                                               │
│                                                                     │
│ ./data/sessions/{session_id}/                                       │
│ ├── chapters/                                                      │
│ │   ├── 001_章节名.txt                                             │
│ │   ├── 002_章节名.txt                                             │
│ │   └── ...                                                       │
│ ├── exports/                                                       │
│ │   ├── full_novel.txt                                             │
│ │   ├── full_novel.json                                            │
│ │   └── full_novel.md                                              │
│ └── backups/                                                       │
│     └── ...                                                       │
│                                                                     │
│         ▲                                                         │
│         │                                                         │
│         │ FileStore.save_chapter()                                │
│         │ FileStore.save_full_novel()                             │
│         │ FileStore.export_session()                              │
│         │                                                         │
└─────────────────────────────────────────────────────────────────────┘
```

## 6. 任务依赖流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        任务依赖关系 (DAG)                            │
│                                                                     │
│  Phase 0: 创意脑暴                                                  │
│  ┌──────────────┐                                                  │
│  │  创意脑暴    │ → (无依赖)                                       │
│  └──────────────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  ┌──────────────┐                                                  │
│  │   故事核心   │ ← 依赖: 创意脑暴                                │
│  └──────────────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  Phase 1: 大纲设计 (结构优先)                                      │
│  ┌──────────────┐                                                  │
│  │     大纲     │ ← 依赖: 故事核心                                │
│  └──────────────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  Phase 2: 世界观规则 (在人物之前!)                                  │
│  ┌──────────────┐                                                  │
│  │  世界观规则   │ ← 依赖: 故事核心 + 大纲                         │
│  └──────────────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  Phase 3: 人物设计                                                  │
│  ┌──────────────┐                                                  │
│  │   人物设计    │ ← 依赖: 故事核心 + 大纲 + 世界观                │
│  └──────────────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  Phase 4: 主题与风格                                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  主题确认    │  │  风格元素     │  │  市场定位     │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│         ↑                  ↑                ↑                      │
│         └──────────────────┴────────────────┘                      │
│          依赖: 故事核心 + 大纲 + 世界观 + 人物                      │
│                           │                                        │
│                           ▼                                        │
│  Phase 5: 细节填充                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │    事件      │  │场景物品冲突   │  │  伏笔列表     │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│         ↑                  ↑                ↑                      │
│         └──────────────────┴────────────────┘                      │
│          依赖: 所有前置任务                                          │
│                           │                                        │
│                           ▼                                        │
│  Phase 6: 章节创作 (动态生成)                                       │
│  ┌──────────────────────────────────────────────────┐             │
│  │                                                  │             │
│  │  ┌──────────────┐     ┌──────────────┐          │             │
│  │  │  第1章大纲   │ →   │ 第1章场景生成 │ → ...     │             │
│  │  └──────────────┘     └──────────────┘          │             │
│  │         │                     │                 │             │
│  │         ▼                     ▼                 │             │
│  │  ┌──────────────┐     ┌──────────────┐          │             │
│  │  │ 第1章内容生成 │ →   │ 第1章润色     │ → ...     │             │
│  │  └──────────────┘     └──────────────┘          │             │
│  │         │                                        │             │
│  │         ▼                                        │             │
│  │  ┌──────────────┐     ┌──────────────┐          │             │
│  │  │  第2章大纲   │ →   │ 第2章...      │          │             │
│  │  └──────────────┘     └──────────────┘          │             │
│  │         │                                        │             │
│  │         ...                                      │             │
│  │                                                  │             │
│  │  依赖: 所有基础设定 + 风格元素 + 上一章内容        │             │
│  └──────────────────────────────────────────────────┘             │
│                                                                     │
│  注: 一致性检查已合并到评估任务中                                   │
└─────────────────────────────────────────────────────────────────────┘
```

## 7. API 端点完整列表

```
┌─────────────────────────────────────────────────────────────────────┐
│                          HTTP API 端点                               │
└─────────────────────────────────────────────────────────────────────┘

Sessions API (基路径: /api/sessions)
┌────────────────────────────────────────────────────────────────────┐
│ POST   /api/sessions                                创建新会话      │
│ GET    /api/sessions                                获取会话列表    │
│ GET    /api/sessions/{id}                           获取会话详情    │
│ PUT    /api/sessions/{id}                           更新会话        │
│ DELETE /api/sessions/{id}                           删除会话        │
│ GET    /api/sessions/{id}/progress                  获取执行进度    │
│ POST   /api/sessions/{id}/export                    导出小说        │
│ POST   /api/sessions/{id}/restore                   恢复会话        │
└────────────────────────────────────────────────────────────────────┘

WebSocket API (端点: /api/ws/ws)
┌────────────────────────────────────────────────────────────────────┐
│ 事件: subscribe                                   订阅会话事件      │
│ 事件: start                                       开始执行          │
│ 事件: pause                                       暂停执行          │
│ 事件: resume                                      恢复执行          │
│ 事件: stop                                        停止执行          │
│ 事件: feedback                                    提交用户反馈      │
│ 事件: preview                                     预览任务结果      │
└────────────────────────────────────────────────────────────────────┘

Prompts API (基路径: /api/prompts)
┌────────────────────────────────────────────────────────────────────┐
│ GET    /api/prompts                                 获取提示词列表  │
│ GET    /api/prompts/{id}                            获取提示词详情  │
│ PUT    /api/prompts/{id}                            更新提示词      │
└────────────────────────────────────────────────────────────────────┘
```

## 8. 配置文件说明

```
┌─────────────────────────────────────────────────────────────────────┐
│                        .env 配置文件                                │
└─────────────────────────────────────────────────────────────────────┘

# 数据库配置
DATABASE_URL=sqlite+aiosqlite:///./data/creative_autogpt.db
# 或使用 PostgreSQL:
# DATABASE_URL=postgresql+asyncpg://user:password@localhost/creative_autogpt

# ChromaDB 向量数据库
CHROMA_PERSIST_DIRECTORY=./data/chroma
CHROMA_COLLECTION_NAME=creative_autogpt

# 本地文件存储路径
LOCAL_STORAGE_PATH=./data/sessions

# LLM API 密钥
ALIYUN_API_KEY=sk-xxx                    # 阿里云 Qwen
DEEPSEEK_API_KEY=sk-xxx                  # DeepSeek
ARK_API_KEY=sk-xxx                       # 字节跳动 Doubao

# API 配置
API_HOST=0.0.0.0
API_PORT=8000
CORS_ORIGINS=http://localhost:3000

# 评估配置
QUALITY_THRESHOLD=0.8                    # 质量阈值 (80分)
CONSISTENCY_THRESHOLD=0.8                # 一致性阈值 (80分)
MAX_REWRITE_ATTEMPTS=999                 # 最大重写次数
```

## 9. 关键数据结构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      EvaluationResult (评估结果)                     │
└─────────────────────────────────────────────────────────────────────┘
{
  "passed": true/false,                    // 是否通过 (两分数都 >= 0.8)
  "score": 0.85,                           // 总体评分 (平均分)
  "quality_score": 0.82,                   // 文学质量评分 (0-1)
  "consistency_score": 0.88,               // 逻辑一致性评分 (0-1)
  "dimension_scores": {                    // 各维度评分
    "故事性": { "score": 8.5, "reason": "...", "suggestions": [...] },
    "人物": { "score": 8.0, "reason": "...", "suggestions": [...] },
    "文笔": { "score": 8.2, "reason": "...", "suggestions": [...] }
  },
  "reasons": [...],                        // 评价原因
  "suggestions": [...],                    // 改进建议
  "quality_issues": [...],                 // 质量问题列表
  "consistency_issues": [...],             // 一致性问题列表
  "evaluated_at": "2024-01-01T00:00:00Z",
  "evaluator": "llm_new_format"
}

┌─────────────────────────────────────────────────────────────────────┐
│                         Task (任务)                                  │
└─────────────────────────────────────────────────────────────────────┘
{
  "task_id": "uuid-xxx",
  "task_type": "章节内容",                 // 任务类型
  "description": "...",
  "dependencies": ["大纲", "人物设计"],     // 依赖的任务
  "status": "pending/completed/failed",
  "metadata": {
    "chapter_index": 1,
    "scene_index": 1
  }
}

┌─────────────────────────────────────────────────────────────────────┐
│                       Session (会话)                                 │
└─────────────────────────────────────────────────────────────────────┘
{
  "id": "uuid-xxx",
  "title": "小说标题",
  "mode": "novel",
  "status": "running",
  "goal": {
    "genre": "科幻",
    "chapter_count": 50,
    "target_words": 100000
  },
  "config": {
    "approval_mode": false,
    "auto_save": true
  },
  "progress": {
    "total_tasks": 120,
    "completed_tasks": 45,
    "failed_tasks": 2,
    "current_task": "章节内容"
  }
}
```

---

**文档生成时间**: 2024-01-25
**项目**: Creative AutoGPT
**版本**: 1.0.0
