# 架构总览

> Creative AutoGPT - 专注于长篇创意写作的 AI Agent 系统

## 1. 项目愿景

构建一个**可扩展、逻辑清晰**的长篇网络小说创作系统，具备：
- ✅ 支持 10-500 万字长篇小说
- ✅ 多大模型智能分工协作
- ✅ 插件化的元素管理系统
- ✅ 智能上下文与一致性保障

## 2. 系统架构图

```
                                    ┌──────────────────┐
                                    │    Frontend      │
                                    │   (React/TS)     │
                                    └────────┬─────────┘
                                             │ HTTP/WebSocket
                                             ▼
┌────────────────────────────────────────────────────────────────────────┐
│                            Server (FastAPI)                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ SessionMgr  │  │ TaskAPI     │  │ StreamAPI   │  │ ExportAPI   │   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │
└─────────┼────────────────┼────────────────┼────────────────┼───────────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
┌────────────────────────────────────────────────────────────────────────┐
│                          LoopEngine (核心执行引擎)                       │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │                         执行循环                                  │ │
│  │  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐      │ │
│  │  │TaskQueue │──▶│ Execute  │──▶│ Evaluate │──▶│ Rewrite? │      │ │
│  │  │ 任务队列  │   │ 执行任务  │   │ 评估质量  │   │ 需重写?  │      │ │
│  │  └──────────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘      │ │
│  │                      │              │              │             │ │
│  │                      ▼              ▼              ▼             │ │
│  │              ┌─────────────────────────────────────────┐        │ │
│  │              │           Memory (存储结果)              │        │ │
│  │              └─────────────────────────────────────────┘        │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐          │
│  │  TaskPlanner   │  │ VectorMemory   │  │  Evaluator     │          │
│  │  任务规划器     │  │ 向量记忆        │  │  质量评估器     │          │
│  └────────────────┘  └────────────────┘  └────────────────┘          │
│                                                                        │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐          │
│  │PluginManager  │  │ PromptManager  │  │ MultiLLMClient │          │
│  │ 插件管理器     │  │ 提示词管理      │  │ 多模型客户端    │          │
│  └────────────────┘  └────────────────┘  └────────────────┘          │
└────────────────────────────────────────────────────────────────────────┘
          │                                         │
          ▼                                         ▼
┌─────────────────────────┐          ┌─────────────────────────────────┐
│     Plugin System       │          │       LLM Providers              │
│  ┌───────┐ ┌───────┐   │          │  ┌───────┐ ┌───────┐ ┌───────┐ │
│  │人物   │ │世界观 │   │          │  │ Qwen  │ │DeepSk │ │Doubao │ │
│  │插件   │ │插件   │   │          │  │       │ │       │ │       │ │
│  └───────┘ └───────┘   │          │  └───────┘ └───────┘ └───────┘ │
│  ┌───────┐ ┌───────┐   │          │  总览记忆   逻辑结构   创意文笔  │
│  │事件   │ │伏笔   │   │          │                                  │
│  │插件   │ │插件   │   │          └─────────────────────────────────┘
│  └───────┘ └───────┘   │
└─────────────────────────┘
```

## 3. 核心设计原则

### 3.1 分层架构

| 层级 | 职责 | 组件 |
|------|------|------|
| **表现层** | 用户交互 | Frontend (React)、REST API |
| **应用层** | 业务逻辑 | LoopEngine、TaskPlanner |
| **领域层** | 核心领域模型 | Plugin System、Memory |
| **基础设施层** | 技术实现 | LLM Client、Storage |

### 3.2 核心设计模式

1. **Agent Loop 模式**（来自 AutoGPT）
   - Think → Plan → Execute → Evaluate → Memory
   
2. **Pipeline 模式**
   - 任务按依赖关系形成 DAG 执行

3. **Plugin 模式**
   - 元素管理可插拔，按需加载

4. **Strategy 模式**
   - 不同任务路由到不同 LLM

## 4. 长篇小说支持能力

### 4.1 规模支持

| 小说规模 | 字数 | 章节数 | 支持状态 |
|---------|------|--------|---------|
| 短篇 | 1-10万字 | 10-50章 | ✅ 完全支持 |
| 中篇 | 10-50万字 | 50-200章 | ✅ 完全支持 |
| 长篇 | 50-200万字 | 200-800章 | ✅ 支持（需要智能上下文） |
| 超长篇 | 200-500万字 | 800-2000章 | ✅ 支持（需要完整存储方案） |

### 4.2 关键能力

```
┌─────────────────────────────────────────────────────────────────────┐
│                    长篇小说支持的六大关键能力                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │  1. 持久化存储   │  │  2. 智能上下文   │  │  3. 一致性保障   │     │
│  │  SQLite + Chroma│  │  分层检索 + 摘要 │  │  自动校验 + 修复 │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │  4. 伏笔追踪    │  │  5. 断点续写     │  │  6. 版本管理     │     │
│  │  埋设 → 回收    │  │  检查点恢复     │  │  章节历史回滚    │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## 5. 扩展性设计

### 5.1 插件扩展

```python
# 添加新的元素插件只需：
class MyCustomPlugin(NovelElementPlugin):
    name = "my_plugin"
    
    def get_schema(self) -> Dict:
        return {...}
    
    def get_tasks(self) -> List[TaskDefinition]:
        return [...]
    
    async def validate(self, data, context) -> ValidationResult:
        return ...

# 注册即可使用
plugin_manager.register(MyCustomPlugin())
```

### 5.2 LLM 扩展

```python
# 添加新的 LLM 提供商
class NewLLMClient(LLMClientBase):
    name = "new_llm"
    
    async def generate(self, prompt: str, **kwargs) -> Tuple[str, Dict]:
        # 实现生成逻辑
        return response, usage

# 加入多模型路由
providers.append(NewLLMClient())
```

### 5.3 任务类型扩展

```python
# 添加新的任务类型
task_type_map["新任务类型"] = 0  # 路由到 Qwen
```

## 6. 相关文档

- [核心模块详解](./CORE_MODULES.md) - 详细的模块说明
- [多 LLM 分工](./MULTI_LLM.md) - 三大模型的分工策略
- [插件系统](./PLUGIN_SYSTEM.md) - 插件开发指南
- [长篇小说支持](./LONG_NOVEL_SUPPORT.md) - 存储和上下文管理

---

*更详细的架构说明请查看 [完整架构文档](../../ARCHITECTURE.md)*
