# 核心模块详解

> 详细说明 Creative AutoGPT 的核心模块设计与实现

## 模块概览

```
┌────────────────────────────────────────────────────────────────────┐
│                          Core Modules                               │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    LoopEngine (核心)                         │  │
│  │                    协调所有模块的执行                         │  │
│  └──────────────────────────┬──────────────────────────────────┘  │
│                              │                                      │
│         ┌────────────────────┼────────────────────┐                │
│         │                    │                    │                │
│         ▼                    ▼                    ▼                │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│  │TaskPlanner  │     │VectorMemory │     │ Evaluator   │          │
│  │ 任务规划    │     │ 向量记忆    │     │ 质量评估    │          │
│  └─────────────┘     └─────────────┘     └─────────────┘          │
│         │                    │                    │                │
│         ▼                    ▼                    ▼                │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│  │   Mode      │     │PromptMgr   │     │ LLMClient   │          │
│  │ 写作模式    │     │ 提示词管理  │     │ 大模型客户端 │          │
│  └─────────────┘     └─────────────┘     └─────────────┘          │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

---

## 1. LoopEngine - 核心执行引擎

### 1.1 职责

主执行循环，协调所有模块完成小说创作。

### 1.2 类定义

```python
class LoopEngine:
    """写作 Agent 的核心执行引擎"""
    
    def __init__(
        self,
        mode: Mode,                    # 写作模式（小说/剧本等）
        planner: TaskPlanner,          # 任务规划器
        llm_client: LLMClient,         # LLM 客户端
        memory: VectorMemoryManager,   # 向量记忆
        evaluator: EvaluationEngine,   # 评估引擎
    ): ...
```

### 1.3 执行流程

```
                    ┌─────────────────┐
                    │   run(goal)     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  planner.plan() │
                    │  生成任务列表    │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              ▼                             │
     ┌─────────────────┐                    │
     │ _get_next_task()│◀───────────────┐   │
     │ 获取下一个任务   │                │   │
     └────────┬────────┘                │   │
              │                         │   │
              ▼                         │   │
     ┌─────────────────┐                │   │
     │ _execute_task() │                │   │
     │ 执行任务         │                │   │
     └────────┬────────┘                │   │
              │                         │   │
              ▼                         │   │
     ┌─────────────────┐                │   │
     │  evaluator      │                │   │
     │  .evaluate()    │                │   │
     └────────┬────────┘                │   │
              │                         │   │
         ┌────┴────┐                    │   │
         │ passed? │                    │   │
         └────┬────┘                    │   │
        Yes   │   No                    │   │
    ┌─────────┴─────────┐               │   │
    │                   │               │   │
    ▼                   ▼               │   │
┌───────┐        ┌─────────────┐        │   │
│ save  │        │_attempt_    │        │   │
│memory │        │ rewrite()   │────────┘   │
└───┬───┘        └─────────────┘            │
    │                                       │
    └───────────────────────────────────────┘
              (循环直到所有任务完成)
```

### 1.4 关键方法

| 方法 | 职责 | 说明 |
|------|------|------|
| `run(goal)` | 主入口 | 接收创作目标，返回完整结果 |
| `_get_next_task()` | 任务调度 | 按依赖关系获取可执行任务 |
| `_execute_task(task)` | 任务执行 | 构建提示词、调用 LLM、处理结果 |
| `_attempt_rewrite(task, result)` | 重写 | 质量不合格时触发重写 |
| `_dependencies_met(task)` | 依赖检查 | 检查任务依赖是否满足 |

---

## 2. TaskPlanner - 任务规划器

### 2.1 职责

规划小说创作的任务序列和依赖关系。

### 2.2 任务依赖图

```
                    ┌─────────┐
                    │   风格   │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │主题确认  │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │市场定位  │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │   大纲   │
                    └────┬────┘
                         │
      ┌──────────┬───────┼───────┬──────────┐
      │          │       │       │          │
      ▼          ▼       ▼       ▼          ▼
 ┌─────────┐┌─────────┐┌─────────┐┌─────────┐┌─────────┐
 │  事件   ││人物设计 ││  物品   ││世界观   ││ 伏笔    │
 │        ││        ││        ││规则    ││ 列表    │
 └────┬────┘└────┬────┘└────┬────┘└────┬────┘└────┬────┘
      │          │          │          │          │
      └──────────┴──────────┼──────────┴──────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │  一致性检查  │
                    └──────┬──────┘
                           │
                           ▼
              ┌────────────────────────┐
              │     章节循环生成       │
              │  ┌──────────────────┐ │
              │  │ 章节大纲         │ │
              │  │      ↓          │ │
              │  │ 场景（多个）     │ │
              │  │      ↓          │ │
              │  │ 章节内容         │ │
              │  │      ↓          │ │
              │  │ 章节润色         │ │
              │  └──────────────────┘ │
              └────────────────────────┘
```

### 2.3 任务类型定义

```python
class NovelTaskType(Enum):
    """小说任务类型"""
    OUTLINE = "大纲"                    # Qwen 负责
    EVENTS = "事件"                      # DeepSeek 负责
    SCENES_ITEMS_CONFLICTS = "场景物品冲突"  # DeepSeek 负责
    CHARACTERS = "人物设计"              # Qwen 负责
    STYLE_ELEMENTS = "风格元素"          # Qwen 负责
    CHAPTER_CONTENT = "章节内容"         # Doubao 负责
    EVALUATION = "评估"                  # DeepSeek 负责
    REVISE = "修订"                      # Doubao 负责
```

---

## 3. VectorMemoryManager - 向量记忆

### 3.1 职责

存储和检索创作上下文，支持语义搜索。

### 3.2 记忆架构

```
┌─────────────────────────────────────────────────────────────┐
│                    VectorMemoryManager                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Short-term Memory                    │  │
│  │                   (最近 N 个任务结果)                   │  │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐            │  │
│  │  │ T-4 │ │ T-3 │ │ T-2 │ │ T-1 │ │ T-0 │            │  │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘            │  │
│  └───────────────────────────────────────────────────────┘  │
│                              │                               │
│                              ▼ (溢出转移)                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Long-term Memory                     │  │
│  │                   (向量化存储 + 语义检索)               │  │
│  │                                                        │  │
│  │   ┌─────────────────────────────────────────────────┐ │  │
│  │   │  Vector Index (Embedding)                       │ │  │
│  │   │  ┌────────┐ ┌────────┐ ┌────────┐             │ │  │
│  │   │  │人物设定│ │情节事件│ │伏笔    │ ...         │ │  │
│  │   │  └────────┘ └────────┘ └────────┘             │ │  │
│  │   └─────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 关键方法

```python
class VectorMemoryManager:
    async def add(self, item: VectorMemoryItem) -> str:
        """添加记忆项"""
    
    async def search(self, query: str, top_k: int = 5) -> List[VectorMemoryItem]:
        """语义搜索"""
    
    async def get_context(self, task: Task) -> Dict[str, List[Any]]:
        """获取任务相关上下文"""
        return {
            "recent": self._get_recent(3),        # 最近3个结果
            "matches": await self._search(task),  # 语义匹配
        }
```

---

## 4. Evaluator - 质量评估器

### 4.1 职责

多维度评估生成内容的质量。

### 4.2 评估维度

```
┌─────────────────────────────────────────────────────────────┐
│                     评估维度与权重                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  coherence  │  │ creativity  │  │   quality   │         │
│  │    连贯性   │  │    创意性   │  │   写作质量   │         │
│  │    20%     │  │    20%     │  │    20%     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │ consistency │  │goal_alignmt │                          │
│  │    一致性   │  │  目标对齐   │                          │
│  │    20%     │  │    20%     │                          │
│  └─────────────┘  └─────────────┘                          │
│                                                              │
│  综合分数 = Σ(维度分数 × 权重)                               │
│  通过阈值 = 0.7 (可配置)                                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 评估结果

```python
@dataclass
class EvaluationResult:
    passed: bool                      # 是否通过
    score: float                      # 综合分数 (0-1)
    dimension_scores: Dict[str, float]  # 各维度分数
    reasons: List[str]                # 评估原因
    suggestions: List[str]            # 改进建议
```

---

## 5. Mode - 写作模式

### 5.1 职责

根据任务类型构建相应的提示词。

### 5.2 类层次

```
              ┌─────────────┐
              │    Mode     │ (抽象基类)
              │  (ABC)      │
              └──────┬──────┘
                     │
       ┌─────────────┼─────────────┐
       │             │             │
       ▼             ▼             ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│ NovelMode │ │ScreenMode │ │ScriptMurder│
│  小说模式  │ │  剧本模式  │ │ 剧本杀模式 │
└───────────┘ └───────────┘ └───────────┘
```

### 5.3 提示词映射

```python
class NovelMode(Mode):
    PROMPT_TEMPLATES = {
        "风格": "structure",
        "主题确认": "theme_confirmation",
        "大纲": "novel_outline",
        "人物设计": "characters",
        "章节": "content",
        "评估": "evaluation",
        ...
    }
    
    def build_prompt(self, task: Task, context: Dict) -> str:
        template = self._get_template(task.type)
        return template.format(**context)
```

---

## 6. MultiLLMClient - 多模型客户端

### 6.1 职责

根据任务类型智能路由到最优 LLM。

### 6.2 路由策略

```
┌─────────────────────────────────────────────────────────────┐
│                    MultiLLMClient                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              task_type_map 路由表                    │    │
│  │                                                      │    │
│  │  大纲, 风格元素, 人物设计 ──────────▶ Qwen (0)      │    │
│  │  事件, 场景物品冲突, 评估 ──────────▶ DeepSeek (1)  │    │
│  │  章节内容, 修订 ────────────────────▶ Doubao (2)    │    │
│  │                                                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  providers = [                                               │
│      AliyunLLMClient(),    # 0: Qwen - 总览记忆             │
│      DeepSeekLLMClient(),  # 1: DeepSeek - 逻辑结构         │
│      DoubaoLLMClient(),    # 2: Doubao - 创意文笔           │
│  ]                                                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 故障转移

```python
async def generate(self, prompt: str, task_type: str = None):
    primary = self._select_provider(task_type)
    fallback_order = self._get_fallback_order(primary)
    
    for provider in [primary] + fallback_order:
        try:
            return await provider.generate(prompt)
        except Exception as e:
            logger.warning(f"{provider.name} failed, trying next...")
    
    raise AllProvidersFailedError()
```

---

## 模块间交互

```
┌─────────────────────────────────────────────────────────────────┐
│                       典型执行流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. LoopEngine.run("写一部悬疑小说")                             │
│         │                                                        │
│         ▼                                                        │
│  2. TaskPlanner.plan() ──────────▶ [风格, 大纲, 人物, ...]       │
│         │                                                        │
│         ▼                                                        │
│  3. for task in tasks:                                          │
│         │                                                        │
│         ├──▶ VectorMemory.get_context(task)                     │
│         │        返回相关上下文                                   │
│         │                                                        │
│         ├──▶ Mode.build_prompt(task, context)                   │
│         │        构建提示词                                       │
│         │                                                        │
│         ├──▶ MultiLLMClient.generate(prompt, task.type)         │
│         │        选择最优 LLM 生成                                │
│         │                                                        │
│         ├──▶ Evaluator.evaluate(task, result)                   │
│         │        评估质量                                         │
│         │                                                        │
│         └──▶ VectorMemory.add(result)                           │
│                  存储结果                                         │
│                                                                  │
│  4. return 完整小说                                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

*详细代码实现请查看 `src/creative_autogpt/core/` 目录*
