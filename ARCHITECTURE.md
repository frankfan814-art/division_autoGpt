# Creative AutoGPT æ¶æ„æ–‡æ¡£ - å†™ä½œç‰ˆ AutoGPT

## ä¸€ã€é¡¹ç›®æ„¿æ™¯

**ç›®æ ‡**ï¼šæ„å»ºä¸€ä¸ªä¸“æ³¨äºé•¿ç¯‡åˆ›æ„å†™ä½œçš„ AI Agent ç³»ç»Ÿï¼Œå€Ÿé‰´ AutoGPT çš„æ ¸å¿ƒç†å¿µï¼Œé’ˆå¯¹å†™ä½œåœºæ™¯è¿›è¡Œæ·±åº¦ä¼˜åŒ–ã€‚

### æ ¸å¿ƒå·®å¼‚

| ç»´åº¦ | é€šç”¨ AutoGPT | å†™ä½œ AutoGPT |
|------|-------------|--------------|
| **ä»»åŠ¡ç±»å‹** | é€šç”¨ä»»åŠ¡ï¼ˆæœç´¢ã€ç¼–ç¨‹ã€æ–‡ä»¶æ“ä½œï¼‰ | ä¸“æ³¨åˆ›æ„å†™ä½œï¼ˆå°è¯´ã€å‰§æœ¬ã€å‰§æœ¬æ€ï¼‰ |
| **å·¥å…·ç³»ç»Ÿ** | Web æœç´¢ã€ä»£ç æ‰§è¡Œã€æ–‡ä»¶ç³»ç»Ÿ | æç¤ºè¯æ¨¡æ¿ã€é£æ ¼æ³¨å…¥ã€ä¸€è‡´æ€§æ£€æŸ¥ |
| **è®°å¿†ç³»ç»Ÿ** | çŸ­æœŸ+é•¿æœŸé€šç”¨è®°å¿† | åˆ›ä½œä¸Šä¸‹æ–‡è®°å¿†ï¼ˆäººç‰©ã€æƒ…èŠ‚ã€ä¼ç¬”ï¼‰ |
| **è¯„ä¼°æ ‡å‡†** | ä»»åŠ¡å®Œæˆåº¦ | åˆ›ä½œè´¨é‡ï¼ˆè¿è´¯æ€§ã€åˆ›æ„æ€§ã€é£æ ¼ä¸€è‡´æ€§ï¼‰ |
| **æ‰§è¡Œæ¨¡å¼** | å•ä»»åŠ¡è‡ªä¸»å¾ªç¯ | å¤šé˜¶æ®µæµæ°´çº¿ï¼ˆå¤§çº²â†’äººç‰©â†’ç« èŠ‚ï¼‰ |

---

## äºŒã€AutoGPT æ ¸å¿ƒæ¦‚å¿µç§»æ¤

### 2.1 Agent æ ¸å¿ƒå¾ªç¯

```
AutoGPT åŸç‰ˆå¾ªç¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ€è€ƒ   â”‚â”€â”€â”€â–¶â”‚  è§„åˆ’   â”‚â”€â”€â”€â–¶â”‚  æ‰§è¡Œ   â”‚       â”‚
â”‚  â”‚ (Think) â”‚    â”‚ (Plan)  â”‚    â”‚(Execute)â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚              â”‚              â”‚             â”‚
â”‚       â–¼              â–¼              â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  è®°å¿†   â”‚â—€â”€â”€â”€â”‚  è¯„ä¼°   â”‚â—€â”€â”€â”€â”‚  ç»“æœ   â”‚       â”‚
â”‚  â”‚(Memory) â”‚    â”‚(Evaluateâ”‚    â”‚(Result) â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†™ä½œ AutoGPT å¾ªç¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚æç¤ºæ„å»º â”‚â”€â”€â”€â–¶â”‚ LLMç”Ÿæˆ â”‚â”€â”€â”€â–¶â”‚è´¨é‡è¯„ä¼° â”‚       â”‚
â”‚  â”‚(Prompt) â”‚    â”‚(Generateâ”‚    â”‚(Evaluateâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚              â”‚              â”‚             â”‚
â”‚       â–²              â”‚              â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ä¸Šä¸‹æ–‡   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ é‡å†™?   â”‚       â”‚
â”‚  â”‚æ£€ç´¢     â”‚                   â”‚(Rewrite)â”‚       â”‚
â”‚  â”‚(Context)â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—å¯¹ç…§

| AutoGPT æ¨¡å— | å†™ä½œ AutoGPT å¯¹åº” | æ–‡ä»¶ä½ç½® | èŒè´£ |
|-------------|-------------------|---------|------|
| `Agent` | `LoopEngine` | `loop_engine.py` | ä¸»æ‰§è¡Œå¾ªç¯ï¼Œåè°ƒå„æ¨¡å— |
| `propose_action()` | `TaskPlanner.plan()` | `task_planner.py` | è§„åˆ’ä¸‹ä¸€æ­¥ä»»åŠ¡ |
| `execute()` | `_execute_task()` | `loop_engine.py` | æ‰§è¡Œå•ä¸ªä»»åŠ¡ |
| `Memory` | `VectorMemoryManager` | `vector_memory.py` | è¯­ä¹‰è®°å¿†ä¸ä¸Šä¸‹æ–‡æ£€ç´¢ |
| `CommandProvider` | `Mode.build_prompt()` | `modes/novel.py` | æ„å»ºä»»åŠ¡æç¤ºè¯ |
| `ActionResult` | `EvaluationResult` | `evaluator.py` | æ‰§è¡Œç»“æœä¸è´¨é‡è¯„ä¼° |
| `AIDirectives` | `PromptManager` | `prompts/manager.py` | é£æ ¼ä¸è§„åˆ™æ³¨å…¥ |
| **ğŸ†• N/A** | **`PromptEnhancer`** | `prompts/enhancer.py` | **æ™ºèƒ½æç¤ºè¯ç”Ÿæˆï¼Œé™ä½ä½¿ç”¨é—¨æ§›** |

---

## ä¸‰ã€å½“å‰æ¶æ„è¯¦è§£

### 3.1 ç³»ç»Ÿæ¶æ„å›¾

```
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚    Frontend      â”‚
                                  â”‚   (React/TS)     â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚ HTTP/WebSocket
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Server (FastAPI)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ SessionMgr  â”‚  â”‚ TaskAPI     â”‚  â”‚ StreamAPI   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ™ºèƒ½æç¤ºè¯å¢å¼ºï¼ˆå…¥å£ï¼‰                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   PromptEnhancer                          â”‚  â”‚
â”‚  â”‚  ç”¨æˆ·ç®€å•è¾“å…¥ â”€â”€â–¶ LLMæ‰©å±• â”€â”€â–¶ ç»“æ„åŒ–é…ç½® â”€â”€â–¶ ç”¨æˆ·ç¡®è®¤      â”‚  â”‚
â”‚  â”‚  "å†™ä¸ªç„å¹»å°è¯´"    (DeepSeek)   å®Œæ•´è®¾å®š      å¯é€‰æ­¥éª¤      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®æ—¶äº¤äº’å±‚ï¼ˆæ¯æ­¥é¢„è§ˆ + èŠå¤©åé¦ˆï¼‰ğŸ†•               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚   â”‚ ä»»åŠ¡é¢„è§ˆ    â”‚      â”‚ èŠå¤©åé¦ˆ    â”‚      â”‚ ä½œç”¨åŸŸ   â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ Preview     â”‚â—€â”€â”€â”€â”€â–¶â”‚ ChatFeedbackâ”‚â”€â”€â”€â”€â”€â–¶â”‚ éš”ç¦»å™¨   â”‚  â”‚  â”‚
â”‚  â”‚   â”‚             â”‚      â”‚             â”‚      â”‚ Scoped   â”‚  â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚          â”‚                    â”‚                  â”‚        â”‚  â”‚
â”‚  â”‚          â”‚    ç”¨æˆ·å¯éšæ—¶:     â”‚                  â”‚        â”‚  â”‚
â”‚  â”‚          â”‚    - æŸ¥çœ‹é¢„è§ˆ      â”‚                  â”‚        â”‚  â”‚
â”‚  â”‚          â”‚    - æåé¦ˆæ„è§    â”‚ æ„è§åªå½±å“       â”‚        â”‚  â”‚
â”‚  â”‚          â”‚    - ç¡®è®¤/ä¿®æ”¹     â”‚ å½“å‰ä»»åŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚          â”‚                    â”‚                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                    â”‚                               â”‚
â”‚             â–¼                    â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚           FeedbackTransformer (æ„è§â†’ä¸“ä¸šæç¤ºè¯)             â”‚â”‚
â”‚  â”‚  ç”¨æˆ·: "ä¸»è§’å¤ªè½¯å¼±" â†’ Promptè¡¥ä¸: "æ€§æ ¼éœ¸æ°”ï¼Œå†·ç¬‘é¢å¯¹å˜²è®½"  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       LoopEngine (æ ¸å¿ƒ)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ‰§è¡Œå¾ªç¯                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚  â”‚TaskQueueâ”‚â”€â”€â”€â–¶â”‚Execute  â”‚â”€â”€â”€â–¶â”‚Evaluate â”‚â”€â”€â”€â–¶â”‚Rewrite? â”‚â”‚  â”‚
â”‚  â”‚  â”‚ä»»åŠ¡é˜Ÿåˆ—  â”‚    â”‚æ‰§è¡Œä»»åŠ¡  â”‚    â”‚è¯„ä¼°è´¨é‡  â”‚    â”‚éœ€è¦é‡å†™? â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â”‚                      â”‚              â”‚              â”‚     â”‚  â”‚
â”‚  â”‚                      â–¼              â–¼              â–¼     â”‚  â”‚
â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚                 â”‚         Memory (å­˜å‚¨ç»“æœ)           â”‚  â”‚  â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  TaskPlanner   â”‚  â”‚ VectorMemory   â”‚  â”‚  Evaluator     â”‚    â”‚
â”‚  â”‚  ä»»åŠ¡è§„åˆ’å™¨     â”‚  â”‚ å‘é‡è®°å¿†       â”‚  â”‚  è´¨é‡è¯„ä¼°å™¨    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Mode (Novel)  â”‚  â”‚ PromptManager  â”‚  â”‚  LLM Client    â”‚    â”‚
â”‚  â”‚  å†™ä½œæ¨¡å¼       â”‚  â”‚ æç¤ºè¯ç®¡ç†     â”‚  â”‚  å¤§æ¨¡å‹å®¢æˆ·ç«¯  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜

#### 3.2.1 LoopEngine (loop_engine.py)

**èŒè´£**ï¼šä¸»æ‰§è¡Œå¾ªç¯ï¼Œåè°ƒæ‰€æœ‰æ¨¡å—

```python
class LoopEngine:
    """å†™ä½œ Agent çš„æ ¸å¿ƒæ‰§è¡Œå¼•æ“"""
    
    def __init__(
        self,
        mode: Mode,                    # å†™ä½œæ¨¡å¼ï¼ˆå°è¯´/å‰§æœ¬ç­‰ï¼‰
        planner: TaskPlanner,          # ä»»åŠ¡è§„åˆ’å™¨
        llm_client: LLMClient,         # LLM å®¢æˆ·ç«¯
        memory: VectorMemoryManager,   # å‘é‡è®°å¿†
        evaluator: EvaluationEngine,   # è¯„ä¼°å¼•æ“
    ): ...
    
    async def run(self, goal: str, ...) -> Dict[str, Any]:
        """
        ä¸»æ‰§è¡Œå¾ªç¯
        1. è§„åˆ’ä»»åŠ¡åˆ—è¡¨
        2. æŒ‰ä¾èµ–é¡ºåºæ‰§è¡Œ
        3. è¯„ä¼°è´¨é‡ï¼Œå¿…è¦æ—¶é‡å†™
        4. å­˜å‚¨åˆ°è®°å¿†ç³»ç»Ÿ
        """
```

**å…³é”®æ–¹æ³•**ï¼š

| æ–¹æ³• | èŒè´£ | AutoGPT å¯¹åº” |
|------|------|-------------|
| `run()` | ä¸»å¾ªç¯å…¥å£ | `run_interaction_loop()` |
| `_get_next_task()` | è·å–ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œä»»åŠ¡ | `propose_action()` |
| `_execute_task()` | æ‰§è¡Œå•ä¸ªä»»åŠ¡ | `execute()` |
| `_attempt_rewrite()` | è´¨é‡ä¸åˆæ ¼æ—¶é‡å†™ | `do_not_execute()` |
| `_dependencies_met()` | æ£€æŸ¥ä¾èµ–æ˜¯å¦æ»¡è¶³ | æ‹“æ‰‘æ’åº |

#### 3.2.2 TaskPlanner (task_planner.py)

**èŒè´£**ï¼šè§„åˆ’å†™ä½œä»»åŠ¡çš„æ‰§è¡Œé¡ºåºå’Œä¾èµ–å…³ç³»

```python
class NovelPipelinePlanner(TaskPlanner):
    """å°è¯´åˆ›ä½œæµæ°´çº¿è§„åˆ’å™¨"""
    
    def plan(self, goal: str, context: ExecutionContext) -> List[Task]:
        """
        ç”Ÿæˆå°è¯´åˆ›ä½œçš„å®Œæ•´ä»»åŠ¡é“¾
        
        ä»»åŠ¡æµç¨‹:
        é£æ ¼ â†’ ä¸»é¢˜ç¡®è®¤ â†’ å¸‚åœºå®šä½ â†’ å¤§çº² â†’ äº‹ä»¶ â†’ äººç‰©è®¾è®¡ â†’ 
        äººç‰©å¼§å…‰ â†’ ç‰©å“ â†’ ä¸–ç•Œè§‚è§„åˆ™ â†’ èŠ‚å¥æ£€æŸ¥ â†’ èŠ‚å¥åœ°å›¾ â†’ 
        æ—¶é—´çº¿æ£€æŸ¥ â†’ é£æ ¼æ£€æŸ¥ â†’ å¯¹è¯æ£€æŸ¥ â†’ ä¼ç¬”åˆ—è¡¨ â†’ 
        ä¸€è‡´æ€§æ£€æŸ¥ â†’ æœ€ç»ˆä¸€è‡´æ€§æ£€æŸ¥ â†’ (ç« èŠ‚å¾ªç¯)
        """
```

**ä»»åŠ¡ä¾èµ–å›¾**ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   é£æ ¼   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ä¸»é¢˜ç¡®è®¤  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚å¸‚åœºå®šä½  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å¤§çº²   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼          â–¼       â–¼          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  äº‹ä»¶   â”‚â”‚äººç‰©è®¾è®¡ â”‚â”‚  ç‰©å“   â”‚â”‚ä¸–ç•Œè§‚è§„åˆ™â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚          â”‚          â”‚          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ä¸€è‡´æ€§æ£€æŸ¥â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ç« èŠ‚ç”Ÿæˆå¾ªç¯      â”‚
              â”‚ (æ¯ç« é‡å¤ä»¥ä¸‹)    â”‚
              â”‚  ç« èŠ‚å¤§çº²         â”‚
              â”‚     â†“            â”‚
              â”‚  åœºæ™¯(å¤šä¸ª)       â”‚
              â”‚     â†“            â”‚
              â”‚  ç« èŠ‚å†…å®¹         â”‚
              â”‚     â†“            â”‚
              â”‚  ç« èŠ‚æ¶¦è‰²         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 VectorMemoryManager (vector_memory.py)

**èŒè´£**ï¼šå­˜å‚¨å’Œæ£€ç´¢åˆ›ä½œä¸Šä¸‹æ–‡

```python
class VectorMemoryManager:
    """å‘é‡è®°å¿†ç®¡ç†å™¨ - å†™ä½œç‰ˆçš„ Memory ç³»ç»Ÿ"""
    
    def __init__(
        self,
        short_term_limit: int = 10,     # çŸ­æœŸè®°å¿†å®¹é‡
        long_term_limit: int = 1000,    # é•¿æœŸè®°å¿†å®¹é‡
        similarity_threshold: float = 0.7,  # ç›¸ä¼¼åº¦é˜ˆå€¼
    ): ...
    
    async def add(self, item: VectorMemoryItem) -> str:
        """æ·»åŠ è®°å¿†é¡¹ï¼ˆè‡ªåŠ¨è®¡ç®—å‘é‡åµŒå…¥ï¼‰"""
    
    async def search(self, query: str, top_k: int = 5) -> List[VectorMemoryItem]:
        """è¯­ä¹‰æœç´¢ç›¸å…³è®°å¿†"""
    
    async def get_context(self, task: Task) -> Dict[str, List[Any]]:
        """ä¸ºä»»åŠ¡è·å–ç›¸å…³ä¸Šä¸‹æ–‡ï¼ˆrecent + matchesï¼‰"""
```

**è®°å¿†ç±»å‹**ï¼š

| è®°å¿†ç±»å‹ | å†…å®¹ | ç”¨é€” |
|---------|------|------|
| çŸ­æœŸè®°å¿† | æœ€è¿‘ N ä¸ªä»»åŠ¡ç»“æœ | ä¿æŒåˆ›ä½œè¿è´¯æ€§ |
| é•¿æœŸè®°å¿† | æ‰€æœ‰å†å²ä»»åŠ¡ç»“æœï¼ˆå‘é‡åŒ–ï¼‰ | è¯­ä¹‰æ£€ç´¢ç›¸å…³å†…å®¹ |
| ä»»åŠ¡ç»“æœ | type + result + metadata | äººç‰©è®¾å®šã€æƒ…èŠ‚ã€ä¼ç¬”ç­‰ |

#### 3.2.4 Evaluator (evaluator.py)

**èŒè´£**ï¼šè¯„ä¼°ç”Ÿæˆå†…å®¹çš„è´¨é‡

```python
class LlmEvaluationEngine(EvaluationEngine):
    """LLM é©±åŠ¨çš„å¤šç»´åº¦è¯„ä¼°å¼•æ“"""
    
    # è¯„ä¼°ç»´åº¦
    DIMENSIONS = {
        "coherence": 0.2,      # è¿è´¯æ€§
        "creativity": 0.2,     # åˆ›æ„æ€§
        "quality": 0.2,        # å†™ä½œè´¨é‡
        "consistency": 0.2,    # ä¸€è‡´æ€§
        "goal_alignment": 0.2, # ç›®æ ‡å¯¹é½åº¦
    }
    
    async def evaluate(
        self,
        task: Task,
        result: str,
        context: Dict[str, Any]
    ) -> EvaluationResult:
        """
        è¯„ä¼°ç”Ÿæˆå†…å®¹
        è¿”å›: passed (æ˜¯å¦é€šè¿‡), score (ç»¼åˆåˆ†æ•°), reasons (è¯„ä¼°åŸå› )
        """
```

#### 3.2.5 Mode (modes/novel.py)

**èŒè´£**ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹æ„å»ºæç¤ºè¯

```python
class NovelMode(Mode):
    """å°è¯´å†™ä½œæ¨¡å¼"""
    
    # ä»»åŠ¡ç±»å‹ â†’ æç¤ºè¯æ¨¡æ¿æ˜ å°„
    PROMPT_TEMPLATES = {
        "é£æ ¼": "structure",
        "ä¸»é¢˜ç¡®è®¤": "theme_confirmation",
        "å¤§çº²": "novel_outline",
        "äººç‰©è®¾è®¡": "characters",
        "ç« èŠ‚": "content",
        # ...
    }
    
    def build_prompt(self, task: Task, context: Dict[str, Any]) -> str:
        """
        æ„å»ºä»»åŠ¡æç¤ºè¯
        1. é€‰æ‹©å¯¹åº”æ¨¡æ¿
        2. æ³¨å…¥ä¸Šä¸‹æ–‡
        3. æ³¨å…¥é£æ ¼
        """
```

### 3.3 æç¤ºè¯ç³»ç»Ÿ

```
prompts/
â”œâ”€â”€ universal/          # é€šç”¨æç¤ºè¯æ¨¡æ¿
â”‚   â”œâ”€â”€ novel_outline.txt        # å¤§çº²ç”Ÿæˆ
â”‚   â”œâ”€â”€ characters.txt           # äººç‰©è®¾è®¡
â”‚   â”œâ”€â”€ content.txt              # å†…å®¹ç”Ÿæˆ
â”‚   â”œâ”€â”€ consistency_check.txt    # ä¸€è‡´æ€§æ£€æŸ¥
â”‚   â”œâ”€â”€ snowflake_method.txt     # é›ªèŠ±å†™ä½œæ³•
â”‚   â””â”€â”€ ...
â”œâ”€â”€ styles/             # é£æ ¼è¦†ç›–å±‚
â”‚   â”œâ”€â”€ suspense/       # æ‚¬ç–‘é£æ ¼
â”‚   â”œâ”€â”€ romance/        # è¨€æƒ…é£æ ¼
â”‚   â”œâ”€â”€ xianxia/        # ä»™ä¾ é£æ ¼
â”‚   â””â”€â”€ ...
â””â”€â”€ base/               # åŸºç¡€ç»„ä»¶
    â”œâ”€â”€ context.txt     # ä¸Šä¸‹æ–‡æ¨¡æ¿
    â”œâ”€â”€ quality_standards.txt  # è´¨é‡æ ‡å‡†
    â””â”€â”€ style_injection.txt    # é£æ ¼æ³¨å…¥
```

**é£æ ¼æ³¨å…¥æœºåˆ¶**ï¼š

```python
def get_prompt_with_style(template_name: str, style: str = None, **vars) -> str:
    """
    è·å–å¸¦é£æ ¼æ³¨å…¥çš„æç¤ºè¯
    
    1. åŠ è½½åŸºç¡€æ¨¡æ¿ (universal/{template}.txt)
    2. å¦‚æœæŒ‡å®šé£æ ¼ï¼ŒåŠ è½½é£æ ¼è¦†ç›– (styles/{style}/{template}.txt)
    3. åˆå¹¶å¹¶å¡«å……å˜é‡
    """
```

---

## å››ã€ä¸ AutoGPT çš„æ ¸å¿ƒå·®å¼‚ä¸ä¼˜åŒ–

### 4.1 ä»»åŠ¡è§„åˆ’ï¼šä»åŠ¨æ€åˆ°é™æ€æµæ°´çº¿

**AutoGPT æ–¹å¼**ï¼š
- åŠ¨æ€è§„åˆ’ï¼šæ¯ä¸€æ­¥æ ¹æ®å½“å‰çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥
- çµæ´»ä½†ä¸å¯é¢„æµ‹
- å¯èƒ½é™·å…¥å¾ªç¯æˆ–é—æ¼æ­¥éª¤

**å†™ä½œ AutoGPT ä¼˜åŒ–**ï¼š
- é™æ€æµæ°´çº¿ï¼šé¢„å®šä¹‰ä»»åŠ¡åºåˆ—å’Œä¾èµ–
- å¯é¢„æµ‹ã€å¯ç›‘æ§ã€å¯ä¸­æ–­æ¢å¤
- é’ˆå¯¹åˆ›æ„å†™ä½œä¼˜åŒ–çš„ä»»åŠ¡é¡ºåº

```python
# AutoGPT: åŠ¨æ€å†³ç­–
async def propose_action(self) -> OneShotAgentActionProposal:
    # æ¯æ¬¡éƒ½è®© LLM å†³å®šä¸‹ä¸€æ­¥
    pass

# å†™ä½œ AutoGPT: é™æ€æµæ°´çº¿ + åŠ¨æ€ç« èŠ‚æ‰©å±•
def plan(self, goal: str, context: ExecutionContext) -> List[Task]:
    tasks = []
    # å›ºå®šçš„å‰ç½®ä»»åŠ¡
    tasks.extend([
        Task(type="é£æ ¼", depends_on=[]),
        Task(type="ä¸»é¢˜ç¡®è®¤", depends_on=["é£æ ¼"]),
        Task(type="å¤§çº²", depends_on=["ä¸»é¢˜ç¡®è®¤"]),
        # ...
    ])
    # åŠ¨æ€çš„ç« èŠ‚ä»»åŠ¡ï¼ˆå¤§çº²å®Œæˆåç”Ÿæˆï¼‰
    return tasks
```

### 4.2 è®°å¿†ç³»ç»Ÿï¼šä»é€šç”¨åˆ°åˆ›ä½œä¸“ç”¨

**AutoGPT æ–¹å¼**ï¼š
- é€šç”¨è®°å¿†ï¼ˆæ–‡æœ¬æ‘˜è¦ï¼‰
- çŸ­æœŸ/é•¿æœŸç®€å•åˆ’åˆ†

**å†™ä½œ AutoGPT ä¼˜åŒ–**ï¼š
- ç»“æ„åŒ–åˆ›ä½œè®°å¿†ï¼ˆäººç‰©ã€æƒ…èŠ‚ã€ä¼ç¬”ï¼‰
- è¯­ä¹‰æ£€ç´¢ï¼ˆå‘é‡åµŒå…¥ï¼‰
- ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ£€ç´¢ç­–ç•¥

```python
# ä¸ºä¸åŒä»»åŠ¡ç±»å‹æ£€ç´¢ä¸åŒçš„ä¸Šä¸‹æ–‡
async def get_context(self, task: Task) -> Dict[str, List[Any]]:
    if task.type == "ç« èŠ‚":
        # æ£€ç´¢ï¼šå¤§çº²ã€ç›¸å…³äººç‰©ã€å‰ä¸€ç« å†…å®¹ã€ç›¸å…³ä¼ç¬”
        return {
            "recent": self._get_recent(3),
            "matches": await self._search_for_chapter(task)
        }
    elif task.type == "äººç‰©è®¾è®¡":
        # æ£€ç´¢ï¼šä¸–ç•Œè§‚ã€å·²æœ‰äººç‰©ã€ä¸»é¢˜
        return {...}
```

### 4.3 è¯„ä¼°ç³»ç»Ÿï¼šä»å®Œæˆåº¦åˆ°è´¨é‡å¤šç»´åº¦

**AutoGPT æ–¹å¼**ï¼š
- ä¸»è¦æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
- ç®€å•çš„æˆåŠŸ/å¤±è´¥

**å†™ä½œ AutoGPT ä¼˜åŒ–**ï¼š
- å¤šç»´åº¦è´¨é‡è¯„ä¼°
- å¯é…ç½®çš„é€šè¿‡é˜ˆå€¼
- è‡ªåŠ¨é‡å†™æœºåˆ¶

```python
class EvaluationResult:
    passed: bool           # æ˜¯å¦é€šè¿‡
    score: float           # ç»¼åˆåˆ†æ•° (0-1)
    dimension_scores: Dict[str, float]  # å„ç»´åº¦åˆ†æ•°
    reasons: List[str]     # è¯„ä¼°åŸå› 
    suggestions: List[str] # æ”¹è¿›å»ºè®®

# è¯„ä¼°ç»´åº¦
DIMENSIONS = {
    "coherence": 0.2,      # ä¸å‰æ–‡è¿è´¯
    "creativity": 0.2,     # åˆ›æ„æ€§å’Œæ–°é¢–åº¦
    "quality": 0.2,        # æ–‡å­—è´¨é‡
    "consistency": 0.2,    # äººç‰©/è®¾å®šä¸€è‡´
    "goal_alignment": 0.2, # ç¬¦åˆä»»åŠ¡ç›®æ ‡
}
```

### 4.4 æ‰§è¡Œæ¨¡å¼ï¼šä»è‡ªä¸»åˆ°å¯æ§

**AutoGPT æ–¹å¼**ï¼š
- å®Œå…¨è‡ªä¸»æ‰§è¡Œ
- ç”¨æˆ·éš¾ä»¥å¹²é¢„

**å†™ä½œ AutoGPT ä¼˜åŒ–**ï¼š
- å¯æš‚åœ/æ¢å¤
- WebSocket å®æ—¶åé¦ˆ
- ä¼šè¯æŒä¹…åŒ–

### 4.5 å¤š LLM æ™ºèƒ½åˆ†å·¥ï¼šä»å•ä¸€åˆ°åä½œ

**ä¼ ç»Ÿæ–¹å¼**ï¼š
- æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨åŒä¸€ä¸ªå¤§æ¨¡å‹
- æ— æ³•å‘æŒ¥å„æ¨¡å‹ä¼˜åŠ¿
- æˆæœ¬å’Œè´¨é‡éš¾ä»¥å…¼é¡¾

**å†™ä½œ AutoGPT ä¼˜åŒ–**ï¼š
- æ ¹æ®ä»»åŠ¡ç±»å‹è‡ªåŠ¨è·¯ç”±åˆ°æœ€ä¼˜æ¨¡å‹
- ä¸‰å¤§æ¨¡å‹å„å±•æ‰€é•¿ï¼ŒååŒå·¥ä½œ
- è´¨é‡ä¸æˆæœ¬çš„æœ€ä½³å¹³è¡¡

---

## äº”ã€å¤š LLM æ™ºèƒ½åˆ†å·¥æ¶æ„

### 5.1 è®¾è®¡ç†å¿µ

å†™ä½œæ˜¯ä¸€ä¸ªå¤šç»´åº¦çš„åˆ›ä½œè¿‡ç¨‹ï¼Œä¸åŒé˜¶æ®µéœ€è¦ä¸åŒçš„èƒ½åŠ›ï¼š
- **è§„åˆ’é˜¶æ®µ**éœ€è¦å…¨å±€æŠŠæ§èƒ½åŠ›
- **é€»è¾‘é˜¶æ®µ**éœ€è¦æ¨ç†å’Œç»“æ„åŒ–æ€è€ƒ
- **åˆ›ä½œé˜¶æ®µ**éœ€è¦æ–‡å­¦åˆ›æ„å’Œä¼˜ç¾æ–‡ç¬”

å•ä¸€å¤§æ¨¡å‹éš¾ä»¥åœ¨æ‰€æœ‰ç»´åº¦éƒ½è¾¾åˆ°æœ€ä¼˜ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨ **å¤š LLM åä½œæ¶æ„**ï¼Œè®©æ¯ä¸ªæ¨¡å‹ä¸“æ³¨äºè‡ªå·±æœ€æ“…é•¿çš„ä»»åŠ¡ã€‚

### 5.2 ä¸‰å¤§æ¨¡å‹ç‰¹æ€§åˆ†æ

| æ¨¡å‹ | æä¾›å•† | æ ¸å¿ƒä¼˜åŠ¿ | é€‚åˆä»»åŠ¡ | ç›¸å¯¹æˆæœ¬ |
|------|--------|----------|----------|----------|
| **Qwen** | Aliyun | é•¿ä¸Šä¸‹æ–‡çª—å£ã€å…¨å±€è®°å¿†å¼º | æ€»è§ˆè§„åˆ’ã€è®¾å®šç®¡ç† | ä¸­ç­‰ |
| **DeepSeek** | DeepSeek | é€»è¾‘æ¨ç†å¼ºã€ç»“æ„åŒ–æ€è€ƒ | äº‹ä»¶è®¾è®¡ã€è´¨é‡è¯„ä¼° | ä½ |
| **Doubao** | ç«å±±å¼•æ“ | æ–‡å­¦åˆ›ä½œå¼ºã€æ–‡ç¬”æµç•… | å†…å®¹ç”Ÿæˆã€æ¶¦è‰²ä¿®è®¢ | ä¸­ç­‰ |

### 5.3 ä»»åŠ¡è·¯ç”±æ¶æ„

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚        Task Router (ä»»åŠ¡è·¯ç”±å™¨)       â”‚
                         â”‚                                      â”‚
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                         â”‚  â”‚   task_type_map è·¯ç”±è¡¨        â”‚   â”‚
                         â”‚  â”‚                              â”‚   â”‚
                         â”‚  â”‚  å¤§çº² â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Qwen        â”‚   â”‚
                         â”‚  â”‚  é£æ ¼å…ƒç´  â”€â”€â”€â”€â–¶ Qwen        â”‚   â”‚
                         â”‚  â”‚  äººç‰©è®¾è®¡ â”€â”€â”€â”€â–¶ Qwen        â”‚   â”‚
                         â”‚  â”‚                              â”‚   â”‚
                         â”‚  â”‚  äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â–¶ DeepSeek    â”‚   â”‚
                         â”‚  â”‚  åœºæ™¯ç‰©å“å†²çª â”€â–¶ DeepSeek    â”‚   â”‚
                         â”‚  â”‚  è¯„ä¼° â”€â”€â”€â”€â”€â”€â”€â”€â–¶ DeepSeek    â”‚   â”‚
                         â”‚  â”‚                              â”‚   â”‚
                         â”‚  â”‚  ç« èŠ‚å†…å®¹ â”€â”€â”€â”€â–¶ Doubao      â”‚   â”‚
                         â”‚  â”‚  ä¿®è®¢ â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Doubao      â”‚   â”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                           â”‚                           â”‚
              â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ğŸ§  Qwen (Aliyun)     â”‚  â”‚   ğŸ” DeepSeek          â”‚  â”‚   âœ¨ Doubao (ç«å±±)      â”‚
â”‚    æ€»è§ˆè®°å¿†ä¸“å®¶          â”‚  â”‚   é€»è¾‘ç»“æ„ä¸“å®¶          â”‚  â”‚   åˆ›æ„æ–‡ç¬”ä¸“å®¶          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å¤§çº²ç”Ÿæˆ              â”‚  â”‚ â€¢ äº‹ä»¶é“¾è®¾è®¡            â”‚  â”‚ â€¢ ç« èŠ‚å†…å®¹åˆ›ä½œ          â”‚
â”‚ â€¢ é£æ ¼å…ƒç´ å®šä¹‰          â”‚  â”‚ â€¢ åœºæ™¯ç‰©å“å†²çª          â”‚  â”‚ â€¢ æ–‡å­—æ¶¦è‰²ä¿®è®¢          â”‚
â”‚ â€¢ äººç‰©è®¾è®¡ä¸å…³ç³»        â”‚  â”‚ â€¢ è´¨é‡è¯„ä¼°ä¸åˆ†æ        â”‚  â”‚ â€¢ å¯¹è¯ç”Ÿæˆ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼˜åŠ¿:                   â”‚  â”‚ ä¼˜åŠ¿:                   â”‚  â”‚ ä¼˜åŠ¿:                   â”‚
â”‚ â€¢ 200K+ tokens çª—å£     â”‚  â”‚ â€¢ å¼ºé€»è¾‘æ¨ç†            â”‚  â”‚ â€¢ æ–‡å­¦åˆ›ä½œèƒ½åŠ›å¼º        â”‚
â”‚ â€¢ å…¨å±€ä¸€è‡´æ€§æŠŠæ§        â”‚  â”‚ â€¢ å› æœå…³ç³»åˆç†          â”‚  â”‚ â€¢ æ–‡ç¬”ä¼˜ç¾æµç•…          â”‚
â”‚ â€¢ é•¿æœŸè®°å¿†ä¸é—å¿˜        â”‚  â”‚ â€¢ æ€§ä»·æ¯”é«˜              â”‚  â”‚ â€¢ å¯¹è¯è‡ªç„¶ç”ŸåŠ¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 è¯¦ç»†ä»»åŠ¡åˆ†å·¥

#### ğŸ§  Qwen - æ€»è§ˆè®°å¿†ä¸“å®¶

**è´Ÿè´£ä»»åŠ¡**ï¼š
- **å¤§çº²**ï¼šç»Ÿç­¹å…¨å±€ï¼Œè®¾å®šæ•´ä½“æ•…äº‹æ¡†æ¶ï¼ŒæŠŠæ¡ä¸»çº¿è„‰ç»œ
- **é£æ ¼å…ƒç´ **ï¼šç†è§£å¹¶å®šä¹‰é£æ ¼ç‰¹ç‚¹ï¼Œç¡®ä¿å…¨ä¹¦é£æ ¼ä¸€è‡´
- **äººç‰©è®¾è®¡**ï¼šè®¾è®¡äººç‰©å…³ç³»ç½‘ç»œï¼Œè®°ä½æ‰€æœ‰è®¾å®šé¿å…çŸ›ç›¾

**é€‰æ‹©åŸå› **ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qwen çš„é•¿ä¸Šä¸‹æ–‡ä¼˜åŠ¿åœ¨"è§„åˆ’ç±»"ä»»åŠ¡ä¸­è‡³å…³é‡è¦ï¼š              â”‚
â”‚                                                             â”‚
â”‚  1. å¤§çº²éœ€è¦åŒæ—¶è€ƒè™‘ï¼š                                      â”‚
â”‚     â€¢ æ•…äº‹å¼€ç«¯ã€å‘å±•ã€é«˜æ½®ã€ç»“å±€çš„æ•´ä½“å¼§çº¿                   â”‚
â”‚     â€¢ å¤šæ¡æ”¯çº¿çš„äº¤ç»‡ä¸æ”¶æŸ                                   â”‚
â”‚     â€¢ ä¸»é¢˜çš„å±‚å±‚æ·±åŒ–                                         â”‚
â”‚                                                             â”‚
â”‚  2. äººç‰©è®¾è®¡éœ€è¦åŒæ—¶æŠŠæ§ï¼š                                  â”‚
â”‚     â€¢ ä¸»è¦äººç‰© + æ¬¡è¦äººç‰©çš„å®Œæ•´å…³ç³»ç½‘                        â”‚
â”‚     â€¢ æ¯ä¸ªäººç‰©çš„èƒŒæ™¯ã€åŠ¨æœºã€æ€§æ ¼ã€å¼§å…‰                       â”‚
â”‚     â€¢ äººç‰©é—´çš„å†²çªä¸ç¾ç»Š                                     â”‚
â”‚                                                             â”‚
â”‚  â†’ è¿™äº›éƒ½éœ€è¦"å…¨å±€è§†é‡"ï¼ŒQwen çš„é•¿è®°å¿†æ˜¯å…³é”®               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ” DeepSeek - é€»è¾‘ç»“æ„ä¸“å®¶

**è´Ÿè´£ä»»åŠ¡**ï¼š
- **äº‹ä»¶**ï¼šè®¾è®¡é€»è¾‘æ¸…æ™°çš„äº‹ä»¶é“¾ï¼Œç¡®ä¿å› æœå…³ç³»åˆç†
- **åœºæ™¯ç‰©å“å†²çª**ï¼šæ„å»ºåˆç†çš„åœºæ™¯å¸ƒå±€å’Œå†²çªè®¾è®¡
- **è¯„ä¼°**ï¼šå®¢è§‚åˆ†æå†…å®¹è´¨é‡ï¼Œç²¾å‡†è¯†åˆ«é€»è¾‘é—®é¢˜

**é€‰æ‹©åŸå› **ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DeepSeek çš„é€»è¾‘æ¨ç†ä¼˜åŠ¿åœ¨"ç»“æ„ç±»"ä»»åŠ¡ä¸­è¡¨ç°çªå‡ºï¼š          â”‚
â”‚                                                             â”‚
â”‚  1. äº‹ä»¶é“¾è®¾è®¡éœ€è¦ï¼š                                        â”‚
â”‚     â€¢ Aäº‹ä»¶ â†’ Bäº‹ä»¶ â†’ Cäº‹ä»¶ çš„å› æœå¿…ç„¶æ€§                     â”‚
â”‚     â€¢ æ‚¬å¿µçš„åˆç†é“ºå«ä¸æ­ç¤º                                   â”‚
â”‚     â€¢ æ—¶é—´çº¿çš„å‡†ç¡®æŠŠæ§                                       â”‚
â”‚                                                             â”‚
â”‚  2. è¯„ä¼°ä»»åŠ¡éœ€è¦ï¼š                                          â”‚
â”‚     â€¢ å‘ç°é€»è¾‘æ¼æ´ï¼ˆå¦‚æ—¶é—´çŸ›ç›¾ã€äººç‰©è¡Œä¸ºä¸ä¸€è‡´ï¼‰             â”‚
â”‚     â€¢ é‡åŒ–æ‰“åˆ†çš„å®¢è§‚æ€§                                       â”‚
â”‚     â€¢ æå‡ºå…·ä½“å¯æ‰§è¡Œçš„æ”¹è¿›å»ºè®®                               â”‚
â”‚                                                             â”‚
â”‚  â†’ DeepSeek çš„æ¨ç†èƒ½åŠ› + é«˜æ€§ä»·æ¯”ï¼Œæ˜¯é€»è¾‘ä»»åŠ¡çš„æœ€ä½³é€‰æ‹©     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### âœ¨ Doubao - åˆ›æ„æ–‡ç¬”ä¸“å®¶

**è´Ÿè´£ä»»åŠ¡**ï¼š
- **ç« èŠ‚å†…å®¹**ï¼šç”Ÿæˆç”ŸåŠ¨æœ‰è¶£çš„æ•…äº‹å†…å®¹ï¼Œå¯¹è¯è‡ªç„¶æµç•…
- **ä¿®è®¢**ï¼šæ¶¦è‰²æ–‡å­—ï¼Œæå‡å¯è¯»æ€§å’Œæ–‡å­¦æ€§

**é€‰æ‹©åŸå› **ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Doubao çš„æ–‡å­¦åˆ›ä½œä¼˜åŠ¿åœ¨"å†…å®¹ç±»"ä»»åŠ¡ä¸­ä¸å¯æ›¿ä»£ï¼š            â”‚
â”‚                                                             â”‚
â”‚  1. ç« èŠ‚å†…å®¹åˆ›ä½œéœ€è¦ï¼š                                      â”‚
â”‚     â€¢ ä¼˜ç¾çš„å™äº‹è¯­è¨€                                         â”‚
â”‚     â€¢ ç”ŸåŠ¨çš„åœºæ™¯æå†™                                         â”‚
â”‚     â€¢ è‡ªç„¶çš„äººç‰©å¯¹è¯                                         â”‚
â”‚     â€¢ æ°åˆ°å¥½å¤„çš„æƒ…æ„Ÿæ¸²æŸ“                                     â”‚
â”‚                                                             â”‚
â”‚  2. ä¿®è®¢æ¶¦è‰²éœ€è¦ï¼š                                          â”‚
â”‚     â€¢ è¯­æ„Ÿæ•é”ï¼Œè¯†åˆ«ä¸è‡ªç„¶è¡¨è¾¾                               â”‚
â”‚     â€¢ è¯æ±‡ä¸°å¯Œï¼Œé¿å…é‡å¤æ¯ç‡¥                                 â”‚
â”‚     â€¢ èŠ‚å¥æŠŠæ§ï¼Œå¼ å¼›æœ‰åº¦                                     â”‚
â”‚                                                             â”‚
â”‚  â†’ Doubao çš„æ–‡å­¦ç´ å…»ï¼Œè®©åˆ›ä½œå†…å®¹æ›´å…·å¯è¯»æ€§å’Œè‰ºæœ¯æ€§          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.5 MultiLLMClient å®ç°

```python
class MultiLLMClient(LLMClientBase):
    """å¤š LLM æ™ºèƒ½åˆ†å·¥å®¢æˆ·ç«¯"""
    
    def __init__(
        self,
        providers: List[LLMClientBase],
        strategy: str = "task_type_map",
        task_type_map: Optional[Dict[str, int]] = None,
    ):
        """
        Args:
            providers: LLM æä¾›å•†åˆ—è¡¨
                [0] Qwen (Aliyun)   - æ€»è§ˆè®°å¿†
                [1] DeepSeek        - é€»è¾‘ç»“æ„
                [2] Doubao (ç«å±±)    - åˆ›æ„æ–‡ç¬”
            strategy: è·¯ç”±ç­–ç•¥
                - "round_robin": è½®è¯¢
                - "task_type_map": æŒ‰ä»»åŠ¡ç±»å‹æ˜ å°„
            task_type_map: ä»»åŠ¡ç±»å‹ â†’ æä¾›å•†ç´¢å¼•æ˜ å°„
        """
        self.providers = providers
        self.strategy = strategy
        self.task_type_map = task_type_map or self._default_task_type_map()
    
    def _default_task_type_map(self) -> Dict[str, int]:
        """é»˜è®¤çš„ä»»åŠ¡ç±»å‹åˆ†å·¥æ˜ å°„"""
        return {
            # Qwen (0): æ€»è§ˆè®°å¿†ä¸“å®¶
            "å¤§çº²": 0,
            "é£æ ¼å…ƒç´ ": 0,
            "äººç‰©è®¾è®¡": 0,
            "ä¸»é¢˜ç¡®è®¤": 0,
            "å¸‚åœºå®šä½": 0,
            "ä¸–ç•Œè§‚è§„åˆ™": 0,
            
            # DeepSeek (1): é€»è¾‘ç»“æ„ä¸“å®¶
            "äº‹ä»¶": 1,
            "åœºæ™¯ç‰©å“å†²çª": 1,
            "è¯„ä¼°": 1,
            "ä¸€è‡´æ€§æ£€æŸ¥": 1,
            "æ—¶é—´çº¿æ£€æŸ¥": 1,
            "èŠ‚å¥æ£€æŸ¥": 1,
            "ä¼ç¬”åˆ—è¡¨": 1,
            
            # Doubao (2): åˆ›æ„æ–‡ç¬”ä¸“å®¶
            "ç« èŠ‚å†…å®¹": 2,
            "ä¿®è®¢": 2,
            "ç« èŠ‚": 2,
            "åœºæ™¯": 2,
            "æ¶¦è‰²": 2,
            "å¯¹è¯æ£€æŸ¥": 2,
        }
    
    def _select_provider(self, task_type: Optional[str]) -> LLMClientBase:
        """æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æä¾›å•†"""
        if self.strategy == "round_robin":
            # è½®è¯¢ç­–ç•¥
            return self.providers[self._round_robin_index]
        
        elif self.strategy == "task_type_map":
            # ä»»åŠ¡ç±»å‹æ˜ å°„ç­–ç•¥
            if task_type and task_type in self.task_type_map:
                index = self.task_type_map[task_type]
                return self.providers[index]
            # é»˜è®¤ä½¿ç”¨ Doubaoï¼ˆå†…å®¹ç”Ÿæˆæœ€å¤šï¼‰
            return self.providers[2]
        
        return self.providers[0]
    
    async def generate(
        self,
        prompt: str,
        task_type: Optional[str] = None,
        **kwargs
    ) -> Tuple[str, Dict[str, int]]:
        """
        ç”Ÿæˆå†…å®¹ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°æœ€ä¼˜æ¨¡å‹
        
        Args:
            prompt: æç¤ºè¯
            task_type: ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºè·¯ç”±å†³ç­–ï¼‰
            
        Returns:
            (ç”Ÿæˆå†…å®¹, tokenä½¿ç”¨é‡)
        """
        provider = self._select_provider(task_type)
        logger.info(f"Task '{task_type}' routed to {provider.name}")
        
        return await provider.generate(prompt, **kwargs)
```

### 5.6 æ‰§è¡Œæµç¨‹ä¸­çš„æ¨¡å‹åˆ‡æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å°è¯´åˆ›ä½œæ‰§è¡Œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  é˜¶æ®µä¸€ï¼šè§„åˆ’é˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ§  Qwen             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [é£æ ¼] â†’ [ä¸»é¢˜ç¡®è®¤] â†’ [å¸‚åœºå®šä½] â†’ [å¤§çº²] â†’ [äººç‰©è®¾è®¡]      â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Qwen è´Ÿè´£ï¼šç¡®ä¿æ•´ä½“æ¡†æ¶å®Œæ•´ã€è®¾å®šä¸€è‡´ã€æ— é—æ¼               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  é˜¶æ®µäºŒï¼šç»“æ„é˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ” DeepSeek         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [äº‹ä»¶] â†’ [åœºæ™¯ç‰©å“å†²çª] â†’ [ä¼ç¬”åˆ—è¡¨] â†’ [ä¸€è‡´æ€§æ£€æŸ¥]         â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  DeepSeek è´Ÿè´£ï¼šç¡®ä¿é€»è¾‘åˆç†ã€å› æœæ¸…æ™°ã€æ— çŸ›ç›¾               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  é˜¶æ®µä¸‰ï¼šåˆ›ä½œé˜¶æ®µï¼ˆå¾ªç¯ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ¨ Doubao         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  for chapter in chapters:                                   â”‚   â”‚
â”‚  â”‚      [ç« èŠ‚å¤§çº²] â”€â”€â–¶ [åœºæ™¯ç”Ÿæˆ] â”€â”€â–¶ [ç« èŠ‚å†…å®¹] â”€â”€â–¶ [æ¶¦è‰²]      â”‚   â”‚
â”‚  â”‚                           â”‚                                 â”‚   â”‚
â”‚  â”‚                           â–¼                                 â”‚   â”‚
â”‚  â”‚                    ğŸ” DeepSeek: [è¯„ä¼°]                       â”‚   â”‚
â”‚  â”‚                           â”‚                                 â”‚   â”‚
â”‚  â”‚                     é€šè¿‡? â”€â”¼â”€ å¦ â”€â”€â–¶ âœ¨ Doubao: [ä¿®è®¢]       â”‚   â”‚
â”‚  â”‚                           â”‚                                 â”‚   â”‚
â”‚  â”‚                          æ˜¯                                  â”‚   â”‚
â”‚  â”‚                           â–¼                                 â”‚   â”‚
â”‚  â”‚                     ä¿å­˜ï¼Œä¸‹ä¸€ç«                              â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Doubao è´Ÿè´£ï¼šæ–‡ç¬”ä¼˜ç¾ã€å¯¹è¯ç”ŸåŠ¨ã€æƒ…æ„Ÿåˆ°ä½                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.7 é…ç½®ä¸ä½¿ç”¨

#### API å±‚é…ç½®

```python
# src/creative_autogpt/api/server.py

def _create_llm_client(provider: Optional[str]) -> LLMClientBase:
    """åˆ›å»º LLM å®¢æˆ·ç«¯"""
    provider_name = (provider or "aliyun").lower()
    
    # æ™ºèƒ½åˆ†å·¥æ¨¡å¼
    if provider_name == "multi":
        providers = [
            AliyunLLMClient(),    # 0: Qwen - æ€»è§ˆè®°å¿†
            DeepSeekLLMClient(),  # 1: DeepSeek - é€»è¾‘ç»“æ„
            DoubaoLLMClient(),    # 2: Doubao - åˆ›æ„æ–‡ç¬”
        ]
        return MultiLLMClient(
            providers=providers,
            strategy="task_type_map",
        )
    
    # å•ä¸€æ¨¡å‹æ¨¡å¼ï¼ˆä¿æŒå…¼å®¹ï¼‰
    if provider_name == "deepseek":
        return DeepSeekLLMClient()
    if provider_name == "doubao":
        return DoubaoLLMClient()
    return AliyunLLMClient()  # é»˜è®¤ Qwen
```

#### å‰ç«¯é€‰æ‹©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æä¾›å•†                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¤– æ™ºèƒ½åˆ†å·¥ (Multi) â† æ¨è       â”‚   â”‚
â”‚  â”‚   Aliyun (Qwen)                 â”‚   â”‚
â”‚  â”‚   DeepSeek                      â”‚   â”‚
â”‚  â”‚   Doubao (è±†åŒ…)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.8 æˆæœ¬ä¸è´¨é‡ä¼˜åŒ–

| ä»»åŠ¡ç±»å‹ | æ¨¡å‹ | ç›¸å¯¹æˆæœ¬ | è´¨é‡æå‡ |
|---------|------|---------|---------|
| å¤§çº²ã€è®¾å®š | Qwen | ä¸­ç­‰ | â¬†ï¸ å…¨å±€ä¸€è‡´æ€§ +30% |
| é€»è¾‘æ¨ç† | DeepSeek | **æœ€ä½** | â¬†ï¸ é€»è¾‘åˆç†æ€§ +25% |
| å†…å®¹åˆ›ä½œ | Doubao | ä¸­ç­‰ | â¬†ï¸ æ–‡å­¦æ€§ +40% |

**ç»¼åˆæ•ˆæœ**ï¼š
- âœ… **è´¨é‡æ›´é«˜**ï¼šå„æ¨¡å‹å‘æŒ¥ä¸“é•¿ï¼Œæ‰¬é•¿é¿çŸ­
- âœ… **æˆæœ¬æ›´ä¼˜**ï¼šDeepSeek å¤„ç†å¤§é‡é€»è¾‘ä»»åŠ¡ï¼Œæ•´ä½“æˆæœ¬é™ä½çº¦ 20%
- âœ… **å¯é æ€§å¼º**ï¼šå¤šæ¨¡å‹äº’è¡¥ï¼Œå‡å°‘å•ç‚¹æ•…éšœé£é™©

### 5.9 æ•…éšœè½¬ç§»æœºåˆ¶

```python
class MultiLLMClient:
    async def generate(self, prompt: str, task_type: str = None, **kwargs):
        """å¸¦æ•…éšœè½¬ç§»çš„ç”Ÿæˆ"""
        primary = self._select_provider(task_type)
        fallback_order = self._get_fallback_order(primary)
        
        for provider in [primary] + fallback_order:
            try:
                return await provider.generate(prompt, **kwargs)
            except Exception as e:
                logger.warning(f"{provider.name} failed: {e}, trying next...")
        
        raise AllProvidersFailedError("All LLM providers failed")
    
    def _get_fallback_order(self, primary: LLMClientBase) -> List[LLMClientBase]:
        """è·å–æ•…éšœè½¬ç§»é¡ºåº"""
        return [p for p in self.providers if p != primary]
```

---

## å…­ã€æ’ä»¶åŒ–æ¶æ„è®¾è®¡ï¼ˆNovel Element Pluginsï¼‰

### 6.1 è®¾è®¡ç†å¿µ

å°†å°è¯´åˆ›ä½œçš„å„ä¸ªå…ƒç´ æŠ½è±¡ä¸º**ç‹¬ç«‹æ’ä»¶**ï¼Œæ¯ä¸ªæ’ä»¶è´Ÿè´£ç®¡ç†ç‰¹å®šçš„åˆ›ä½œç»´åº¦ï¼Œå®ç°ï¼š
- **é«˜å†…èšä½è€¦åˆ**ï¼šæ¯ä¸ªæ’ä»¶ä¸“æ³¨äºä¸€ä¸ªé¢†åŸŸ
- **å¯æ’æ‹”**ï¼šæ ¹æ®å°è¯´ç±»å‹é€‰æ‹©æ€§åŠ è½½
- **å¯æ‰©å±•**ï¼šè½»æ¾æ·»åŠ æ–°çš„å…ƒç´ ç±»å‹
- **å¯å¤ç”¨**ï¼šè·¨é¡¹ç›®å…±äº«æ’ä»¶é…ç½®

### 6.2 æ’ä»¶ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Plugin Manager (æ’ä»¶ç®¡ç†å™¨)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  register() / unregister() / get() / list_enabled()         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ åŠ è½½
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Element Plugins (å…ƒç´ æ’ä»¶)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  äººç‰©æ¶æ„    â”‚  â”‚  ä¸–ç•Œè§‚æ¶æ„  â”‚  â”‚  äº‹ä»¶æ¶æ„    â”‚              â”‚
â”‚  â”‚  Character   â”‚  â”‚  WorldView   â”‚  â”‚  Event       â”‚              â”‚
â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  æ—¶é—´çº¿æ¶æ„  â”‚  â”‚  èŠ‚å¥æ¶æ„    â”‚  â”‚  ä¼ç¬”æ¶æ„    â”‚              â”‚
â”‚  â”‚  Timeline    â”‚  â”‚  Rhythm      â”‚  â”‚  Foreshadow  â”‚              â”‚
â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  å†²çªæ¶æ„    â”‚  â”‚  å¯¹è¯æ¶æ„    â”‚  â”‚  åœºæ™¯æ¶æ„    â”‚              â”‚
â”‚  â”‚  Conflict    â”‚  â”‚  Dialogue    â”‚  â”‚  Scene       â”‚              â”‚
â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  æƒ…æ„Ÿæ¶æ„    â”‚  â”‚  ä¸»é¢˜æ¶æ„    â”‚  â”‚  å™äº‹æ¶æ„    â”‚              â”‚
â”‚  â”‚  Emotion     â”‚  â”‚  Theme       â”‚  â”‚  Narrative   â”‚              â”‚
â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚  â”‚  Plugin      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ’ä»¶åŸºç±»å®šä¹‰

```python
from abc import ABC, abstractmethod
from typing import Any, Dict, List, Optional
from dataclasses import dataclass, field
from enum import Enum

class PluginPhase(Enum):
    """æ’ä»¶ä»‹å…¥é˜¶æ®µ"""
    PLANNING = "planning"           # è§„åˆ’é˜¶æ®µ
    GENERATION = "generation"       # ç”Ÿæˆé˜¶æ®µ
    EVALUATION = "evaluation"       # è¯„ä¼°é˜¶æ®µ
    POST_PROCESS = "post_process"   # åå¤„ç†é˜¶æ®µ

@dataclass
class PluginConfig:
    """æ’ä»¶é…ç½®"""
    enabled: bool = True
    priority: int = 50              # æ‰§è¡Œä¼˜å…ˆçº§ (0-100, è¶Šå¤§è¶Šå…ˆ)
    phases: List[PluginPhase] = field(default_factory=list)
    settings: Dict[str, Any] = field(default_factory=dict)

class NovelElementPlugin(ABC):
    """å°è¯´å…ƒç´ æ’ä»¶åŸºç±»"""
    
    # æ’ä»¶å…ƒä¿¡æ¯
    name: str                       # æ’ä»¶åç§°
    version: str = "1.0.0"          # ç‰ˆæœ¬å·
    description: str = ""           # æè¿°
    author: str = ""                # ä½œè€…
    
    # ä¾èµ–çš„å…¶ä»–æ’ä»¶
    dependencies: List[str] = []
    
    # é»˜è®¤é…ç½®
    default_config: PluginConfig = PluginConfig()
    
    def __init__(self, config: Optional[PluginConfig] = None):
        self.config = config or self.default_config
    
    # ============ ç”Ÿå‘½å‘¨æœŸé’©å­ ============
    
    @abstractmethod
    async def on_init(self, context: "WritingContext") -> None:
        """åˆå§‹åŒ–æ—¶è°ƒç”¨"""
        pass
    
    async def on_before_task(self, task: "Task", context: "WritingContext") -> "Task":
        """ä»»åŠ¡æ‰§è¡Œå‰è°ƒç”¨ï¼Œå¯ä¿®æ”¹ä»»åŠ¡"""
        return task
    
    async def on_after_task(self, task: "Task", result: str, context: "WritingContext") -> str:
        """ä»»åŠ¡æ‰§è¡Œåè°ƒç”¨ï¼Œå¯ä¿®æ”¹ç»“æœ"""
        return result
    
    async def on_finalize(self, context: "WritingContext") -> None:
        """å®Œæˆæ—¶è°ƒç”¨"""
        pass
    
    # ============ æ ¸å¿ƒèƒ½åŠ› ============
    
    @abstractmethod
    def get_schema(self) -> Dict[str, Any]:
        """è¿”å›è¯¥å…ƒç´ çš„æ•°æ®ç»“æ„å®šä¹‰"""
        pass
    
    @abstractmethod
    def get_prompts(self) -> Dict[str, str]:
        """è¿”å›è¯¥å…ƒç´ ç›¸å…³çš„æç¤ºè¯æ¨¡æ¿"""
        pass
    
    @abstractmethod
    def get_tasks(self) -> List["TaskDefinition"]:
        """è¿”å›è¯¥å…ƒç´ éœ€è¦çš„ä»»åŠ¡å®šä¹‰"""
        pass
    
    @abstractmethod
    async def validate(self, data: Any, context: "WritingContext") -> "ValidationResult":
        """éªŒè¯è¯¥å…ƒç´ æ•°æ®çš„ä¸€è‡´æ€§"""
        pass
    
    @abstractmethod
    async def enrich_context(self, task: "Task", context: Dict[str, Any]) -> Dict[str, Any]:
        """ä¸ºä»»åŠ¡ä¸°å¯Œä¸Šä¸‹æ–‡ä¿¡æ¯"""
        return context
```

### 6.4 æ ¸å¿ƒæ’ä»¶è¯¦ç»†è®¾è®¡

#### 6.4.1 äººç‰©æ¶æ„æ’ä»¶ (CharacterPlugin)

```python
class CharacterPlugin(NovelElementPlugin):
    """
    äººç‰©æ¶æ„æ’ä»¶ - ç®¡ç†å°è¯´ä¸­çš„æ‰€æœ‰äººç‰©å…ƒç´ 
    
    åŠŸèƒ½ï¼š
    - äººç‰©è®¾è®¡ï¼ˆå¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯ï¼‰
    - äººç‰©å…³ç³»ç½‘ç»œ
    - äººç‰©å¼§å…‰ï¼ˆæˆé•¿è½¨è¿¹ï¼‰
    - äººç‰©è¯­è¨€é£æ ¼
    - äººç‰©åŠ¨æœºä¸å†²çª
    """
    
    name = "character"
    description = "ç®¡ç†å°è¯´äººç‰©çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ"
    
    def get_schema(self) -> Dict[str, Any]:
        return {
            "Character": {
                "id": "str",                    # å”¯ä¸€æ ‡è¯†
                "name": "str",                  # å§“å
                "aliases": "List[str]",         # åˆ«å/å¤–å·
                "role": "Enum[protagonist, antagonist, supporting, minor]",
                "profile": {
                    "age": "int",
                    "gender": "str",
                    "appearance": "str",        # å¤–è²Œæè¿°
                    "personality": "List[str]", # æ€§æ ¼ç‰¹å¾
                    "background": "str",        # èƒŒæ™¯æ•…äº‹
                    "occupation": "str",        # èŒä¸š
                    "abilities": "List[str]",   # èƒ½åŠ›/æŠ€èƒ½
                },
                "psychology": {
                    "motivation": "str",        # æ ¸å¿ƒåŠ¨æœº
                    "fear": "str",              # ææƒ§
                    "desire": "str",            # æ¬²æœ›
                    "flaw": "str",              # æ€§æ ¼ç¼ºé™·
                    "belief": "str",            # ä¿¡å¿µ
                },
                "arc": {
                    "start_state": "str",       # èµ·å§‹çŠ¶æ€
                    "end_state": "str",         # ç»“æŸçŠ¶æ€
                    "turning_points": "List[TurningPoint]",  # è½¬æŠ˜ç‚¹
                },
                "speech_style": {
                    "tone": "str",              # è¯­æ°”
                    "vocabulary": "str",        # è¯æ±‡ç‰¹ç‚¹
                    "quirks": "List[str]",      # å£å¤´ç¦…/ä¹ æƒ¯
                },
                "relationships": "List[Relationship]",
            },
            "Relationship": {
                "target_id": "str",             # å…³ç³»å¯¹è±¡
                "type": "Enum[family, friend, enemy, lover, mentor, rival]",
                "description": "str",
                "evolution": "List[RelationshipChange]",  # å…³ç³»å˜åŒ–
            },
            "TurningPoint": {
                "chapter": "int",
                "event": "str",
                "change": "str",
            }
        }
    
    def get_tasks(self) -> List["TaskDefinition"]:
        return [
            TaskDefinition(
                type="äººç‰©è®¾è®¡",
                description="è®¾è®¡å°è¯´ä¸»è¦äººç‰©",
                depends_on=["å¤§çº²"],
                output_schema="List[Character]",
            ),
            TaskDefinition(
                type="äººç‰©å…³ç³»",
                description="è®¾è®¡äººç‰©å…³ç³»ç½‘ç»œ",
                depends_on=["äººç‰©è®¾è®¡"],
                output_schema="List[Relationship]",
            ),
            TaskDefinition(
                type="äººç‰©å¼§å…‰",
                description="è®¾è®¡äººç‰©æˆé•¿è½¨è¿¹",
                depends_on=["äººç‰©è®¾è®¡", "å¤§çº²"],
                output_schema="List[CharacterArc]",
            ),
            TaskDefinition(
                type="äººç‰©è¯­è¨€",
                description="è®¾è®¡äººç‰©è¯­è¨€é£æ ¼",
                depends_on=["äººç‰©è®¾è®¡"],
                output_schema="List[SpeechStyle]",
            ),
        ]
    
    async def validate(self, data: Any, context: "WritingContext") -> "ValidationResult":
        """éªŒè¯äººç‰©ä¸€è‡´æ€§"""
        errors = []
        warnings = []
        
        characters = data.get("characters", [])
        content = context.get_all_content()
        
        for char in characters:
            # æ£€æŸ¥äººç‰©æ˜¯å¦å‡ºç°åœ¨å†…å®¹ä¸­
            if char["name"] not in content:
                warnings.append(f"äººç‰© {char['name']} åœ¨æ­£æ–‡ä¸­æœªå‡ºç°")
            
            # æ£€æŸ¥æ€§æ ¼ä¸€è‡´æ€§
            inconsistencies = await self._check_personality_consistency(char, content)
            errors.extend(inconsistencies)
            
            # æ£€æŸ¥å…³ç³»ä¸€è‡´æ€§
            relationship_issues = await self._check_relationship_consistency(char, characters)
            errors.extend(relationship_issues)
        
        return ValidationResult(
            valid=len(errors) == 0,
            errors=errors,
            warnings=warnings,
        )
    
    async def enrich_context(self, task: "Task", context: Dict[str, Any]) -> Dict[str, Any]:
        """ä¸ºä»»åŠ¡æ·»åŠ äººç‰©ç›¸å…³ä¸Šä¸‹æ–‡"""
        if task.type in ["ç« èŠ‚", "åœºæ™¯", "å¯¹è¯"]:
            # æå–è¯¥ç« èŠ‚æ¶‰åŠçš„äººç‰©
            involved_characters = self._extract_involved_characters(task)
            context["involved_characters"] = involved_characters
            
            # æ·»åŠ äººç‰©å…³ç³»ä¿¡æ¯
            context["character_relationships"] = self._get_relationships(involved_characters)
            
            # æ·»åŠ äººç‰©å½“å‰çŠ¶æ€ï¼ˆå¼§å…‰è¿›åº¦ï¼‰
            context["character_states"] = self._get_current_states(task.metadata.get("chapter_index", 1))
        
        return context
```

#### 6.4.2 ä¸–ç•Œè§‚æ¶æ„æ’ä»¶ (WorldViewPlugin)

```python
class WorldViewPlugin(NovelElementPlugin):
    """
    ä¸–ç•Œè§‚æ¶æ„æ’ä»¶ - ç®¡ç†å°è¯´ä¸–ç•Œçš„æ‰€æœ‰è®¾å®š
    
    åŠŸèƒ½ï¼š
    - ä¸–ç•ŒåŸºç¡€è®¾å®šï¼ˆæ—¶ä»£ã€åœ°ç‚¹ã€ç¤¾ä¼šï¼‰
    - è§„åˆ™ç³»ç»Ÿï¼ˆé­”æ³•/ç§‘æŠ€/ç¤¾ä¼šè§„åˆ™ï¼‰
    - å†å²ä¸ä¼ è¯´
    - åœ°ç†ä¸åŠ¿åŠ›
    - ç‰©å“ä¸é“å…·ç³»ç»Ÿ
    """
    
    name = "worldview"
    description = "ç®¡ç†å°è¯´ä¸–ç•Œè§‚çš„å®Œæ•´ä½“ç³»"
    
    def get_schema(self) -> Dict[str, Any]:
        return {
            "World": {
                "name": "str",                  # ä¸–ç•Œåç§°
                "type": "Enum[fantasy, scifi, modern, historical, mixed]",
                "era": "str",                   # æ—¶ä»£èƒŒæ™¯
                "tone": "str",                  # ä¸–ç•ŒåŸºè°ƒ
                
                "physics": {                    # ç‰©ç†è§„åˆ™
                    "magic_system": "Optional[MagicSystem]",
                    "technology_level": "str",
                    "special_rules": "List[str]",
                },
                
                "society": {                    # ç¤¾ä¼šç»“æ„
                    "political_system": "str",
                    "economic_system": "str",
                    "social_classes": "List[SocialClass]",
                    "cultures": "List[Culture]",
                },
                
                "geography": {                  # åœ°ç†
                    "locations": "List[Location]",
                    "map_description": "str",
                },
                
                "history": {                    # å†å²
                    "timeline": "List[HistoricalEvent]",
                    "legends": "List[Legend]",
                },
                
                "factions": "List[Faction]",    # åŠ¿åŠ›
            },
            
            "MagicSystem": {
                "name": "str",
                "source": "str",                # é­”åŠ›æ¥æº
                "rules": "List[str]",           # è§„åˆ™é™åˆ¶
                "costs": "str",                 # ä»£ä»·
                "levels": "List[str]",          # ç­‰çº§ä½“ç³»
            },
            
            "Location": {
                "id": "str",
                "name": "str",
                "type": "Enum[city, village, wilderness, dungeon, building]",
                "description": "str",
                "significance": "str",          # å¯¹å‰§æƒ…çš„æ„ä¹‰
                "connected_to": "List[str]",    # è¿æ¥çš„åœ°ç‚¹
            },
            
            "Faction": {
                "id": "str",
                "name": "str",
                "type": "str",
                "ideology": "str",
                "leaders": "List[str]",         # å…³è”äººç‰©ID
                "rivals": "List[str]",          # æ•Œå¯¹åŠ¿åŠ›
                "allies": "List[str]",          # ç›Ÿå‹åŠ¿åŠ›
            },
            
            "Item": {
                "id": "str",
                "name": "str",
                "type": "Enum[weapon, artifact, consumable, key_item, treasure]",
                "description": "str",
                "abilities": "List[str]",
                "owner_history": "List[str]",   # å†ä»»æŒæœ‰è€…
                "plot_significance": "str",     # å¯¹å‰§æƒ…çš„æ„ä¹‰
            }
        }
    
    def get_tasks(self) -> List["TaskDefinition"]:
        return [
            TaskDefinition(
                type="ä¸–ç•Œè®¾å®š",
                description="è®¾è®¡ä¸–ç•ŒåŸºç¡€è®¾å®š",
                depends_on=["ä¸»é¢˜ç¡®è®¤"],
                output_schema="World",
            ),
            TaskDefinition(
                type="è§„åˆ™ç³»ç»Ÿ",
                description="è®¾è®¡ä¸–ç•Œè§„åˆ™ä½“ç³»",
                depends_on=["ä¸–ç•Œè®¾å®š"],
                output_schema="RuleSystem",
            ),
            TaskDefinition(
                type="åœ°ç†åŠ¿åŠ›",
                description="è®¾è®¡åœ°ç†å’ŒåŠ¿åŠ›åˆ†å¸ƒ",
                depends_on=["ä¸–ç•Œè®¾å®š"],
                output_schema="GeographyAndFactions",
            ),
            TaskDefinition(
                type="ç‰©å“ç³»ç»Ÿ",
                description="è®¾è®¡é‡è¦ç‰©å“å’Œé“å…·",
                depends_on=["ä¸–ç•Œè®¾å®š", "å¤§çº²"],
                output_schema="List[Item]",
            ),
            TaskDefinition(
                type="å†å²ä¼ è¯´",
                description="è®¾è®¡å†å²èƒŒæ™¯å’Œä¼ è¯´",
                depends_on=["ä¸–ç•Œè®¾å®š"],
                output_schema="History",
            ),
        ]
    
    async def validate(self, data: Any, context: "WritingContext") -> "ValidationResult":
        """éªŒè¯ä¸–ç•Œè§‚ä¸€è‡´æ€§"""
        errors = []
        
        # æ£€æŸ¥è§„åˆ™æ˜¯å¦è‡ªæ´½
        rule_conflicts = self._check_rule_consistency(data.get("physics", {}))
        errors.extend(rule_conflicts)
        
        # æ£€æŸ¥åœ°ç†æ˜¯å¦åˆç†
        geo_issues = self._check_geography_consistency(data.get("geography", {}))
        errors.extend(geo_issues)
        
        # æ£€æŸ¥åŠ¿åŠ›å…³ç³»æ˜¯å¦çŸ›ç›¾
        faction_issues = self._check_faction_consistency(data.get("factions", []))
        errors.extend(faction_issues)
        
        return ValidationResult(valid=len(errors) == 0, errors=errors)
```

#### 6.4.3 äº‹ä»¶æ¶æ„æ’ä»¶ (EventPlugin)

```python
class EventPlugin(NovelElementPlugin):
    """
    äº‹ä»¶æ¶æ„æ’ä»¶ - ç®¡ç†å°è¯´ä¸­çš„æ‰€æœ‰æƒ…èŠ‚äº‹ä»¶
    
    åŠŸèƒ½ï¼š
    - ä¸»çº¿äº‹ä»¶
    - æ”¯çº¿äº‹ä»¶
    - äº‹ä»¶å› æœé“¾
    - å†²çªç®¡ç†
    - è½¬æŠ˜ç‚¹è®¾è®¡
    """
    
    name = "event"
    description = "ç®¡ç†å°è¯´æƒ…èŠ‚äº‹ä»¶çš„å®Œæ•´ä½“ç³»"
    
    def get_schema(self) -> Dict[str, Any]:
        return {
            "Event": {
                "id": "str",
                "name": "str",
                "type": "Enum[main_plot, subplot, flashback, foreshadow]",
                "chapter": "int",               # å‘ç”Ÿç« èŠ‚
                "scene": "Optional[int]",       # å‘ç”Ÿåœºæ™¯
                
                "description": "str",
                "participants": "List[str]",    # å‚ä¸äººç‰©ID
                "location": "str",              # å‘ç”Ÿåœ°ç‚¹ID
                
                "cause": "Optional[str]",       # èµ·å› äº‹ä»¶ID
                "effects": "List[str]",         # å¯¼è‡´çš„äº‹ä»¶ID
                
                "stakes": "str",                # é£é™©/åˆ©å®³
                "outcome": "str",               # ç»“æœ
                
                "emotional_beat": "Enum[rising, falling, climax, resolution]",
            },
            
            "PlotLine": {
                "id": "str",
                "name": "str",
                "type": "Enum[main, sub, romance, mystery, growth]",
                "events": "List[str]",          # äº‹ä»¶IDåˆ—è¡¨
                "start_chapter": "int",
                "end_chapter": "int",
                "resolution": "str",
            },
            
            "Conflict": {
                "id": "str",
                "type": "Enum[person_vs_person, person_vs_nature, person_vs_society, person_vs_self, person_vs_fate]",
                "parties": "List[str]",         # å†²çªå„æ–¹
                "stakes": "str",
                "escalation": "List[str]",      # å‡çº§äº‹ä»¶
                "resolution": "Optional[str]",
            },
            
            "TurningPoint": {
                "id": "str",
                "chapter": "int",
                "type": "Enum[inciting_incident, first_plot_point, midpoint, crisis, climax, resolution]",
                "event_id": "str",
                "before_state": "str",
                "after_state": "str",
            }
        }
    
    def get_tasks(self) -> List["TaskDefinition"]:
        return [
            TaskDefinition(
                type="ä¸»çº¿äº‹ä»¶",
                description="è®¾è®¡ä¸»çº¿æƒ…èŠ‚äº‹ä»¶",
                depends_on=["å¤§çº²"],
                output_schema="List[Event]",
            ),
            TaskDefinition(
                type="æ”¯çº¿äº‹ä»¶",
                description="è®¾è®¡æ”¯çº¿æƒ…èŠ‚",
                depends_on=["ä¸»çº¿äº‹ä»¶", "äººç‰©è®¾è®¡"],
                output_schema="List[PlotLine]",
            ),
            TaskDefinition(
                type="å†²çªè®¾è®¡",
                description="è®¾è®¡æ ¸å¿ƒå†²çª",
                depends_on=["ä¸»çº¿äº‹ä»¶", "äººç‰©è®¾è®¡"],
                output_schema="List[Conflict]",
            ),
            TaskDefinition(
                type="è½¬æŠ˜ç‚¹",
                description="è®¾è®¡å…³é”®è½¬æŠ˜ç‚¹",
                depends_on=["ä¸»çº¿äº‹ä»¶", "å†²çªè®¾è®¡"],
                output_schema="List[TurningPoint]",
            ),
            TaskDefinition(
                type="äº‹ä»¶å› æœ",
                description="å»ºç«‹äº‹ä»¶å› æœé“¾",
                depends_on=["ä¸»çº¿äº‹ä»¶", "æ”¯çº¿äº‹ä»¶"],
                output_schema="EventCausalChain",
            ),
        ]
```

#### 6.4.4 æ—¶é—´çº¿æ¶æ„æ’ä»¶ (TimelinePlugin)

```python
class TimelinePlugin(NovelElementPlugin):
    """
    æ—¶é—´çº¿æ¶æ„æ’ä»¶ - ç®¡ç†å°è¯´çš„æ—¶é—´ç»“æ„
    
    åŠŸèƒ½ï¼š
    - æ•…äº‹æ—¶é—´çº¿ï¼ˆæ•…äº‹å†…æ—¶é—´ï¼‰
    - å™äº‹æ—¶é—´çº¿ï¼ˆå™è¿°é¡ºåºï¼‰
    - æ—¶é—´è·³è·ƒä¸é—ªå›
    - å¹¶è¡Œå™äº‹
    - æ—¶é—´ä¸€è‡´æ€§æ£€æŸ¥
    """
    
    name = "timeline"
    description = "ç®¡ç†å°è¯´æ—¶é—´ç»“æ„"
    
    def get_schema(self) -> Dict[str, Any]:
        return {
            "Timeline": {
                "story_start": "datetime",      # æ•…äº‹å¼€å§‹æ—¶é—´
                "story_end": "datetime",        # æ•…äº‹ç»“æŸæ—¶é—´
                "narrative_style": "Enum[linear, nonlinear, circular, parallel]",
            },
            
            "TimePoint": {
                "id": "str",
                "story_time": "datetime",       # æ•…äº‹å†…æ—¶é—´
                "narrative_order": "int",       # å™è¿°é¡ºåº
                "chapter": "int",
                "events": "List[str]",          # è¯¥æ—¶é—´ç‚¹çš„äº‹ä»¶
                "duration": "timedelta",        # æŒç»­æ—¶é—´
            },
            
            "Flashback": {
                "id": "str",
                "trigger_chapter": "int",       # è§¦å‘ç« èŠ‚
                "target_time": "datetime",      # é—ªå›åˆ°çš„æ—¶é—´
                "content": "str",
                "purpose": "str",               # é—ªå›ç›®çš„
            },
            
            "ParallelNarrative": {
                "id": "str",
                "threads": "List[NarrativeThread]",
                "convergence_point": "Optional[str]",  # æ±‡åˆç‚¹
            }
        }
    
    async def validate(self, data: Any, context: "WritingContext") -> "ValidationResult":
        """éªŒè¯æ—¶é—´çº¿ä¸€è‡´æ€§"""
        errors = []
        
        # æ£€æŸ¥æ—¶é—´é¡ºåºå†²çª
        time_conflicts = self._check_temporal_consistency(data)
        errors.extend(time_conflicts)
        
        # æ£€æŸ¥è§’è‰²å¹´é¾„ä¸€è‡´æ€§
        age_issues = self._check_age_consistency(data, context.get("characters"))
        errors.extend(age_issues)
        
        # æ£€æŸ¥äº‹ä»¶æ—¶é—´æ˜¯å¦åˆç†
        event_timing = self._check_event_timing(data, context.get("events"))
        errors.extend(event_timing)
        
        return ValidationResult(valid=len(errors) == 0, errors=errors)
```

#### 6.4.5 ä¼ç¬”æ¶æ„æ’ä»¶ (ForeshadowPlugin)

```python
class ForeshadowPlugin(NovelElementPlugin):
    """
    ä¼ç¬”æ¶æ„æ’ä»¶ - ç®¡ç†å°è¯´ä¸­çš„ä¼ç¬”ä¸å›æ”¶
    
    åŠŸèƒ½ï¼š
    - ä¼ç¬”è®¾è®¡
    - ä¼ç¬”è·Ÿè¸ª
    - å›æ”¶æé†’
    - ä¼ç¬”å¯†åº¦æ§åˆ¶
    """
    
    name = "foreshadow"
    description = "ç®¡ç†å°è¯´ä¼ç¬”çš„åŸ‹è®¾ä¸å›æ”¶"
    
    def get_schema(self) -> Dict[str, Any]:
        return {
            "Foreshadow": {
                "id": "str",
                "name": "str",
                "type": "Enum[plot, character, worldview, dialogue, item, scene]",
                
                "plant": {                      # åŸ‹è®¾
                    "chapter": "int",
                    "scene": "Optional[int]",
                    "method": "str",            # åŸ‹è®¾æ–¹å¼
                    "content": "str",           # ä¼ç¬”å†…å®¹
                    "subtlety": "Enum[obvious, subtle, hidden]",
                },
                
                "payoffs": List[{               # å›æ”¶ï¼ˆå¯å¤šæ¬¡ï¼‰
                    "chapter": "int",
                    "method": "str",
                    "impact": "str",
                }],
                
                "status": "Enum[planted, partially_paid, fully_paid, abandoned]",
                "importance": "Enum[major, moderate, minor]",
                "related_to": "List[str]",      # å…³è”å…ƒç´ ID
            },
            
            "ForeshadowChain": {                 # ä¼ç¬”é“¾
                "id": "str",
                "foreshadows": "List[str]",     # ä¼ç¬”IDåˆ—è¡¨
                "final_payoff": "str",          # æœ€ç»ˆå›æ”¶
            }
        }
    
    async def on_before_task(self, task: "Task", context: "WritingContext") -> "Task":
        """åœ¨ç« èŠ‚ä»»åŠ¡å‰æ³¨å…¥éœ€è¦åŸ‹è®¾çš„ä¼ç¬”"""
        if task.type in ["ç« èŠ‚", "åœºæ™¯"]:
            chapter = task.metadata.get("chapter_index", 1)
            foreshadows_to_plant = self._get_foreshadows_for_chapter(chapter, "plant")
            foreshadows_to_payoff = self._get_foreshadows_for_chapter(chapter, "payoff")
            
            task.metadata["foreshadows_to_plant"] = foreshadows_to_plant
            task.metadata["foreshadows_to_payoff"] = foreshadows_to_payoff
        
        return task
    
    async def on_after_task(self, task: "Task", result: str, context: "WritingContext") -> str:
        """æ£€æŸ¥ä¼ç¬”æ˜¯å¦æ­£ç¡®åŸ‹è®¾/å›æ”¶"""
        if task.type in ["ç« èŠ‚", "åœºæ™¯"]:
            # éªŒè¯ä¼ç¬”åŸ‹è®¾
            planted = task.metadata.get("foreshadows_to_plant", [])
            for f in planted:
                if not self._verify_foreshadow_planted(f, result):
                    # å¯ä»¥è§¦å‘é‡å†™æˆ–å‘å‡ºè­¦å‘Š
                    context.add_warning(f"ä¼ç¬” '{f['name']}' å¯èƒ½æœªæ­£ç¡®åŸ‹è®¾")
        
        return result
```

#### 6.4.6 å…¶ä»–æ ¸å¿ƒæ’ä»¶

```python
# èŠ‚å¥æ¶æ„æ’ä»¶
class RhythmPlugin(NovelElementPlugin):
    """ç®¡ç†å™äº‹èŠ‚å¥ï¼šé«˜æ½®ã€ä½è°·ã€å¼ å¼›æœ‰åº¦"""
    name = "rhythm"
    # èŠ‚å¥æ›²çº¿ã€æƒ…æ„ŸèŠ‚å¥ã€åœºæ™¯èŠ‚å¥...

# å¯¹è¯æ¶æ„æ’ä»¶
class DialoguePlugin(NovelElementPlugin):
    """ç®¡ç†å¯¹è¯ï¼šé£æ ¼ã€æ½œå°è¯ã€ä¿¡æ¯ä¼ é€’"""
    name = "dialogue"
    # å¯¹è¯é£æ ¼ã€äººç‰©åŒºåˆ†ã€æ½œå°è¯è®¾è®¡...

# åœºæ™¯æ¶æ„æ’ä»¶
class ScenePlugin(NovelElementPlugin):
    """ç®¡ç†åœºæ™¯ï¼šç¯å¢ƒã€æ°›å›´ã€æ„Ÿå®˜ç»†èŠ‚"""
    name = "scene"
    # åœºæ™¯æå†™ã€æ„Ÿå®˜ç»†èŠ‚ã€ç¯å¢ƒä¸æƒ…ç»ª...

# æƒ…æ„Ÿæ¶æ„æ’ä»¶
class EmotionPlugin(NovelElementPlugin):
    """ç®¡ç†æƒ…æ„Ÿï¼šäººç‰©æƒ…æ„Ÿã€è¯»è€…æƒ…æ„Ÿ"""
    name = "emotion"
    # æƒ…æ„Ÿå¼§çº¿ã€å…±é¸£ç‚¹ã€æƒ…æ„Ÿè½¬å˜...

# ä¸»é¢˜æ¶æ„æ’ä»¶
class ThemePlugin(NovelElementPlugin):
    """ç®¡ç†ä¸»é¢˜ï¼šæ ¸å¿ƒä¸»é¢˜ã€æ¬¡è¦ä¸»é¢˜ã€ä¸»é¢˜æ·±åŒ–"""
    name = "theme"
    # ä¸»é¢˜è¡¨è¾¾ã€è±¡å¾æ„è±¡ã€ä¸»é¢˜å‘¼åº”...

# å™äº‹æ¶æ„æ’ä»¶
class NarrativePlugin(NovelElementPlugin):
    """ç®¡ç†å™äº‹ï¼šè§†è§’ã€å™è¿°è€…ã€å™äº‹æŠ€å·§"""
    name = "narrative"
    # POVç®¡ç†ã€å™è¿°è·ç¦»ã€å™äº‹å¯é æ€§...

# æ‚¬å¿µæ¶æ„æ’ä»¶
class SuspensePlugin(NovelElementPlugin):
    """ç®¡ç†æ‚¬å¿µï¼šè°œé¢˜ã€æ­ç¤ºã€æƒŠå¥‡"""
    name = "suspense"
    # æ‚¬å¿µè®¾ç½®ã€æ­ç¤ºæ—¶æœºã€ä¿¡æ¯æ§åˆ¶...

# è±¡å¾æ¶æ„æ’ä»¶
class SymbolPlugin(NovelElementPlugin):
    """ç®¡ç†è±¡å¾ï¼šæ„è±¡ã€éšå–»ã€è±¡å¾ä½“ç³»"""
    name = "symbol"
    # æ ¸å¿ƒæ„è±¡ã€è±¡å¾æ˜ å°„ã€æ„è±¡ä¸€è‡´æ€§...
```

### 6.5 æ’ä»¶ç®¡ç†å™¨

```python
class PluginManager:
    """æ’ä»¶ç®¡ç†å™¨"""
    
    def __init__(self):
        self._plugins: Dict[str, NovelElementPlugin] = {}
        self._enabled: Set[str] = set()
        self._load_order: List[str] = []
    
    def register(self, plugin: NovelElementPlugin) -> None:
        """æ³¨å†Œæ’ä»¶"""
        # æ£€æŸ¥ä¾èµ–
        for dep in plugin.dependencies:
            if dep not in self._plugins:
                raise PluginDependencyError(f"Plugin {plugin.name} requires {dep}")
        
        self._plugins[plugin.name] = plugin
        self._recalculate_load_order()
    
    def enable(self, name: str, config: Optional[PluginConfig] = None) -> None:
        """å¯ç”¨æ’ä»¶"""
        if name in self._plugins:
            if config:
                self._plugins[name].config = config
            self._enabled.add(name)
    
    def disable(self, name: str) -> None:
        """ç¦ç”¨æ’ä»¶"""
        self._enabled.discard(name)
    
    def get_enabled_plugins(self, phase: Optional[PluginPhase] = None) -> List[NovelElementPlugin]:
        """è·å–å¯ç”¨çš„æ’ä»¶åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰"""
        plugins = [self._plugins[name] for name in self._enabled if name in self._plugins]
        
        if phase:
            plugins = [p for p in plugins if phase in p.config.phases]
        
        return sorted(plugins, key=lambda p: p.config.priority, reverse=True)
    
    def get_all_tasks(self) -> List["TaskDefinition"]:
        """è·å–æ‰€æœ‰å¯ç”¨æ’ä»¶çš„ä»»åŠ¡å®šä¹‰"""
        tasks = []
        for plugin in self.get_enabled_plugins():
            tasks.extend(plugin.get_tasks())
        return self._resolve_task_dependencies(tasks)
    
    def get_all_schemas(self) -> Dict[str, Any]:
        """è·å–æ‰€æœ‰å¯ç”¨æ’ä»¶çš„æ•°æ®ç»“æ„å®šä¹‰"""
        schemas = {}
        for plugin in self.get_enabled_plugins():
            schemas[plugin.name] = plugin.get_schema()
        return schemas
    
    async def run_hook(self, hook_name: str, *args, **kwargs) -> Any:
        """è¿è¡Œæ‰€æœ‰æ’ä»¶çš„æŒ‡å®šé’©å­"""
        result = kwargs.get("initial_value")
        
        for plugin in self.get_enabled_plugins():
            hook = getattr(plugin, hook_name, None)
            if hook and callable(hook):
                result = await hook(*args, **kwargs, previous_result=result)
        
        return result
```

### 6.6 æ™ºèƒ½è·¯ç”±æ’ä»¶ï¼ˆSmart Routingï¼‰

æ™ºèƒ½è·¯ç”±æ’ä»¶ç”¨äºåœ¨**è§„åˆ’é˜¶æ®µ**å’Œ**æ‰§è¡Œé˜¶æ®µ**åšåŠ¨æ€å†³ç­–ï¼Œå†³å®šï¼š

- å½“å‰ä»»åŠ¡åº”è¯¥èµ°**å“ªæ¡å†™ä½œè·¯å¾„**ï¼ˆå¿«å†™/æ…¢å†™/ç»“æ„ä¼˜å…ˆï¼‰
- å½“å‰ç« èŠ‚éœ€è¦**å“ªäº›æ’ä»¶æ·±åº¦ä»‹å…¥**ï¼ˆä¾‹å¦‚æƒ…æ„Ÿã€æ‚¬å¿µã€ä¼ç¬”ï¼‰
- æ˜¯å¦è§¦å‘**å›æº¯é‡å†™**æˆ–**ä¸€è‡´æ€§ä¿®å¤**

**ä½œç”¨å®šä½**ï¼šå®ƒä¸æ˜¯å…ƒç´ æ’ä»¶ï¼Œè€Œæ˜¯**è°ƒåº¦/ç¼–æ’æ’ä»¶**ï¼Œå±äºâ€œå…¨å±€ç­–ç•¥å±‚â€ã€‚

```python
class SmartRoutingPlugin(NovelElementPlugin):
    """æ™ºèƒ½è·¯ç”±æ’ä»¶ï¼ˆå…¨å±€ç­–ç•¥æ’ä»¶ï¼‰"""

    name = "smart_routing"
    description = "åŠ¨æ€é€‰æ‹©ä»»åŠ¡è·¯å¾„ä¸æ’ä»¶ç»„åˆ"
    dependencies = []  # ä¸ä¾èµ–å…·ä½“å…ƒç´ æ’ä»¶

    def get_schema(self) -> Dict[str, Any]:
        return {}

    def get_prompts(self) -> Dict[str, str]:
        return {
            "route_decision": "routing_decision",
        }

    def get_tasks(self) -> List["TaskDefinition"]:
        # ä½œä¸ºå…¨å±€ç­–ç•¥æ’ä»¶ï¼Œä¸ç”Ÿæˆä¸šåŠ¡ä»»åŠ¡
        return []

    async def on_before_task(self, task: "Task", context: "WritingContext") -> "Task":
        """åœ¨ä»»åŠ¡æ‰§è¡Œå‰åšè·¯ç”±å†³ç­–"""
        decision = await self._decide_route(task, context)
        
        # ç¤ºä¾‹ï¼šæ ¹æ®ç« èŠ‚ç±»å‹åŠ¨æ€å¯ç”¨/ç¦ç”¨æ’ä»¶
        if decision.get("need_suspense"):
            context.enable_plugin("suspense")
        if decision.get("need_emotion"):
            context.enable_plugin("emotion")

        # ç¤ºä¾‹ï¼šåŠ¨æ€è°ƒæ•´ä»»åŠ¡ç›®æ ‡
        if decision.get("rewrite_focus"):
            task.metadata["rewrite_focus"] = decision["rewrite_focus"]
        
        return task

    async def _decide_route(self, task: "Task", context: "WritingContext") -> Dict[str, Any]:
        """è·¯ç”±å†³ç­–é€»è¾‘ï¼Œå¯ç”±è§„åˆ™ + LLM è”åˆé©±åŠ¨"""
        # è§„åˆ™å±‚ï¼šåŸºäºç« èŠ‚åºå·/èŠ‚å¥/äº‹ä»¶å¯†åº¦
        # LLMå±‚ï¼šåŸºäºå½“å‰ä¸Šä¸‹æ–‡å’Œç›®æ ‡
        return {
            "need_suspense": task.type in ["ç« èŠ‚", "åœºæ™¯"],
            "need_emotion": task.metadata.get("chapter_index", 1) % 5 == 0,
            "rewrite_focus": "èŠ‚å¥ä¸å†²çª" if task.type == "ç« èŠ‚" else None,
        }
```

**åœ¨æ¶æ„ä¸­çš„ä½œç”¨**ï¼š
- ä¸ `PluginManager.run_hook()` é…åˆï¼Œåœ¨ `on_before_task` å’Œ `on_after_task` ä¸­ç”Ÿæ•ˆ
- ä¸ºä¸­é•¿ç¯‡æä¾›â€œåŠ¨æ€ç¼–æ’â€ï¼Œé¿å…å›ºå®šæµæ°´çº¿åƒµåŒ–
- å¯æ¥å…¥ç”¨æˆ·åå¥½ã€è¯»è€…åé¦ˆã€ç« èŠ‚è´¨é‡è¯„åˆ†

### 6.7 æ’ä»¶é…ç½®ç¤ºä¾‹

```yaml
# novel_config.yaml - å°è¯´é¡¹ç›®æ’ä»¶é…ç½®

plugins:
  # æ ¸å¿ƒæ’ä»¶ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
  character:
    enabled: true
    priority: 100
    settings:
      max_main_characters: 5
      require_relationship_map: true
      
  worldview:
    enabled: true
    priority: 95
    settings:
      complexity: "high"  # low, medium, high
      require_magic_system: true  # ä»™ä¾ /å¥‡å¹»éœ€è¦
      
  event:
    enabled: true
    priority: 90
    settings:
      require_conflict: true
      min_turning_points: 3
      
  timeline:
    enabled: true
    priority: 85
    settings:
      allow_nonlinear: true
      require_consistency_check: true
      
  foreshadow:
    enabled: true
    priority: 80
    settings:
      min_foreshadows: 5
      require_payoff: true
      max_unresolved: 2
      
  # å¯é€‰æ’ä»¶
  suspense:
    enabled: true  # æ‚¬ç–‘å°è¯´å¯ç”¨
    priority: 75
    settings:
      mystery_count: 3
      red_herrings: 2
      
  romance:
    enabled: false  # éè¨€æƒ…å°è¯´ç¦ç”¨
    
  symbol:
    enabled: true
    priority: 50
    settings:
      core_symbols: ["é•œå­", "é›¨", "çº¢è‰²"]

# ç±»å‹é¢„è®¾
presets:
  suspense_novel:
    - character
    - worldview
    - event
    - timeline
    - foreshadow
    - suspense
    
  romance_novel:
    - character
    - worldview
    - event
    - timeline
    - emotion
    - romance
    
  xianxia_novel:
    - character
    - worldview
    - event
    - timeline
    - foreshadow
    - power_system  # ä¿®ç‚¼ä½“ç³»æ’ä»¶
```

### 6.8 æ’ä»¶ä¸æ‰§è¡Œå¼•æ“é›†æˆ

```python
class PluginAwareLoopEngine(LoopEngine):
    """æ”¯æŒæ’ä»¶çš„æ‰§è¡Œå¼•æ“"""
    
    def __init__(self, plugin_manager: PluginManager, ...):
        super().__init__(...)
        self.plugin_manager = plugin_manager
    
    async def run(self, goal: str, **kwargs) -> Dict[str, Any]:
        context = WritingContext(goal=goal)
        
        # åˆå§‹åŒ–æ‰€æœ‰æ’ä»¶
        await self.plugin_manager.run_hook("on_init", context)
        
        # è·å–æ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ’ä»¶ä»»åŠ¡ï¼‰
        tasks = self.plugin_manager.get_all_tasks()
        tasks = self.planner.plan(goal, context, additional_tasks=tasks)
        
        for task in tasks:
            # æ’ä»¶å‰å¤„ç†
            task = await self.plugin_manager.run_hook(
                "on_before_task", task, context, initial_value=task
            )
            
            # æ’ä»¶ä¸°å¯Œä¸Šä¸‹æ–‡
            task_context = await self._build_context(task)
            for plugin in self.plugin_manager.get_enabled_plugins():
                task_context = await plugin.enrich_context(task, task_context)
            
            # æ‰§è¡Œä»»åŠ¡
            result = await self._execute_task(task, task_context)
            
            # æ’ä»¶åå¤„ç†
            result = await self.plugin_manager.run_hook(
                "on_after_task", task, result, context, initial_value=result
            )
            
            # å­˜å‚¨ç»“æœ
            context.add_result(task.type, result)
        
        # æœ€ç»ˆéªŒè¯ï¼ˆæ‰€æœ‰æ’ä»¶ï¼‰
        for plugin in self.plugin_manager.get_enabled_plugins():
            validation = await plugin.validate(context.get_results(), context)
            if not validation.valid:
                # å¤„ç†éªŒè¯å¤±è´¥
                ...
        
        # å®Œæˆé’©å­
        await self.plugin_manager.run_hook("on_finalize", context)
        
        return context.get_results()
```

### 6.9 æ’ä»¶ç›®å½•ç»“æ„

```
creative_autogpt/
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py                 # æ’ä»¶åŸºç±»
â”‚   â”œâ”€â”€ manager.py              # æ’ä»¶ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæ’ä»¶ï¼ˆå†…ç½®ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ character.py        # äººç‰©æ¶æ„
â”‚   â”‚   â”œâ”€â”€ worldview.py        # ä¸–ç•Œè§‚æ¶æ„
â”‚   â”‚   â”œâ”€â”€ event.py            # äº‹ä»¶æ¶æ„
â”‚   â”‚   â”œâ”€â”€ timeline.py         # æ—¶é—´çº¿æ¶æ„
â”‚   â”‚   â”œâ”€â”€ foreshadow.py       # ä¼ç¬”æ¶æ„
â”‚   â”‚   â”œâ”€â”€ rhythm.py           # èŠ‚å¥æ¶æ„
â”‚   â”‚   â”œâ”€â”€ dialogue.py         # å¯¹è¯æ¶æ„
â”‚   â”‚   â””â”€â”€ scene.py            # åœºæ™¯æ¶æ„
â”‚   â”‚
â”‚   â”œâ”€â”€ genre/                  # ç±»å‹æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ suspense.py         # æ‚¬ç–‘ä¸“ç”¨
â”‚   â”‚   â”œâ”€â”€ romance.py          # è¨€æƒ…ä¸“ç”¨
â”‚   â”‚   â”œâ”€â”€ xianxia.py          # ä»™ä¾ ä¸“ç”¨
â”‚   â”‚   â””â”€â”€ scifi.py            # ç§‘å¹»ä¸“ç”¨
â”‚   â”‚
â”‚   â”œâ”€â”€ advanced/               # é«˜çº§æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ symbol.py           # è±¡å¾ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ narrative.py        # å™äº‹æŠ€å·§
â”‚   â”‚   â”œâ”€â”€ emotion.py          # æƒ…æ„Ÿæ›²çº¿
â”‚   â”‚   â””â”€â”€ theme.py            # ä¸»é¢˜æ·±åŒ–
â”‚   â”‚
â”‚   â””â”€â”€ community/              # ç¤¾åŒºæ’ä»¶ï¼ˆå¯æ‰©å±•ï¼‰
â”‚       â””â”€â”€ README.md
â”‚
â”œâ”€â”€ prompts/
â”‚   â””â”€â”€ plugins/                # æ’ä»¶ä¸“ç”¨æç¤ºè¯
â”‚       â”œâ”€â”€ character/
â”‚       â”œâ”€â”€ worldview/
â”‚       â””â”€â”€ ...
```

---

## ä¸ƒã€ä¸­é•¿ç¯‡ç½‘ç»œå°è¯´æ”¯æŒæ¶æ„

### 7.1 ä¸­é•¿ç¯‡å°è¯´çš„æŒ‘æˆ˜åˆ†æ

| è§„æ¨¡ | å­—æ•° | ç« èŠ‚æ•° | ä¸»è¦æŒ‘æˆ˜ |
|-----|------|--------|---------|
| **ä¸­ç¯‡** | 10-30ä¸‡å­— | 50-150ç«  | äººç‰©ä¸€è‡´æ€§ã€ä¼ç¬”å›æ”¶ |
| **é•¿ç¯‡** | 50-150ä¸‡å­— | 200-600ç«  | è®¾å®šé—å¿˜ã€æ—¶é—´çº¿æ··ä¹±ã€äººç‰©å…³ç³»å¤æ‚ |
| **è¶…é•¿ç¯‡** | 150-500ä¸‡å­— | 600-2000ç«  | å¤§é‡è§’è‰²ç®¡ç†ã€å¤šçº¿å™äº‹ã€è¯»è€…è®°å¿†è´Ÿæ‹… |

#### æ ¸å¿ƒç—›ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸­é•¿ç¯‡å°è¯´çš„å…­å¤§æŒ‘æˆ˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. LLMä¸Šä¸‹æ–‡çª—å£é™åˆ¶                                               â”‚
â”‚     â””â”€ å³ä½¿200K tokensä¹Ÿæ— æ³•è£…ä¸‹æ•´æœ¬å°è¯´                            â”‚
â”‚     â””â”€ éœ€è¦æ™ºèƒ½çš„ä¸Šä¸‹æ–‡æ£€ç´¢å’Œå‹ç¼©                                    â”‚
â”‚                                                                      â”‚
â”‚  2. è®¾å®šä¸€è‡´æ€§                                                       â”‚
â”‚     â””â”€ ç¬¬500ç« å¯èƒ½å¿˜è®°ç¬¬10ç« çš„è®¾å®š                                  â”‚
â”‚     â””â”€ äººç‰©æ€§æ ¼ã€èƒ½åŠ›ã€å…³ç³»å¯èƒ½å‰åçŸ›ç›¾                              â”‚
â”‚                                                                      â”‚
â”‚  3. ä¼ç¬”ç®¡ç†                                                         â”‚
â”‚     â””â”€ è·¨è¶Šå‡ ç™¾ç« çš„ä¼ç¬”å®¹æ˜“é—å¿˜                                      â”‚
â”‚     â””â”€ éœ€è¦ç²¾ç¡®è¿½è¸ªåŸ‹è®¾å’Œå›æ”¶                                        â”‚
â”‚                                                                      â”‚
â”‚  4. æ—¶é—´çº¿å¤æ‚åº¦                                                     â”‚
â”‚     â””â”€ å¤šæ¡æ—¶é—´çº¿äº¤ç»‡                                                â”‚
â”‚     â””â”€ è§’è‰²å¹´é¾„ã€äº‹ä»¶å…ˆåå®¹æ˜“å‡ºé”™                                    â”‚
â”‚                                                                      â”‚
â”‚  5. äººç‰©å…³ç³»ç½‘ç»œ                                                     â”‚
â”‚     â””â”€ å‡ åä¸Šç™¾ä¸ªè§’è‰²                                                â”‚
â”‚     â””â”€ å…³ç³»éšå‰§æƒ…åŠ¨æ€å˜åŒ–                                            â”‚
â”‚                                                                      â”‚
â”‚  6. å†…å­˜æ— æ³•æ‰¿è½½                                                     â”‚
â”‚     â””â”€ å½“å‰VectorMemoryManageråŸºäºå†…å­˜                              â”‚
â”‚     â””â”€ æ— æ³•æŒä¹…åŒ–ï¼Œé‡å¯ä¸¢å¤±                                          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å­˜å‚¨æ¶æ„æ€»ä½“è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å­˜å‚¨æ¶æ„åˆ†å±‚è®¾è®¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Application Layer                         â”‚   â”‚
â”‚  â”‚              (LoopEngine / PluginManager)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  Storage Abstraction Layer                   â”‚   â”‚
â”‚  â”‚                    (NovelStorageManager)                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ å…ƒæ•°æ®   â”‚  â”‚ ç»“æ„åŒ–   â”‚  â”‚ å‘é‡     â”‚  â”‚ å…¨æ–‡     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ å­˜å‚¨     â”‚  â”‚ æ•°æ®å­˜å‚¨ â”‚  â”‚ å­˜å‚¨     â”‚  â”‚ å­˜å‚¨     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚             â”‚             â”‚             â”‚                 â”‚
â”‚          â–¼             â–¼             â–¼             â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Physical Storage Layer                    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ SQLite/  â”‚  â”‚PostgreSQLâ”‚  â”‚ Chroma/  â”‚  â”‚ File/    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ JSON     â”‚  â”‚ /MySQL   â”‚  â”‚ Milvus/  â”‚  â”‚ MinIO/   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ Qdrant   â”‚  â”‚ S3       â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚   é¡¹ç›®é…ç½®      äººç‰©/è®¾å®š      è¯­ä¹‰æ£€ç´¢      ç« èŠ‚æ­£æ–‡        â”‚   â”‚
â”‚  â”‚   ä¼šè¯çŠ¶æ€      å…³ç³»/äº‹ä»¶      ä¸Šä¸‹æ–‡åŒ¹é…    å®Œæ•´å°è¯´        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å‘é‡æ•°æ®åº“è®¾è®¡

#### 7.3.1 ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“ï¼Ÿ

```python
# é—®é¢˜åœºæ™¯ï¼šç¬¬500ç« éœ€è¦å¼•ç”¨ç¬¬50ç« çš„ä¸€ä¸ªç»†èŠ‚

# âŒ ä¼ ç»Ÿæ–¹æ³•ï¼šå…¨æ–‡æœç´¢
result = search("ä¸»è§’çš„å‰‘") # è¿”å›å‡ ç™¾ä¸ªåŒ¹é…ï¼Œæ— æ³•ç²¾ç¡®å®šä½

# âœ… å‘é‡æ£€ç´¢ï¼šè¯­ä¹‰æœç´¢
result = vector_search(
    query="ä¸»è§’ç¬¬ä¸€æ¬¡è·å¾—é‚£æŠŠèƒ½æ–©æ–­å› æœçš„ç¥å‰‘æ˜¯ä»€ä¹ˆæƒ…å†µ",
    filters={"type": "item", "owner": "protagonist"},
    top_k=3
)
# ç²¾ç¡®è¿”å›ç¬¬50ç« ç¥å‰‘å‡ºåœºçš„ç›¸å…³å†…å®¹
```

#### 7.3.2 å‘é‡æ•°æ®åº“é€‰å‹

| æ•°æ®åº“ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|-------|------|---------|-------|
| **Chroma** | è½»é‡ã€åµŒå…¥å¼ã€PythonåŸç”Ÿ | å•æœºå¼€å‘ã€ä¸­å°å‹é¡¹ç›® | â­â­â­â­â­ |
| **Qdrant** | é«˜æ€§èƒ½ã€Rustå®ç°ã€äº‘åŸç”Ÿ | ç”Ÿäº§ç¯å¢ƒã€å¤§è§„æ¨¡ | â­â­â­â­ |
| **Milvus** | åˆ†å¸ƒå¼ã€å¤§è§„æ¨¡ã€GPUåŠ é€Ÿ | è¶…å¤§å‹é¡¹ç›® | â­â­â­ |
| **Pinecone** | å…¨æ‰˜ç®¡ã€å¼€ç®±å³ç”¨ | å¿«é€Ÿä¸Šçº¿ã€ä¸æƒ³è¿ç»´ | â­â­â­ |
| **Weaviate** | GraphQLã€å¤šæ¨¡æ€ | å¤æ‚æŸ¥è¯¢éœ€æ±‚ | â­â­â­ |

**æ¨èæ–¹æ¡ˆ**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼šChromaï¼ˆé›¶é…ç½®ï¼Œpip install å³å¯ï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šQdrantï¼ˆæ€§èƒ½å¥½ï¼Œæ˜“éƒ¨ç½²ï¼‰

#### 7.3.3 å‘é‡å­˜å‚¨æ•°æ®ç»“æ„

```python
from dataclasses import dataclass
from typing import List, Dict, Any, Optional
from enum import Enum
from datetime import datetime

class NovelElementType(Enum):
    """å°è¯´å…ƒç´ ç±»å‹"""
    # ç»“æ„å…ƒç´ 
    CHAPTER = "chapter"              # ç« èŠ‚
    SCENE = "scene"                  # åœºæ™¯
    PARAGRAPH = "paragraph"          # æ®µè½
    
    # æ ¸å¿ƒå…ƒç´ 
    CHARACTER = "character"          # äººç‰©
    CHARACTER_STATE = "character_state"  # äººç‰©çŠ¶æ€å¿«ç…§
    RELATIONSHIP = "relationship"    # äººç‰©å…³ç³»
    
    # ä¸–ç•Œè§‚å…ƒç´ 
    WORLDVIEW = "worldview"          # ä¸–ç•Œè§‚è®¾å®š
    LOCATION = "location"            # åœ°ç‚¹
    ITEM = "item"                    # ç‰©å“
    FACTION = "faction"              # åŠ¿åŠ›
    RULE = "rule"                    # è§„åˆ™/è®¾å®š
    
    # æƒ…èŠ‚å…ƒç´ 
    EVENT = "event"                  # äº‹ä»¶
    PLOT_POINT = "plot_point"        # æƒ…èŠ‚ç‚¹
    CONFLICT = "conflict"            # å†²çª
    FORESHADOW = "foreshadow"        # ä¼ç¬”
    
    # å…ƒä¿¡æ¯
    OUTLINE = "outline"              # å¤§çº²
    SUMMARY = "summary"              # æ‘˜è¦

@dataclass
class VectorDocument:
    """å‘é‡æ–‡æ¡£ç»“æ„"""
    id: str                          # å”¯ä¸€ID
    novel_id: str                    # æ‰€å±å°è¯´
    type: NovelElementType           # å…ƒç´ ç±»å‹
    
    # å†…å®¹
    content: str                     # åŸå§‹æ–‡æœ¬å†…å®¹
    summary: Optional[str] = None    # æ‘˜è¦ï¼ˆç”¨äºæ£€ç´¢å±•ç¤ºï¼‰
    
    # å‘é‡
    embedding: Optional[List[float]] = None  # å‘é‡åµŒå…¥
    
    # ä½ç½®ä¿¡æ¯
    chapter: Optional[int] = None    # ç« èŠ‚å·
    scene: Optional[int] = None      # åœºæ™¯å·
    position: Optional[int] = None   # åœ¨ç« èŠ‚ä¸­çš„ä½ç½®
    
    # å…³è”ä¿¡æ¯
    related_characters: List[str] = None  # å…³è”äººç‰©ID
    related_items: List[str] = None       # å…³è”ç‰©å“ID
    related_locations: List[str] = None   # å…³è”åœ°ç‚¹ID
    related_events: List[str] = None      # å…³è”äº‹ä»¶ID
    
    # æ—¶é—´ä¿¡æ¯
    story_time: Optional[str] = None      # æ•…äº‹å†…æ—¶é—´
    created_at: datetime = None           # åˆ›å»ºæ—¶é—´
    updated_at: datetime = None           # æ›´æ–°æ—¶é—´
    
    # æ‰©å±•å…ƒæ•°æ®
    metadata: Dict[str, Any] = None
```

#### 7.3.4 å‘é‡å­˜å‚¨æ¥å£è®¾è®¡

```python
from abc import ABC, abstractmethod
from typing import List, Dict, Any, Optional

class VectorStore(ABC):
    """å‘é‡å­˜å‚¨æŠ½è±¡æ¥å£"""
    
    @abstractmethod
    async def add(self, documents: List[VectorDocument]) -> List[str]:
        """æ·»åŠ æ–‡æ¡£ï¼Œè¿”å›IDåˆ—è¡¨"""
        pass
    
    @abstractmethod
    async def search(
        self,
        query: str,
        top_k: int = 10,
        filters: Optional[Dict[str, Any]] = None,
        score_threshold: float = 0.0
    ) -> List[SearchResult]:
        """è¯­ä¹‰æœç´¢"""
        pass
    
    @abstractmethod
    async def get(self, ids: List[str]) -> List[VectorDocument]:
        """æ ¹æ®IDè·å–æ–‡æ¡£"""
        pass
    
    @abstractmethod
    async def update(self, documents: List[VectorDocument]) -> None:
        """æ›´æ–°æ–‡æ¡£"""
        pass
    
    @abstractmethod
    async def delete(self, ids: List[str]) -> None:
        """åˆ é™¤æ–‡æ¡£"""
        pass
    
    @abstractmethod
    async def filter_search(
        self,
        filters: Dict[str, Any],
        limit: int = 100
    ) -> List[VectorDocument]:
        """æ ¹æ®å…ƒæ•°æ®è¿‡æ»¤æœç´¢ï¼ˆä¸ä½¿ç”¨å‘é‡ï¼‰"""
        pass


class ChromaVectorStore(VectorStore):
    """Chromaå‘é‡å­˜å‚¨å®ç°"""
    
    def __init__(
        self,
        collection_name: str = "novel",
        persist_directory: str = "./data/chroma",
        embedding_model: str = "text-embedding-3-small"
    ):
        import chromadb
        from chromadb.config import Settings
        
        self.client = chromadb.Client(Settings(
            chroma_db_impl="duckdb+parquet",
            persist_directory=persist_directory
        ))
        self.collection = self.client.get_or_create_collection(
            name=collection_name,
            metadata={"hnsw:space": "cosine"}
        )
        self.embedding_model = embedding_model
    
    async def add(self, documents: List[VectorDocument]) -> List[str]:
        embeddings = await self._get_embeddings([d.content for d in documents])
        
        self.collection.add(
            ids=[d.id for d in documents],
            embeddings=embeddings,
            documents=[d.content for d in documents],
            metadatas=[self._to_metadata(d) for d in documents]
        )
        
        return [d.id for d in documents]
    
    async def search(
        self,
        query: str,
        top_k: int = 10,
        filters: Optional[Dict[str, Any]] = None,
        score_threshold: float = 0.0
    ) -> List[SearchResult]:
        query_embedding = await self._get_embedding(query)
        
        where = self._build_where_clause(filters) if filters else None
        
        results = self.collection.query(
            query_embeddings=[query_embedding],
            n_results=top_k,
            where=where,
            include=["documents", "metadatas", "distances"]
        )
        
        return [
            SearchResult(
                document=self._from_metadata(meta, doc),
                score=1 - dist,  # è½¬æ¢è·ç¦»ä¸ºç›¸ä¼¼åº¦
            )
            for doc, meta, dist in zip(
                results["documents"][0],
                results["metadatas"][0],
                results["distances"][0]
            )
            if 1 - dist >= score_threshold
        ]
```

### 7.4 ç»“æ„åŒ–æ•°æ®å­˜å‚¨

#### 7.4.1 å…³ç³»æ•°æ®åº“ Schema

```sql
-- å°è¯´é¡¹ç›®è¡¨
CREATE TABLE novels (
    id VARCHAR(36) PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255),
    style VARCHAR(50),                  -- é£æ ¼ï¼šæ‚¬ç–‘/ä»™ä¾ ç­‰
    status VARCHAR(20) DEFAULT 'draft', -- draft/writing/completed
    target_words INTEGER,               -- ç›®æ ‡å­—æ•°
    current_words INTEGER DEFAULT 0,    -- å½“å‰å­—æ•°
    chapter_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    config JSON                         -- é¡¹ç›®é…ç½®
);

-- äººç‰©è¡¨
CREATE TABLE characters (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    name VARCHAR(100) NOT NULL,
    aliases JSON,                       -- åˆ«ååˆ—è¡¨
    role VARCHAR(20),                   -- protagonist/antagonist/supporting/minor
    
    -- åŸºæœ¬ä¿¡æ¯
    profile JSON,                       -- å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯ç­‰
    psychology JSON,                    -- åŠ¨æœºã€ææƒ§ã€æ¬²æœ›ç­‰
    speech_style JSON,                  -- è¯­è¨€é£æ ¼
    
    -- äººç‰©å¼§å…‰
    arc_start TEXT,
    arc_end TEXT,
    arc_turning_points JSON,
    
    -- çŠ¶æ€è·Ÿè¸ª
    current_state TEXT,                 -- å½“å‰çŠ¶æ€æè¿°
    last_appeared_chapter INTEGER,      -- æœ€åå‡ºåœºç« èŠ‚
    appearance_count INTEGER DEFAULT 0, -- å‡ºåœºæ¬¡æ•°
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_novel_id (novel_id),
    INDEX idx_role (role)
);

-- äººç‰©å…³ç³»è¡¨
CREATE TABLE character_relationships (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    character_id VARCHAR(36) REFERENCES characters(id),
    target_character_id VARCHAR(36) REFERENCES characters(id),
    
    relationship_type VARCHAR(50),      -- family/friend/enemy/loverç­‰
    description TEXT,
    strength INTEGER DEFAULT 50,        -- å…³ç³»å¼ºåº¦ 0-100
    
    -- å…³ç³»æ¼”å˜
    evolution JSON,                     -- [{chapter, change, reason}]
    current_state TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_character (character_id),
    INDEX idx_target (target_character_id)
);

-- ä¸–ç•Œè§‚è®¾å®šè¡¨
CREATE TABLE world_settings (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    category VARCHAR(50),               -- physics/society/geography/history
    name VARCHAR(255),
    content TEXT NOT NULL,
    importance VARCHAR(20),             -- critical/important/minor
    
    -- å…³è”
    related_characters JSON,            -- å…³è”äººç‰©ID
    related_locations JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_novel_category (novel_id, category)
);

-- åœ°ç‚¹è¡¨
CREATE TABLE locations (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50),
    description TEXT,
    significance TEXT,
    connected_locations JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç‰©å“è¡¨
CREATE TABLE items (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50),
    description TEXT,
    abilities JSON,
    owner_history JSON,                 -- æŒæœ‰è€…å†å²
    current_owner VARCHAR(36),
    plot_significance TEXT,
    first_appearance_chapter INTEGER,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº‹ä»¶è¡¨
CREATE TABLE events (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    name VARCHAR(255),
    type VARCHAR(50),                   -- main_plot/subplot/flashback
    
    chapter INTEGER,
    scene INTEGER,
    
    description TEXT,
    participants JSON,                  -- å‚ä¸äººç‰©ID
    location_id VARCHAR(36),
    
    cause_event_id VARCHAR(36),         -- èµ·å› äº‹ä»¶
    effect_event_ids JSON,              -- å¯¼è‡´çš„äº‹ä»¶
    
    stakes TEXT,
    outcome TEXT,
    emotional_beat VARCHAR(50),
    
    story_time TIMESTAMP,               -- æ•…äº‹å†…æ—¶é—´
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_chapter (novel_id, chapter)
);

-- ä¼ç¬”è¡¨
CREATE TABLE foreshadows (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    name VARCHAR(255),
    type VARCHAR(50),
    
    -- åŸ‹è®¾ä¿¡æ¯
    plant_chapter INTEGER,
    plant_scene INTEGER,
    plant_method TEXT,
    plant_content TEXT,
    subtlety VARCHAR(20),               -- obvious/subtle/hidden
    
    -- å›æ”¶ä¿¡æ¯
    payoffs JSON,                       -- [{chapter, method, impact}]
    
    status VARCHAR(20) DEFAULT 'planted', -- planted/partially_paid/fully_paid
    importance VARCHAR(20),
    related_elements JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_status (novel_id, status)
);

-- ç« èŠ‚è¡¨
CREATE TABLE chapters (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    chapter_number INTEGER NOT NULL,
    title VARCHAR(255),
    
    -- å†…å®¹
    outline TEXT,                       -- ç« èŠ‚å¤§çº²
    content TEXT,                       -- æ­£æ–‡å†…å®¹
    word_count INTEGER DEFAULT 0,
    
    -- å…ƒä¿¡æ¯
    pov_character VARCHAR(36),          -- è§†è§’äººç‰©
    main_characters JSON,               -- ä¸»è¦å‡ºåœºäººç‰©
    locations JSON,                     -- æ¶‰åŠåœ°ç‚¹
    events JSON,                        -- æ¶‰åŠäº‹ä»¶
    
    -- èŠ‚å¥
    emotional_tone VARCHAR(50),
    tension_level INTEGER,              -- 1-10
    
    -- ä¼ç¬”
    planted_foreshadows JSON,           -- æœ¬ç« åŸ‹è®¾çš„ä¼ç¬”
    paid_foreshadows JSON,              -- æœ¬ç« å›æ”¶çš„ä¼ç¬”
    
    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'draft', -- draft/written/polished/published
    version INTEGER DEFAULT 1,
    
    -- æ—¶é—´
    story_time_start TIMESTAMP,
    story_time_end TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE INDEX idx_chapter_number (novel_id, chapter_number)
);

-- ç« èŠ‚ç‰ˆæœ¬å†å²
CREATE TABLE chapter_versions (
    id VARCHAR(36) PRIMARY KEY,
    chapter_id VARCHAR(36) REFERENCES chapters(id),
    version INTEGER,
    content TEXT,
    change_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ—¶é—´çº¿è¡¨
CREATE TABLE timeline_points (
    id VARCHAR(36) PRIMARY KEY,
    novel_id VARCHAR(36) REFERENCES novels(id),
    story_time TIMESTAMP NOT NULL,
    narrative_order INTEGER,            -- å™è¿°é¡ºåº
    
    chapter INTEGER,
    event_ids JSON,
    description TEXT,
    duration_hours FLOAT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_story_time (novel_id, story_time)
);
```

### 7.5 æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†

#### 7.5.1 ä¸Šä¸‹æ–‡çª—å£ç­–ç•¥

```python
class ContextWindowManager:
    """
    æ™ºèƒ½ä¸Šä¸‹æ–‡çª—å£ç®¡ç†å™¨
    
    è§£å†³é—®é¢˜ï¼šLLMä¸Šä¸‹æ–‡æœ‰é™ï¼Œä½†å°è¯´å†…å®¹å·¨å¤§
    ç­–ç•¥ï¼šå¤šå±‚æ¬¡ã€æŒ‰éœ€åŠ è½½ã€æ™ºèƒ½æ‘˜è¦
    """
    
    def __init__(
        self,
        max_tokens: int = 32000,        # ç›®æ ‡ä¸Šä¸‹æ–‡å¤§å°
        reserve_tokens: int = 4000,     # é¢„ç•™ç»™è¾“å‡ºçš„tokens
    ):
        self.max_context_tokens = max_tokens - reserve_tokens
        
        # ä¸Šä¸‹æ–‡åˆ†é…æ¯”ä¾‹
        self.allocation = {
            "system_prompt": 0.10,      # ç³»ç»Ÿæç¤º
            "task_prompt": 0.15,        # ä»»åŠ¡æç¤º
            "core_context": 0.35,       # æ ¸å¿ƒä¸Šä¸‹æ–‡ï¼ˆè®¾å®šã€äººç‰©ï¼‰
            "recent_context": 0.25,     # æœ€è¿‘ä¸Šä¸‹æ–‡ï¼ˆå‰å‡ ç« ï¼‰
            "retrieved_context": 0.15,  # æ£€ç´¢ä¸Šä¸‹æ–‡ï¼ˆç›¸å…³å†…å®¹ï¼‰
        }
    
    async def build_context(
        self,
        task: Task,
        storage: NovelStorageManager
    ) -> ContextWindow:
        """ä¸ºä»»åŠ¡æ„å»ºä¼˜åŒ–çš„ä¸Šä¸‹æ–‡çª—å£"""
        
        context = ContextWindow()
        
        # 1. æ ¸å¿ƒä¸Šä¸‹æ–‡ - æ€»æ˜¯éœ€è¦çš„ä¿¡æ¯
        core = await self._build_core_context(task, storage)
        context.add("core", core, priority=100)
        
        # 2. æœ€è¿‘ä¸Šä¸‹æ–‡ - å‰Nç« çš„æ‘˜è¦+æœ€è¿‘ä¸€ç« çš„è¯¦ç»†å†…å®¹
        recent = await self._build_recent_context(task, storage)
        context.add("recent", recent, priority=80)
        
        # 3. æ£€ç´¢ä¸Šä¸‹æ–‡ - ä¸å½“å‰ä»»åŠ¡ç›¸å…³çš„å†å²å†…å®¹
        retrieved = await self._build_retrieved_context(task, storage)
        context.add("retrieved", retrieved, priority=60)
        
        # 4. å¦‚æœè¶…å‡ºé™åˆ¶ï¼Œæ™ºèƒ½å‹ç¼©
        if context.token_count > self.max_context_tokens:
            context = await self._compress_context(context)
        
        return context
    
    async def _build_core_context(
        self,
        task: Task,
        storage: NovelStorageManager
    ) -> str:
        """æ„å»ºæ ¸å¿ƒä¸Šä¸‹æ–‡ï¼ˆæ€»æ˜¯éœ€è¦ï¼‰"""
        
        parts = []
        
        # å°è¯´åŸºæœ¬ä¿¡æ¯
        novel = await storage.get_novel_info()
        parts.append(f"## å°è¯´ä¿¡æ¯\n{novel.title} - {novel.style}é£æ ¼")
        
        # æ ¸å¿ƒè®¾å®šæ‘˜è¦
        settings = await storage.get_critical_settings()
        parts.append(f"## æ ¸å¿ƒè®¾å®š\n{self._summarize_settings(settings)}")
        
        # å½“å‰ç« èŠ‚æ¶‰åŠçš„äººç‰©å®Œæ•´ä¿¡æ¯
        chapter_characters = task.metadata.get("involved_characters", [])
        for char_id in chapter_characters[:5]:  # æœ€å¤š5ä¸ªä¸»è¦äººç‰©
            char = await storage.get_character(char_id)
            parts.append(f"### {char.name}\n{self._format_character(char)}")
        
        # æ´»è·ƒçš„ä¼ç¬”
        active_foreshadows = await storage.get_active_foreshadows(
            before_chapter=task.metadata.get("chapter_index")
        )
        if active_foreshadows:
            parts.append(f"## å¾…å›æ”¶ä¼ç¬”\n{self._format_foreshadows(active_foreshadows)}")
        
        return "\n\n".join(parts)
    
    async def _build_recent_context(
        self,
        task: Task,
        storage: NovelStorageManager
    ) -> str:
        """æ„å»ºæœ€è¿‘ä¸Šä¸‹æ–‡"""
        
        current_chapter = task.metadata.get("chapter_index", 1)
        parts = []
        
        # å‰3ç« çš„æ‘˜è¦
        for i in range(max(1, current_chapter - 3), current_chapter):
            summary = await storage.get_chapter_summary(i)
            parts.append(f"### ç¬¬{i}ç« æ‘˜è¦\n{summary}")
        
        # å‰ä¸€ç« çš„è¯¦ç»†å†…å®¹ï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€ç« ï¼‰
        if current_chapter > 1:
            prev_chapter = await storage.get_chapter(current_chapter - 1)
            # åªå–æœ€å2000å­—
            recent_content = prev_chapter.content[-2000:] if prev_chapter.content else ""
            parts.append(f"### ä¸Šä¸€ç« ç»“å°¾\n{recent_content}")
        
        return "\n\n".join(parts)
    
    async def _build_retrieved_context(
        self,
        task: Task,
        storage: NovelStorageManager
    ) -> str:
        """æ„å»ºæ£€ç´¢ä¸Šä¸‹æ–‡ï¼ˆè¯­ä¹‰ç›¸å…³ï¼‰"""
        
        # æ ¹æ®ä»»åŠ¡ç±»å‹æ„å»ºæ£€ç´¢æŸ¥è¯¢
        queries = self._build_retrieval_queries(task)
        
        retrieved_items = []
        for query, filters in queries:
            results = await storage.vector_search(
                query=query,
                filters=filters,
                top_k=3
            )
            retrieved_items.extend(results)
        
        # å»é‡å’Œæ’åº
        unique_items = self._deduplicate_and_rank(retrieved_items)
        
        return self._format_retrieved_items(unique_items[:10])
    
    async def _compress_context(self, context: ContextWindow) -> ContextWindow:
        """å‹ç¼©ä¸Šä¸‹æ–‡ä»¥é€‚åº”tokené™åˆ¶"""
        
        while context.token_count > self.max_context_tokens:
            # æ‰¾åˆ°ä¼˜å…ˆçº§æœ€ä½çš„å†…å®¹
            lowest = context.get_lowest_priority_item()
            
            # å°è¯•æ‘˜è¦å‹ç¼©
            if len(lowest.content) > 500:
                summary = await self._summarize(lowest.content)
                lowest.content = summary
            else:
                # å¤ªçŸ­äº†å°±ç›´æ¥åˆ é™¤
                context.remove(lowest.id)
        
        return context
```

#### 7.5.2 å¢é‡ç”Ÿæˆç­–ç•¥

```python
class IncrementalGenerator:
    """
    å¢é‡ç”Ÿæˆå™¨
    
    æ”¯æŒï¼š
    - æ–­ç‚¹ç»­å†™
    - ç« èŠ‚é‡å†™
    - éƒ¨åˆ†æ›´æ–°
    """
    
    def __init__(
        self,
        storage: NovelStorageManager,
        context_manager: ContextWindowManager
    ):
        self.storage = storage
        self.context_manager = context_manager
    
    async def generate_chapter(
        self,
        novel_id: str,
        chapter_number: int,
        regenerate: bool = False
    ) -> Chapter:
        """ç”Ÿæˆæˆ–é‡æ–°ç”ŸæˆæŒ‡å®šç« èŠ‚"""
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        existing = await self.storage.get_chapter(chapter_number)
        if existing and not regenerate:
            return existing
        
        # è·å–ç« èŠ‚å¤§çº²
        outline = await self.storage.get_chapter_outline(chapter_number)
        
        # æ„å»ºä¸Šä¸‹æ–‡
        task = Task(
            type="ç« èŠ‚",
            description=outline,
            metadata={"chapter_index": chapter_number}
        )
        context = await self.context_manager.build_context(task, self.storage)
        
        # ç”Ÿæˆå†…å®¹
        content = await self._generate_with_context(task, context)
        
        # ä¿å­˜ç« èŠ‚
        chapter = await self.storage.save_chapter(
            chapter_number=chapter_number,
            content=content,
            outline=outline,
            version=existing.version + 1 if existing else 1
        )
        
        # æ›´æ–°ç›¸å…³çŠ¶æ€ï¼ˆäººç‰©å‡ºåœºã€ä¼ç¬”çŠ¶æ€ç­‰ï¼‰
        await self._update_states_after_chapter(chapter)
        
        return chapter
    
    async def continue_writing(
        self,
        novel_id: str,
        from_chapter: Optional[int] = None
    ) -> AsyncGenerator[Chapter, None]:
        """
        ä»æŒ‡å®šç« èŠ‚ç»§ç»­å†™ä½œ
        æ”¯æŒæ–­ç‚¹ç»­å†™
        """
        
        # ç¡®å®šèµ·å§‹ç« èŠ‚
        if from_chapter is None:
            last_chapter = await self.storage.get_last_chapter()
            from_chapter = (last_chapter.chapter_number + 1) if last_chapter else 1
        
        # è·å–æ€»ç« èŠ‚æ•°ï¼ˆä»å¤§çº²ï¼‰
        outline = await self.storage.get_outline()
        total_chapters = outline.total_chapters
        
        for chapter_num in range(from_chapter, total_chapters + 1):
            chapter = await self.generate_chapter(novel_id, chapter_num)
            yield chapter
            
            # æ¯ç« åè‡ªåŠ¨ä¿å­˜æ£€æŸ¥ç‚¹
            await self._save_checkpoint(novel_id, chapter_num)
    
    async def rewrite_section(
        self,
        novel_id: str,
        start_chapter: int,
        end_chapter: int,
        revision_notes: str
    ) -> List[Chapter]:
        """
        é‡å†™æŒ‡å®šç« èŠ‚èŒƒå›´
        ä¼šè€ƒè™‘å¯¹åç»­ç« èŠ‚çš„å½±å“
        """
        
        rewritten = []
        
        for chapter_num in range(start_chapter, end_chapter + 1):
            # æ·»åŠ ä¿®è®¢è¯´æ˜åˆ°ä¸Šä¸‹æ–‡
            task = Task(
                type="ç« èŠ‚é‡å†™",
                description=f"æ ¹æ®ä¿®è®¢è¦æ±‚é‡å†™ï¼š{revision_notes}",
                metadata={
                    "chapter_index": chapter_num,
                    "revision_notes": revision_notes,
                    "original_content": await self.storage.get_chapter(chapter_num)
                }
            )
            
            chapter = await self.generate_chapter(
                novel_id, 
                chapter_num, 
                regenerate=True
            )
            rewritten.append(chapter)
        
        # æ£€æŸ¥å¯¹åç»­ç« èŠ‚çš„å½±å“
        impact = await self._analyze_rewrite_impact(rewritten, end_chapter)
        if impact.needs_cascade_update:
            # å¯èƒ½éœ€è¦æ›´æ–°åç»­ç« èŠ‚
            logging.warning(f"é‡å†™å¯èƒ½å½±å“åç»­ç« èŠ‚ï¼š{impact.affected_chapters}")
        
        return rewritten
```

### 7.6 é•¿æœŸè®°å¿†ä¸é—å¿˜ç®¡ç†

```python
class LongTermMemoryManager:
    """
    é•¿æœŸè®°å¿†ç®¡ç†å™¨
    
    è§£å†³é—®é¢˜ï¼šéšç€å°è¯´å¢é•¿ï¼Œå¦‚ä½•ç®¡ç†æµ·é‡å†å²ä¿¡æ¯
    
    ç­–ç•¥ï¼š
    1. åˆ†å±‚è®°å¿†ï¼ˆçƒ­/æ¸©/å†·ï¼‰
    2. è‡ªåŠ¨æ‘˜è¦
    3. é‡è¦æ€§è¡°å‡
    4. æŒ‰éœ€åŠ è½½
    """
    
    def __init__(self, storage: NovelStorageManager):
        self.storage = storage
        
        # è®°å¿†å±‚çº§
        self.memory_tiers = {
            "hot": {                    # çƒ­è®°å¿†ï¼šæœ€è¿‘10ç« 
                "max_chapters": 10,
                "detail_level": "full"
            },
            "warm": {                   # æ¸©è®°å¿†ï¼š11-50ç« 
                "max_chapters": 40,
                "detail_level": "summary"
            },
            "cold": {                   # å†·è®°å¿†ï¼šæ›´æ—©çš„ç« èŠ‚
                "max_chapters": None,
                "detail_level": "key_points"
            }
        }
    
    async def get_memory_for_chapter(
        self,
        current_chapter: int
    ) -> Dict[str, Any]:
        """è·å–å†™ä½œæŒ‡å®šç« èŠ‚æ—¶çš„è®°å¿†"""
        
        memory = {
            "hot": [],
            "warm": [],
            "cold": []
        }
        
        # çƒ­è®°å¿†ï¼šæœ€è¿‘ç« èŠ‚çš„å®Œæ•´å†…å®¹
        hot_start = max(1, current_chapter - 10)
        for i in range(hot_start, current_chapter):
            chapter = await self.storage.get_chapter(i)
            memory["hot"].append({
                "chapter": i,
                "content": chapter.content,
                "characters": chapter.main_characters,
                "events": chapter.events
            })
        
        # æ¸©è®°å¿†ï¼šè¾ƒæ—©ç« èŠ‚çš„æ‘˜è¦
        warm_start = max(1, current_chapter - 50)
        for i in range(warm_start, hot_start):
            summary = await self.storage.get_chapter_summary(i)
            memory["warm"].append({
                "chapter": i,
                "summary": summary,
                "key_events": await self.storage.get_chapter_key_events(i)
            })
        
        # å†·è®°å¿†ï¼šæ›´æ—©ç« èŠ‚çš„å…³é”®ç‚¹
        if warm_start > 1:
            key_points = await self.storage.get_novel_key_points(1, warm_start - 1)
            memory["cold"] = key_points
        
        return memory
    
    async def update_memories(self, chapter: Chapter) -> None:
        """ç« èŠ‚å®Œæˆåæ›´æ–°è®°å¿†"""
        
        # ç”Ÿæˆç« èŠ‚æ‘˜è¦
        summary = await self._generate_summary(chapter)
        await self.storage.save_chapter_summary(chapter.chapter_number, summary)
        
        # æå–å…³é”®äº‹ä»¶
        key_events = await self._extract_key_events(chapter)
        await self.storage.save_chapter_key_events(chapter.chapter_number, key_events)
        
        # æ›´æ–°äººç‰©çŠ¶æ€
        for char_id in chapter.main_characters:
            new_state = await self._extract_character_state(chapter, char_id)
            await self.storage.update_character_state(char_id, new_state)
        
        # æ£€æŸ¥ä¼ç¬”å›æ”¶
        await self._check_foreshadow_payoffs(chapter)
    
    async def recall(
        self,
        query: str,
        context_chapter: int,
        importance_threshold: float = 0.5
    ) -> List[MemoryItem]:
        """
        æ ¹æ®æŸ¥è¯¢å¬å›ç›¸å…³è®°å¿†
        è€ƒè™‘ï¼šè¯­ä¹‰ç›¸å…³æ€§ã€é‡è¦æ€§ã€æ—¶é—´è·ç¦»
        """
        
        # å‘é‡æ£€ç´¢
        semantic_results = await self.storage.vector_search(query, top_k=20)
        
        # è®¡ç®—ç»¼åˆå¾—åˆ†
        scored_results = []
        for result in semantic_results:
            score = self._calculate_memory_score(
                semantic_score=result.score,
                importance=result.metadata.get("importance", 0.5),
                chapter_distance=abs(context_chapter - result.chapter),
                total_chapters=context_chapter
            )
            if score >= importance_threshold:
                scored_results.append((result, score))
        
        # æ’åºè¿”å›
        scored_results.sort(key=lambda x: x[1], reverse=True)
        return [r[0] for r in scored_results[:10]]
    
    def _calculate_memory_score(
        self,
        semantic_score: float,
        importance: float,
        chapter_distance: int,
        total_chapters: int
    ) -> float:
        """
        è®¡ç®—è®°å¿†ç»¼åˆå¾—åˆ†
        
        å…¬å¼ï¼šscore = semantic * 0.4 + importance * 0.3 + recency * 0.3
        """
        # æ—¶é—´è¡°å‡ï¼ˆè·ç¦»è¶Šè¿œï¼Œåˆ†æ•°è¶Šä½ï¼Œä½†é‡è¦äº‹ä»¶è¡°å‡æ…¢ï¼‰
        decay_rate = 0.02 * (1 - importance)  # é‡è¦æ€§è¶Šé«˜ï¼Œè¡°å‡è¶Šæ…¢
        recency = math.exp(-decay_rate * chapter_distance)
        
        return semantic_score * 0.4 + importance * 0.3 + recency * 0.3
```

### 7.7 å­˜å‚¨æ¶æ„æ–‡ä»¶ç»“æ„

```
creative_autogpt/
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ manager.py              # NovelStorageManager
â”‚   â”‚
â”‚   â”œâ”€â”€ relational/             # å…³ç³»æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py             # æ•°æ®åº“åŸºç±»
â”‚   â”‚   â”œâ”€â”€ sqlite.py           # SQLiteå®ç°ï¼ˆå¼€å‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ postgres.py         # PostgreSQLå®ç°ï¼ˆç”Ÿäº§ï¼‰
â”‚   â”‚   â””â”€â”€ models.py           # ORMæ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ vector/                 # å‘é‡æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py             # å‘é‡å­˜å‚¨åŸºç±»
â”‚   â”‚   â”œâ”€â”€ chroma.py           # Chromaå®ç°
â”‚   â”‚   â”œâ”€â”€ qdrant.py           # Qdrantå®ç°
â”‚   â”‚   â””â”€â”€ embeddings.py       # å‘é‡åµŒå…¥æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ context/                # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ window.py           # ä¸Šä¸‹æ–‡çª—å£
â”‚   â”‚   â”œâ”€â”€ retrieval.py        # æ£€ç´¢ç­–ç•¥
â”‚   â”‚   â””â”€â”€ compression.py      # å‹ç¼©ç­–ç•¥
â”‚   â”‚
â”‚   â””â”€â”€ memory/                 # é•¿æœŸè®°å¿†
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ manager.py          # è®°å¿†ç®¡ç†å™¨
â”‚       â”œâ”€â”€ summary.py          # è‡ªåŠ¨æ‘˜è¦
â”‚       â””â”€â”€ recall.py           # è®°å¿†å¬å›
â”‚
â”œâ”€â”€ data/                       # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ novels/                 # å°è¯´æ•°æ®
â”‚   â”‚   â””â”€â”€ {novel_id}/
â”‚   â”‚       â”œâ”€â”€ novel.db        # SQLiteæ•°æ®åº“
â”‚   â”‚       â”œâ”€â”€ chapters/       # ç« èŠ‚æ–‡ä»¶
â”‚   â”‚       â””â”€â”€ exports/        # å¯¼å‡ºæ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ chroma/                 # Chromaå‘é‡åº“
â”‚   â””â”€â”€ cache/                  # ç¼“å­˜ç›®å½•
```

### 7.8 ä¸­é•¿ç¯‡æ”¯æŒèƒ½åŠ›æ€»ç»“

| èƒ½åŠ› | å½“å‰çŠ¶æ€ | å¢å¼ºå | æ”¯æŒè§„æ¨¡ |
|-----|---------|-------|---------|
| **å­˜å‚¨** | å†…å­˜ | å…³ç³»DB + å‘é‡DB | æ— é™ |
| **ä¸Šä¸‹æ–‡** | å…¨é‡åŠ è½½ | æ™ºèƒ½çª—å£ | 200K tokenså†…ä¼˜åŒ– |
| **ä¸€è‡´æ€§** | ä¾èµ–è®°å¿† | ç»“æ„åŒ–æ ¡éªŒ | è‡ªåŠ¨æ£€æµ‹å†²çª |
| **ä¼ç¬”** | ç®€å•è¿½è¸ª | å®Œæ•´ç”Ÿå‘½å‘¨æœŸ | æ”¯æŒå‡ ç™¾ä¸ªä¼ç¬” |
| **äººç‰©** | åˆ—è¡¨å­˜å‚¨ | å…³ç³»å›¾è°± | æ”¯æŒä¸Šç™¾è§’è‰² |
| **æ–­ç‚¹ç»­å†™** | ä¸æ”¯æŒ | æ£€æŸ¥ç‚¹ç³»ç»Ÿ | éšæ—¶æ¢å¤ |
| **ç‰ˆæœ¬ç®¡ç†** | ä¸æ”¯æŒ | ç« èŠ‚ç‰ˆæœ¬å†å² | å¯å›æ»š |

### 7.9 é•¿ç¯‡å…³é”®èƒ½åŠ›è¡¥é½ï¼ˆä¼˜å…ˆè½åœ°ï¼‰

é’ˆå¯¹é•¿ç¯‡ç½‘ç»œå°è¯´çš„ç¨³å®šæ€§ä¸å¯æ§æ€§ï¼Œè¡¥é½ä»¥ä¸‹èƒ½åŠ›ï¼š

1. **ä¸€è‡´æ€§è‡ªåŠ¨æ ¡éªŒä¸ä¿®å¤é—­ç¯**
    - **åŠŸèƒ½**ï¼šè‡ªåŠ¨æ£€æµ‹äººç‰©/è®¾å®š/æ—¶é—´çº¿å†²çª â†’ ç”Ÿæˆä¿®å¤ä»»åŠ¡ â†’ å›å†™ä¿®å¤ç»“æœã€‚
    - **æ”¶ç›Š**ï¼šå‡å°‘â€œå‰åæ‰“è„¸â€ï¼Œæ”¯æŒè·¨ç™¾ç« ä¸€è‡´æ€§ç»´æŠ¤ã€‚
    - **è½ç‚¹**ï¼š`ConsistencyManager` + è¯„ä¼°å™¨è”åŠ¨ + ä¿®å¤ä»»åŠ¡ `ä¿®è®¢`ã€‚

2. **å…¨å±€å‰§æƒ…æ§åˆ¶å™¨ï¼ˆPlot Controllerï¼‰**
    - **åŠŸèƒ½**ï¼šä¸ºæ¯ç« æ³¨å…¥é˜¶æ®µç›®æ ‡ï¼ˆèµ·æ‰¿è½¬åˆ/ä¸‰å¹•ï¼‰ï¼Œä¿è¯ä¸»çº¿æ¨è¿›ä¸èŠ‚å¥ã€‚
    - **æ”¶ç›Š**ï¼šå‡å°‘â€œæ°´ç« èŠ‚â€ï¼Œä¿æŒå™äº‹å¼ åŠ›ä¸ç»“æ„å®Œæ•´ã€‚
    - **è½ç‚¹**ï¼šä»»åŠ¡å…ƒæ•°æ®æ³¨å…¥ `plot_stage` / `plot_guidance`ã€‚

3. **æˆæœ¬ä¸è´¨é‡è°ƒåº¦ï¼ˆCost-Quality Policyï¼‰**
    - **åŠŸèƒ½**ï¼šç« èŠ‚çº§é¢„ç®—ç®¡æ§ï¼Œè‰ç¨¿ä½æˆæœ¬æ¨¡å‹ + å…³é”®ç« èŠ‚é«˜è´¨é‡æ¨¡å‹ã€‚
    - **æ”¶ç›Š**ï¼šæ§åˆ¶æ€»ä½“æˆæœ¬ï¼ŒåŒæ—¶ä¿è¯å…³é”®ç« èŠ‚å“è´¨ã€‚
    - **è½ç‚¹**ï¼š`CostQualityPolicy` ä¸è·¯ç”±å™¨åä½œï¼ŒåŠ¨æ€é€‰æ¨¡ã€‚

4. **ç« èŠ‚å˜æ›´å½±å“åˆ†æï¼ˆImpact Analyzerï¼‰**
    - **åŠŸèƒ½**ï¼šä¿®æ”¹ç« èŠ‚åè‡ªåŠ¨æ ‡è®°å—å½±å“ä»»åŠ¡å¹¶ç”Ÿæˆâ€œå½±å“æ£€æŸ¥â€ã€‚
    - **æ”¶ç›Š**ï¼šé¿å…å‰æ”¹åå´©ï¼Œæç¤ºéœ€è¦å›çœ‹æˆ–é‡å†™çš„ç« èŠ‚ã€‚
    - **è½ç‚¹**ï¼š`ImpactAnalyzer` â†’ ç”Ÿæˆ `å½±å“æ£€æŸ¥` ä»»åŠ¡ã€‚

5. **åˆ›ä½œå›æ”¾ä¸å®¡æ ¸ï¼ˆAudit Log + ç‰ˆæœ¬å›æ»šï¼‰**
    - **åŠŸèƒ½**ï¼šè®°å½•æ¯æ¬¡ç”Ÿæˆ/ä¿®è®¢çš„æ—¥å¿—ã€è¯„ä¼°ã€ç‰ˆæœ¬ã€‚
    - **æ”¶ç›Š**ï¼šå¯å®¡è®¡ã€å¯å›æ»šã€å¯å¯¹æ¯”ç‰ˆæœ¬å·®å¼‚ã€‚
    - **è½ç‚¹**ï¼š`AuditLogger` + ç« èŠ‚ç‰ˆæœ¬å†å²ã€‚

---

## å…«ã€é‡æ„å»ºè®®

### 8.1 çŸ­æœŸä¼˜åŒ–ï¼ˆä¿æŒç°æœ‰æ¶æ„ï¼‰

#### 8.1.1 å¢å¼ºä»»åŠ¡è§„åˆ’å™¨

```python
class AdaptiveNovelPlanner(TaskPlanner):
    """è‡ªé€‚åº”å°è¯´è§„åˆ’å™¨"""
    
    def plan(self, goal: str, context: ExecutionContext) -> List[Task]:
        # 1. åˆ†æç›®æ ‡ï¼Œç¡®å®šå°è¯´ç±»å‹å’Œé•¿åº¦
        novel_type = self._analyze_goal(goal)
        
        # 2. æ ¹æ®ç±»å‹é€‰æ‹©ä»»åŠ¡æ¨¡æ¿
        if novel_type == "short_story":
            return self._plan_short_story()
        elif novel_type == "serial_novel":
            return self._plan_serial_novel()
        else:
            return self._plan_standard_novel()
    
    def generate_follow_up_tasks(self, completed_task: Task, result: str) -> List[Task]:
        """åŠ¨æ€ç”Ÿæˆåç»­ä»»åŠ¡"""
        if completed_task.type == "å¤§çº²":
            # è§£æå¤§çº²ï¼Œç”Ÿæˆç« èŠ‚ä»»åŠ¡
            chapters = self._parse_outline(result)
            return self._generate_chapter_tasks(chapters)
```

#### 8.1.2 æ”¹è¿›ä¸Šä¸‹æ–‡æ£€ç´¢

```python
class EnhancedMemoryManager(VectorMemoryManager):
    """å¢å¼ºçš„è®°å¿†ç®¡ç†å™¨"""
    
    # ä»»åŠ¡ç±»å‹åˆ°æ£€ç´¢ç­–ç•¥çš„æ˜ å°„
    RETRIEVAL_STRATEGIES = {
        "ç« èŠ‚": ["å¤§çº²", "äººç‰©è®¾è®¡", "å‰ä¸€ç« ", "ä¼ç¬”åˆ—è¡¨"],
        "äººç‰©è®¾è®¡": ["ä¸–ç•Œè§‚è§„åˆ™", "å·²æœ‰äººç‰©", "ä¸»é¢˜ç¡®è®¤"],
        "åœºæ™¯": ["ç« èŠ‚å¤§çº²", "ç›¸å…³äººç‰©", "ç‰©å“"],
    }
    
    async def get_context(self, task: Task) -> Dict[str, List[Any]]:
        strategy = self.RETRIEVAL_STRATEGIES.get(task.type, ["*"])
        return await self._execute_strategy(task, strategy)
```

#### 8.1.3 æ·»åŠ åˆ›ä½œå·¥å…·

```python
class WritingTools:
    """å†™ä½œè¾…åŠ©å·¥å…· - ç±»ä¼¼ AutoGPT çš„ Commands"""
    
    async def check_character_consistency(self, character: str, content: str) -> bool:
        """æ£€æŸ¥äººç‰©ä¸€è‡´æ€§"""
    
    async def check_timeline(self, events: List[Event]) -> List[Conflict]:
        """æ£€æŸ¥æ—¶é—´çº¿å†²çª"""
    
    async def generate_foreshadowing(self, plot_point: str) -> List[str]:
        """ç”Ÿæˆä¼ç¬”å»ºè®®"""
    
    async def suggest_dialogue(self, characters: List[str], scene: str) -> str:
        """ç”Ÿæˆå¯¹è¯å»ºè®®"""
```

### 8.2 ä¸­æœŸé‡æ„ï¼ˆæ¨¡å—åŒ–ï¼‰

#### 8.2.1 å¼•å…¥ç»„ä»¶ç³»ç»Ÿ

å€Ÿé‰´ AutoGPT çš„ `AgentComponent` è®¾è®¡ï¼š

```python
class WritingComponent(ABC):
    """å†™ä½œç»„ä»¶åŸºç±»"""
    
    name: str
    depends_on: List[Type["WritingComponent"]] = []
    
    @abstractmethod
    async def process(self, context: WritingContext) -> WritingContext:
        """å¤„ç†å†™ä½œä¸Šä¸‹æ–‡"""

class OutlineComponent(WritingComponent):
    """å¤§çº²ç”Ÿæˆç»„ä»¶"""
    name = "outline"
    
    async def process(self, context: WritingContext) -> WritingContext:
        outline = await self.generate_outline(context)
        context.add_result("outline", outline)
        return context

class CharacterComponent(WritingComponent):
    """äººç‰©è®¾è®¡ç»„ä»¶"""
    name = "character"
    depends_on = [OutlineComponent]
    
    async def process(self, context: WritingContext) -> WritingContext:
        characters = await self.generate_characters(context)
        context.add_result("characters", characters)
        return context
```

#### 8.2.2 å¯è§†åŒ–å·¥ä½œæµï¼ˆå€Ÿé‰´ AutoGPT Platformï¼‰

```python
class WritingGraph:
    """å†™ä½œå·¥ä½œæµå›¾"""
    
    nodes: List[WritingNode]
    links: List[WritingLink]
    
    def add_node(self, component: WritingComponent) -> str:
        """æ·»åŠ ç»„ä»¶èŠ‚ç‚¹"""
    
    def add_link(self, source: str, target: str, data_type: str):
        """æ·»åŠ æ•°æ®è¿æ¥"""
    
    async def execute(self, inputs: Dict[str, Any]) -> Dict[str, Any]:
        """æŒ‰æ‹“æ‰‘é¡ºåºæ‰§è¡Œå·¥ä½œæµ"""
```

### 8.3 é•¿æœŸæ„¿æ™¯ï¼ˆå¹³å°åŒ–ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Writing AutoGPT Platform                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å¯è§†åŒ–å·¥ä½œæµç¼–è¾‘å™¨                      â”‚   â”‚
â”‚  â”‚  [é£æ ¼] â”€â”€â–¶ [å¤§çº²] â”€â”€â–¶ [äººç‰©] â”€â”€â–¶ [ç« èŠ‚å¾ªç¯]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ç»„ä»¶å¸‚åœº                               â”‚   â”‚
â”‚  â”‚  â€¢ æ‚¬ç–‘å¤§å¸ˆç»„ä»¶      â€¢ è¨€æƒ…ä¸“å®¶ç»„ä»¶    â€¢ ç§‘å¹»ä¸–ç•Œè§‚ç»„ä»¶   â”‚   â”‚
â”‚  â”‚  â€¢ äººç‰©å¿ƒç†åˆ†æ      â€¢ å¯¹è¯æ¶¦è‰²å™¨      â€¢ èŠ‚å¥æ§åˆ¶å™¨       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å¤šæ¨¡å‹æ”¯æŒ                             â”‚   â”‚
â”‚  â”‚  â€¢ GPT-4 (åˆ›æ„)     â€¢ Claude (åˆ†æ)    â€¢ æœ¬åœ°æ¨¡å‹ (éšç§)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    åä½œä¸ç‰ˆæœ¬æ§åˆ¶                         â”‚   â”‚
â”‚  â”‚  â€¢ å¤šäººåä½œåˆ›ä½œ      â€¢ ç‰ˆæœ¬å†å²        â€¢ åˆ†æ”¯åˆå¹¶          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¹ã€å…³é”®ä»£ç è·¯å¾„

### 9.1 æ‰§è¡Œæµç¨‹ä»£ç è·¯å¾„

```
ç”¨æˆ·è¯·æ±‚ "åˆ›ä½œä¸€éƒ¨æ‚¬ç–‘å°è¯´"
    â”‚
    â–¼
server.py: create_session()
    â”‚ åˆ›å»ºä¼šè¯ï¼Œåˆå§‹åŒ– LoopEngine
    â–¼
loop_engine.py: run()
    â”‚
    â”œâ”€â”€â–¶ task_planner.py: plan()
    â”‚       â”‚ ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
    â”‚       â”‚ [é£æ ¼, ä¸»é¢˜ç¡®è®¤, å¤§çº², ...]
    â”‚       â–¼
    â”œâ”€â”€â–¶ _get_next_task()
    â”‚       â”‚ è·å–ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œä»»åŠ¡
    â”‚       â–¼
    â”œâ”€â”€â–¶ _execute_task()
    â”‚       â”‚
    â”‚       â”œâ”€â”€â–¶ vector_memory.py: get_context()
    â”‚       â”‚       â”‚ æ£€ç´¢ç›¸å…³ä¸Šä¸‹æ–‡
    â”‚       â”‚       â–¼
    â”‚       â”œâ”€â”€â–¶ modes/novel.py: build_prompt()
    â”‚       â”‚       â”‚ æ„å»ºæç¤ºè¯
    â”‚       â”‚       â–¼
    â”‚       â”œâ”€â”€â–¶ llm_client.py: generate()
    â”‚       â”‚       â”‚ è°ƒç”¨ LLM ç”Ÿæˆ
    â”‚       â”‚       â–¼
    â”‚       â””â”€â”€â–¶ evaluator.py: evaluate()
    â”‚               â”‚ è¯„ä¼°è´¨é‡
    â”‚               â–¼
    â”‚           [é€šè¿‡?]
    â”‚             â”‚ å¦
    â”‚             â–¼
    â”‚           _attempt_rewrite()
    â”‚             â”‚ é‡å†™
    â”‚             â–¼
    â”‚
    â””â”€â”€â–¶ vector_memory.py: add()
            â”‚ å­˜å‚¨ç»“æœ
            â–¼
        [ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡]
```

### 9.2 æ–‡ä»¶ä¾èµ–å›¾

```
src/creative_autogpt/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ loop_engine.py      # æ ¸å¿ƒæ‰§è¡Œå¼•æ“
â”‚   â”‚   â”œâ”€â”€ imports: task_planner, evaluator, memory, modes
â”‚   â”‚   â””â”€â”€ main: LoopEngine.run()
â”‚   â”‚
â”‚   â”œâ”€â”€ task_planner.py     # ä»»åŠ¡è§„åˆ’
â”‚   â”‚   â”œâ”€â”€ imports: task
â”‚   â”‚   â””â”€â”€ main: NovelPipelinePlanner.plan()
â”‚   â”‚
â”‚   â”œâ”€â”€ task.py             # ä»»åŠ¡å®šä¹‰
â”‚   â”‚   â””â”€â”€ main: Task dataclass
â”‚   â”‚
â”‚   â”œâ”€â”€ context.py          # æ‰§è¡Œä¸Šä¸‹æ–‡
â”‚   â”‚   â””â”€â”€ main: ExecutionContext dataclass
â”‚   â”‚
â”‚   â”œâ”€â”€ evaluator.py        # è¯„ä¼°å¼•æ“
â”‚   â”‚   â”œâ”€â”€ imports: llm_client
â”‚   â”‚   â””â”€â”€ main: LlmEvaluationEngine.evaluate()
â”‚   â”‚
â”‚   â””â”€â”€ vector_memory.py    # å‘é‡è®°å¿†
â”‚       â”œâ”€â”€ imports: embedding (optional)
â”‚       â””â”€â”€ main: VectorMemoryManager
â”‚
â”œâ”€â”€ modes/
â”‚   â”œâ”€â”€ base.py             # æ¨¡å¼åŸºç±»
â”‚   â””â”€â”€ novel.py            # å°è¯´æ¨¡å¼
â”‚       â”œâ”€â”€ imports: prompts.manager
â”‚       â””â”€â”€ main: NovelMode.build_prompt()
â”‚
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ manager.py          # æç¤ºè¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ loads: universal/, styles/
â”‚   â”‚   â””â”€â”€ main: PromptManager, get_prompt_with_style()
â”‚   â”‚
â”‚   â”œâ”€â”€ universal/          # é€šç”¨æ¨¡æ¿
â”‚   â””â”€â”€ styles/             # é£æ ¼è¦†ç›–
â”‚
â””â”€â”€ server.py               # API æœåŠ¡
    â”œâ”€â”€ imports: loop_engine, all core modules
    â””â”€â”€ main: FastAPI endpoints
```

---

## åã€æ€»ç»“

### 10.1 ä¿ç•™çš„ AutoGPT æ ¸å¿ƒç†å¿µ

| ç†å¿µ | å®ç°æ–¹å¼ |
|------|---------|
| **Agent å¾ªç¯** | LoopEngine çš„ run() æ–¹æ³• |
| **æ€è€ƒ-è§„åˆ’-æ‰§è¡Œ** | TaskPlanner â†’ build_prompt â†’ LLM â†’ Evaluate |
| **è®°å¿†ç³»ç»Ÿ** | VectorMemoryManager (çŸ­æœŸ + é•¿æœŸ + è¯­ä¹‰æ£€ç´¢) |
| **å·¥å…·/èƒ½åŠ›** | Mode + PromptManager (æç¤ºè¯å³å·¥å…·) |
| **è‡ªä¸»å†³ç­–** | è¯„ä¼° + é‡å†™æœºåˆ¶ |

### 10.2 å†™ä½œåœºæ™¯çš„ç‹¬ç‰¹ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹ | åŸå›  |
|-------|------|
| **é™æ€æµæ°´çº¿** | åˆ›ä½œæœ‰å›ºå®šæµç¨‹ï¼Œå¯é¢„æµ‹æ€§æ›´é‡è¦ |
| **å¤šç»´åº¦è¯„ä¼°** | æ–‡å­¦è´¨é‡éœ€è¦å¤šè§’åº¦è¡¡é‡ |
| **é£æ ¼æ³¨å…¥** | ä¸åŒç±»å‹å°è¯´éœ€è¦ä¸åŒé£æ ¼ |
| **ç»“æ„åŒ–è®°å¿†** | äººç‰©ã€æƒ…èŠ‚ã€ä¼ç¬”éœ€è¦ç²¾ç¡®æ£€ç´¢ |
| **é›ªèŠ±å†™ä½œæ³•** | ä¸“ä¸šå†™ä½œæ–¹æ³•è®ºçš„èå…¥ |

### 10.3 ä¸­é•¿ç¯‡å°è¯´æ”¯æŒèƒ½åŠ›

| èƒ½åŠ› | æ–¹æ¡ˆ | æ”¯æŒè§„æ¨¡ |
|-----|------|---------|
| **æŒä¹…åŒ–å­˜å‚¨** | SQLite/PostgreSQL + Chroma/Qdrant | æ— é™ç« èŠ‚ |
| **æ™ºèƒ½ä¸Šä¸‹æ–‡** | åˆ†å±‚è®°å¿† + è¯­ä¹‰æ£€ç´¢ + è‡ªåŠ¨æ‘˜è¦ | 200K tokensä¼˜åŒ–åˆ©ç”¨ |
| **ä¸€è‡´æ€§ä¿éšœ** | ç»“æ„åŒ–æ•°æ® + è‡ªåŠ¨æ ¡éªŒ | å®æ—¶å†²çªæ£€æµ‹ |
| **æ–­ç‚¹ç»­å†™** | æ£€æŸ¥ç‚¹ç³»ç»Ÿ | éšæ—¶æ¢å¤ |
| **ç‰ˆæœ¬ç®¡ç†** | ç« èŠ‚å†å² | å¯å›æ»šä»»æ„ç‰ˆæœ¬ |

### 10.4 ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

1. **ä¼˜å…ˆçº§ P0**ï¼šå®ç°æŒä¹…åŒ–å­˜å‚¨å±‚ï¼ˆSQLite + Chromaï¼‰
2. **ä¼˜å…ˆçº§ P1**ï¼šå®ç°æ™ºèƒ½ä¸Šä¸‹æ–‡çª—å£ç®¡ç†
3. **ä¼˜å…ˆçº§ P2**ï¼šå®ç°æ’ä»¶ç³»ç»Ÿæ¡†æ¶
4. **ä¼˜å…ˆçº§ P3**ï¼šå®ç°æ ¸å¿ƒæ’ä»¶ï¼ˆäººç‰©ã€ä¸–ç•Œè§‚ã€äº‹ä»¶ï¼‰
5. **ä¼˜å…ˆçº§ P4**ï¼šè€ƒè™‘å¯è§†åŒ–å·¥ä½œæµç¼–è¾‘å™¨

---

## é™„å½• Aï¼šAutoGPT æ ¸å¿ƒä»£ç å‚è€ƒ

### A.1 Agent ä¸»å¾ªç¯ (original_autogpt/app/main.py)

```python
async def run_interaction_loop(agent: "Agent") -> None:
    """Run the main interaction loop for the agent."""
    
    while cycles_remaining > 0:
        # Plan: å†³å®šä¸‹ä¸€æ­¥åŠ¨ä½œ
        action_proposal = await agent.propose_action()
        
        # Execute: æ‰§è¡ŒåŠ¨ä½œ
        if not feedback:
            result = await agent.execute(action_proposal)
        else:
            result = await agent.do_not_execute(action_proposal, feedback)
        
        # Evaluate: è¯„ä¼°ç»“æœ
        if result.status == "success":
            consecutive_failures = 0
        else:
            consecutive_failures += 1
```

### A.2 BaseAgent (forge/agent/base.py)

```python
class BaseAgent(Generic[AnyProposal], metaclass=AgentMeta):
    
    @abstractmethod
    async def propose_action(self) -> AnyProposal:
        """æå‡ºä¸‹ä¸€æ­¥åŠ¨ä½œ"""
        ...
    
    @abstractmethod
    async def execute(self, proposal: AnyProposal, user_feedback: str = "") -> ActionResult:
        """æ‰§è¡ŒåŠ¨ä½œ"""
        ...
    
    async def run_pipeline(self, protocol_method, *args, retry_limit: int = 3):
        """è¿è¡Œç»„ä»¶ç®¡é“"""
        for component in self.components:
            result = await method(*args)
            ...
```

---

*æ–‡æ¡£ç‰ˆæœ¬: 2.0*
*æœ€åæ›´æ–°: 2026-01-23*
*ä½œè€…: Creative AutoGPT Team*
